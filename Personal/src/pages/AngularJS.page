<!-- 
Author - Mohit Shrivastav
Co-Author - Harshit Pandey (Revised Code)
 
// ======== Angular JS with Visualforce  ====
This page list down the fields of Account and list the fields by Querying Salesforce
User can search sort and paginate the data presentation pretty quickly and fancy way 
using Angular.JS
 
-->
<apex:page standardStylesheets="false" sidebar="false" showHeader="false" controller="AngularJSDemoController">
    <html xmlns:ng="http://angularjs.org" ng-app="hello" lang="en">
        <head>
            <meta charset="utf-8"/>
            <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.no-icons.min.css" rel="stylesheet"/>
            <link href="https://netdna.bootstrapcdn.com/font-awesome/2.0/css/font-awesome.css" rel="stylesheet"/>
            <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.js"/>
            <apex:includeScript value="{!URLFOR($Resource.jQuery, 'js/jquery-1.10.2.min.js')}" />
            <apex:includeScript value="{!URLFOR($Resource.jQuery, 'js/jquery-ui-1.10.4.custom.min.js')}" />
            <apex:includeScript value="{!URLFOR($Resource.jQuery, 'js/jquery-1.7.2.min.js')}" />
        <apex:includeScript value="{!URLFOR($Resource.jQuery, 'js/jquery-ui-1.8.20.custom.min.js')}" />
        <script src="/soap/ajax/33.0/connection.js" type="text/javascript"></script>
        <script src="/soap/ajax/33.0/apex.js" type="text/javascript"></script>
        <script type="text/javascript">  
        
        var fieldsValuesMap;
        var fieldsfetched;
        var sobjectMap;
        fieldsValuesMap = new Array();
        fieldsfetched = new Array();
        var j$ = jQuery.noConflict();
        j$(document).ready(function(){
            AngularJSDemoController.getSobjectField('Account',function(result,event){
                if(event.status)
                {
                    sobjectMap = result;
                    j$('input').each(function(){
                        if(j$(this).attr('class')=='AngularJS')
                        {
                            var fieldtype =getType(j$(this).attr('type').toLowerCase());
                            if(fieldtype.indexOf('reference@')==0)
                            {
                                fieldtype = fieldtype.replace('reference@','');
                                if(!fieldsfetched[fieldtype])
                                {
                                    getSobjectList(fieldtype,'');
                                    fieldsfetched[fieldtype] = true;
                                }
                            }
                            else if(fieldtype == 'DATETIME')
                            {
                                j$(this).prop('type','datetime-local');
                            }
                            j$(this).addClass(fieldtype);
                            if(fieldsfetched[fieldtype])
                            {
                                j$(this).after(setOptions(fieldtype,''));
                            }
                        } 
                    });
                }
            });
            j$('input[type="TEXTAREA"]').each(function(){
                j$(this).after("<textarea />");
                j$(this).remove();
            });
        });
        
        j$(document).on('click','.AngularJS',function(){
            j$(this).next('.options').show();
        });

        j$(document).on('keydown','.AngularJS',function(){
            var classValue = j$(this).attr('class');
            classValue = classValue.replace('AngularJS ','');
            j$(this).next('div').remove();
            j$(this).after(setOptions(classValue,j$(this).val()));
            j$(this).next('.options').show();
        });
        j$('body').on('click','.option',function(){
            j$(this).parents('.options').prev('input').val(j$(this).html());
            j$(this).prev('input').val(j$(this).attr('id'));
            j$('.options').hide();
        });
        
        function getType(field)
        {
            var type;
            var endIndex,startIndex;
            if(sobjectMap.indexOf(field)>0)
            {
                startIndex = sobjectMap.indexOf(field);
                startIndex = sobjectMap.indexOf(' : ',startIndex);
                endIndex = sobjectMap.indexOf(' ',startIndex+3);
            }
            type = sobjectMap.substring(startIndex+3,endIndex);
            return type;
        }
        function getSobjectList(sobject, criteria)
        {
            sforce.connection.sessionId = '{!$Api.Session_ID}';
            var results = sforce.connection.query('select id, name from '+sobject+' limit 30000');
            var records = results.get('records');
            fieldsValuesMap[sobject] = records;
            setOptions(sobject,criteria);
        }
        function setOptions(sobject,criteria)
        {
            records = fieldsValuesMap[sobject];
            var selectedOptions = new Array();
            if(criteria!='')
            {
                for(var i=0;i<records.length;i++)
                {
                    if(records[i]['Name'].indexOf(criteria)>=0)
                    {
                        selectedOptions.push(records[i]);
                    }
                }
            }
            else
            {
                selectedOptions = fieldsValuesMap[sobject];
            }
            var options = '<div  class="options" style="display:none;"><input type="hidden" class="Id" value=""/>';
            for(var i=0;i<5 && i<selectedOptions.length;i++)
            {
                options = options+'<a class="option"  style="text-decoration:none;" id='+ selectedOptions[i]['Id']+'>'+selectedOptions[i]['Name']+'</a><br/>';
            }
            options = options+'</div>';
            return options;
        }
        </script>
            <style>
                .input-mysize { width: 550px }
                .search-query {
                padding-left: 469px;
                background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJ5JREFUeNpi+P//PwMQMANxERCfAeI/UBrEZwbJQ9WAFR0A4u1AbAnEbFB6O1ScGaawGoi3wHQiYyBYDZKHKbwHxLo4FOqC5GEKf4Ksw6EQ5IyfIDYTkPEUiNUZsAOQ+F9GRkYJEKcFiDficSOIcRjE4QTiY0C8DuRbqAJLKP8/FP9kQArHUiA+jySJjA8w4LAS5KZd0MAHhaccQIABALsMiBZy4YLtAAAAAElFTkSuQmCC);
                background-repeat: no-repeat;
                background-position: 562px 8px;
                }
                
                
            </style>
        </head>
        <!--- Javascript -->
        <script type="text/javascript">
        var j$ = jQuery.noConflict();
        j$(document).ready(function(){
            j$('[id$="value"]').hide();
        });
        j$('body').on('click','.Id',function(){
            j$('[id$="value"]').show();
        
        });
        <!-- Name your application -->
            var myapp = angular.module('hello', []);
        var sortingOrder = 'Name';
        <!-- Define Controller  -->
            var contrl=myapp.controller('ctrlRead', function ($scope, $filter) {
                <!--- Initialize Scope Variables --->
                    $scope.sortingOrder = sortingOrder;
                $scope.reverse = false;
                $scope.filteredItems = [];
                $scope.groupedItems = [];
                $scope.itemsPerPage = 15;
                $scope.pagedItems = [];
                $scope.currentPage = 0;
                $scope.items ={!lstAccount};
                
                var searchMatch = function (haystack, needle) {
                    if (!needle) {
                        return true;
                    }
                    return haystack.toLowerCase().indexOf(needle.toLowerCase()) !== -1;
                };
                
                //Initialize the Search Filters 
                $scope.search = function () {
                    $scope.filteredItems = $filter('filter')($scope.items, function (item) {
                        for (var attr in item) {
                            if (searchMatch(item[attr], $scope.query))
                                return true;
                        }
                        return false;
                    });
                    // Define Sorting Order
                    if ($scope.sortingOrder !== '') {
                        $scope.filteredItems = $filter('orderBy')($scope.filteredItems, $scope.sortingOrder, $scope.reverse);
                    }
                    $scope.currentPage = 0;
                    
                    // Group by pages
                    $scope.groupToPages();
                };
                
                // Calculate Total Number of Pages based on Records Queried 
                $scope.groupToPages = function () {
                    $scope.pagedItems = [];
                    for (var i = 0; i < $scope.filteredItems.length; i++) {
                        if (i % $scope.itemsPerPage === 0) {
                            $scope.pagedItems[Math.floor(i / $scope.itemsPerPage)] = [$scope.filteredItems[i]];
                        } else {
                            $scope.pagedItems[Math.floor(i / $scope.itemsPerPage)].push($scope.filteredItems[i]);
                        }
                    }
                };
                
                $scope.range = function (start, end) {
                    var ret = [];
                    if (!end) {
                        end = start;
                        start = 0;
                    }
                    for (var i = start; i < end; i++) {
                        ret.push(i);
                    }
                    return ret;
                };
                
                $scope.prevPage = function () {
                    if ($scope.currentPage > 0) {
                        $scope.currentPage--;
                    }
                };
                
                $scope.nextPage = function () {
                    if ($scope.currentPage < $scope.pagedItems.length - 1) {
                        $scope.currentPage++;
                    }
                };
                $scope.setPage = function () {
                    $scope.currentPage = this.n;
                };
                // functions have been describe process the data for display
                $scope.search();
                
                // change sorting order
                $scope.sort_by = function (newSortingOrder) {
                    if ($scope.sortingOrder == newSortingOrder)
                        $scope.reverse = !$scope.reverse;
                    $scope.sortingOrder = newSortingOrder;
                    
                    // icon setup
                    $('th i').each(function () {
                        // icon reset
                        $(this).removeClass().addClass('icon-sort');
                    });
                    if ($scope.reverse)
                        $('th.' + new_sorting_order + ' i').removeClass().addClass('icon-chevron-up');
                    else
                        $('th.' + new_sorting_order + ' i').removeClass().addClass('icon-chevron-down');
                };
                
            });
        
        contrl.$inject = ['$scope', '$filter'];
        </script>
        <body>     
            <!-- =========== Binding Controller to Body of Page ============= -->
            <div ng-controller="ctrlRead">
                
                
                
                <div class="input-append" style="width:800px; margin:0 auto;">
                    <input type="text" ng-model="query" ng-change="search()" class="input-mysize  search-query" placeholder="Search"/>
                </div>
               
 
                <table class="table  table-hover">
                    <thead>
                        <tr>
                            <th class="Name" id="Name">Name&nbsp;<a ng-click="sort_by('Name')"><i class="icon-sort"></i></a></th>
                            <th class="Phone">Phone&nbsp;<a ng-click="sort_by('Phone')"><i class="icon-sort"></i></a></th>
                            
                        </tr>
                    </thead>
                    <tfoot>
                        <td colspan="6">
                            <div class="pagination pagination-large pull-left">
                                <ul>
                                    <li ng-class="{disabled: currentPage == 0}">
                                        <a ng-click="prevPage()">� Prev</a>
                                    </li>
                                    <li ng-repeat="n in range(pagedItems.length)"
                                    ng-class="{active: n == currentPage}"
                                    ng-click="setPage()">
                                        <a ng-bind="n + 1">1</a>
                                    </li>
                                    <li ng-class="{disabled: currentPage == pagedItems.length - 1}">
                                        <a ng-click="nextPage()">Next �</a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tfoot>
                    <tbody>
                        <tr ng-repeat="item in pagedItems[currentPage] | orderBy:sortingOrder:reverse">
                            <td ><input type="{!$ObjectType['Account'].fields['ParentId'].Name}" ng-model="item.Name" class='AngularJS'/></td>
                            <td>{{item['Phone']}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </body>
    </html>
</apex:page>