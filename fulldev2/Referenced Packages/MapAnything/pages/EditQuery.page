<apex:page sidebar="false" showHeader="false" controller="sma.EditQuery" action="{!init}">

    <script type='text/javascript'>
    	var scriptsToLoad = [
    		"<script type='text/javascript' src='{!URLFOR($Resource.MapAnything, 'js/jquery-1.7.1.min.js')}'></script"+">",
    		"<script type='text/javascript' src='{!URLFOR($Resource.MapAnything, 'jquery/jquery-ui.min.js')}'></script"+">",
    		"<link rel='stylesheet' type='text/css' href='{!URLFOR($Resource.MapAnything, 'jquery/jquery-ui.css')}'></link"+">",
    		"<script type='text/javascript' src='{!URLFOR($Resource.QueryEditor, 'js/date.js')}'></script"+">",
    		"<script src='{!URLFOR($Resource.QueryEditor, 'js/combobox/jquery.combobox.js')}' type='text/javascript'></script"+">",
    		"<link rel='stylesheet' type='text/css' href='{!URLFOR($Resource.QueryEditor, 'js/combobox/jquery.combobox.css')}'></link"+">",
    		"<script src='{!URLFOR($Resource.QueryEditor, 'js/multiselect/jquery.multiselect.min.js')}' type='text/javascript'></script"+">",
    		"<script type='text/javascript' src='{!URLFOR($Resource.MapAnything, 'niceScroll/jquery.slimscroll.js')}'></script"+">",
    		"<script src='{!URLFOR($Resource.QueryEditor, 'js/multiselect/jquery.multiselect.filter.js')}' type='text/javascript'></script"+">",
    		"<link rel='stylesheet' type='text/css' href='{!URLFOR($Resource.QueryEditor, 'js/multiselect/jquery.multiselect.css')}'></link"+">",
    		"<link rel='stylesheet' type='text/css' href='{!URLFOR($Resource.QueryEditor, 'js/multiselect/jquery.multiselect.filter.css')}'></link"+">"
    	];
        if (typeof $ == 'undefined')
        {
        	for (var i in scriptsToLoad) {
                if (scriptsToLoad.hasOwnProperty(i)) {
                    document.write(scriptsToLoad[i]);
                }
        	}
        }
    </script>
    
    <!-- jQuery Query (used for interacting with query string) -->
    <script src="{!URLFOR($Resource.QueryEditor, 'js/jquery.query.js')}" type="text/javascript"></script>
    
    <!--  jQuery masked input formatting -->
    <script src="{!URLFOR($Resource.MapAnything, 'jquery/jquery.maskedinput.js')}" type="text/javascript"></script>
    <script src="{!URLFOR($Resource.MapAnything, 'jquery/jquery.formatCurrency-1.4.0.js')}" type="text/javascript"></script>
    
    <!-- JS Color -->
    <apex:includeScript value="{!URLFOR($Resource.sma__MapAnything, 'jscolor/jscolor.js')}"/>

    <!-- jQuery MiniColors (https://github.com/claviska/jquery-miniColors/) -->
    <script src="{!URLFOR($Resource.MapAnything, 'jquery/minicolors/jquery.minicolors.min.js')}" type="text/javascript"></script>
    <link rel='stylesheet' type='text/css' href="{!URLFOR($Resource.MapAnything, 'jquery/minicolors/jquery.minicolors.css')}"></link>

    <!-- CSS -->
    <style type='text/css' class='editquery-css'>
        html, body {
            width: 100%;
            height: 100%;
        }
        .modal-layer {
            display: none;
            position: absolute;
            z-index: 1;
            width: 100%;
            height: 100%;
            background-color: #000000;
            opacity: 0.5;
            -ms-filter: progid:DXImageTransform.Microsoft.Alpha(Opacity = 50);
            filter: alpha(opacity = 50);
        }
    
        /* Basics */
        #savedqueryeditor-error {
            padding: 15px;
            width: 875px;
            overflow: hidden;
        
            {! IF(pageState != 'error', 'display: none;', '') }
        }
        #savedqueryeditor-error h3 {
            display: block;
            margin: 10px 0;
            color: #757575;
        }
        #savedqueryeditor { 
            padding: 15px;
            width: 875px;
            height: 600px;
            overflow: hidden;
            
            {! IF(pageState != 'edit', 'display: none;', '') }
        }
        #savedqueryeditor div {
            padding: 0;
            margin: 0;
        }
        #savedqueryeditor-templates {
            display: none;
        }
        span.link
        {
            color: blue;
            cursor: pointer;
        }
        span.link.small
        {
            font-size: 10px;
            font-weight: bold;
        }
        .dateliteralpicker
        {
            cursor: pointer;
        }
        .value input.invalid
        {
            background: transparent url({!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}) no-repeat right center;
        }
        .ui-autocomplete
        {
            z-index: 9999999999 !important;
            max-height: 200px !important;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .PICKLIST > ul, .filterbyowner ul
        {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .PICKLIST li, .filterbyowner li
        {
            padding: 0;
            margin: 0;
        }
        #savedqueryeditor tr > td.actions > div, #savedqueryeditor tr > td.crossfilteractions > div, #savedqueryeditor tr > td.activitysubfilteractions > div
        {
            display: none;
        }
        #savedqueryeditor tr:hover > td.actions > div, #savedqueryeditor tr:hover > td.crossfilteractions > div, #savedqueryeditor tr:hover > td.activitysubfilteractions > div
        {
            display: block;
        }
        #savedqueryeditor .activityfilter-type-wrapper
        {
            padding: 10px;
            margin: 5px 0;
            -moz-border-radius: 4px;
            -webkit-border-radius: 4px;
            border-radius: 4px;
            -moz-box-shadow: inset 0px 0px 8px #757575;
            -webkit-box-shadow: inset 0px 0px 8px #757575;
            box-shadow: inset 0px 0px 8px #757575;
        }
        
        /* Tabs */
        #savedqueryeditor .tabs
        {
            background: none;
            border: none;
        }
        #savedqueryeditor .tabs > ul
        {
            width: auto;
            padding: 0 8px;
            background: none;
            border: none;
            border-bottom: 1px solid #CCC;
            border-top-right-radius: 0;
            border-top-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 0;
        }
        #savedqueryeditor .tabs > ul .ui-state-default
        {
            background: #3684c5;
            border: medium none;
            border-radius: 0 0 0 0;
            border: 1px solid #19508C;
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.3) inset, 0 0 4px rgba(255, 255, 255, 0.2) inset;
            margin: 0 0 0 0;
            
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#197BBB', endColorstr = '#0059A0');
            -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr = '#197BBB', endColorstr = '#0059A0')";
        }
        #savedqueryeditor .tabs > ul li.ui-tabs-active
        {
            border: 1px solid #CCC;
            background: white;
            
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#FFFFFF', endColorstr = '#FFFFFF');
            -ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr = '#FFFFFF', endColorstr = '#FFFFFF')";
        }
        #savedqueryeditor .tabs > ul li a
        {
            color: #ffffff;
            font-size: 12px;
        }
        #savedqueryeditor .tabs > ul li.ui-tabs-active a
        {
            color: #3684c5;
        }
        #savedqueryeditor .tabs > .ui-tabs-panel
        {
            padding: 15px;
            margin-bottom: 10px;
            height: 390px;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        /* Boxes */
        #savedqueryeditor .box.gray {
            border: 1px solid #C7C7C7;
            padding:5px;
            margin:5px 0 10px 0;
            background:#efefef;
        }
        
        /* Sections */
        #savedqueryeditor .section {
            position: relative;
        }
        #savedqueryeditor .section .section-header {
            color: #2265BB;
        }
        #savedqueryeditor .section .section-buttons {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        #savedqueryeditor .section .section-buttons .section-button {
            padding-left: 18px;
            height: 16px;
            line-height: 18px;
            font-size: 10px;
            cursor: pointer;
        }
        #savedqueryeditor .section .section-buttons .section-button.add {
            background: transparent url("{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}") left center no-repeat;
        }
        
        /* Hide filter by owner section if this object is not ownable */
        #savedqueryeditor .filterbyowner
        {
            display: {! IF(isOwnable, 'block', 'none') };
        }
        
        /* Forms */
        #savedqueryeditor table.form td:first-child {
            font-weight: bold;
            padding-right: 15px;
        }
        
        /* Buttons */
        #savedqueryeditor .buttons {
            padding: 0 10px;
        }
        #savedqueryeditor .buttons .btn {
            width: 50px;
        }
        
        #savedqueryeditor .modal-footer .buttons {
            min-width: 241px;
        }

        .modal-footer {
            width:100%;
            box-sizing:border-box;
        }
        /* System Info */
        #savedqueryeditor .systeminfo {
        	color: #757575; font-size: 10px;
        }
        
        /* Comboboxes */
        #savedqueryeditor .ui-combobox
        {
            padding-right: 0;
        }
        #savedqueryeditor .ui-combobox input
        {
            background-color: white;
            padding-right: 30px;
            font-weight: bold;
        }
        #savedqueryeditor .ui-combobox a
        {
            background: transparent;
            border: none;
            position: absolute;
            right: 0;
        }
        #savedqueryeditor .ui-combobox a .ui-button-icon-primary
        {
            background: transparent url("{!URLFOR($Resource.QueryEditor, 'images/icons/combobox-arrow-16.png')}") no-repeat center;
        }
        
        .crossobjectoptions input.ui-autocomplete-input, .htab-content.limits input.ui-autocomplete-input {
            width: 300px;
        }
        .operator input.ui-autocomplete-input {
            width: 140px;
        }
        .crossfilter .subfilters .filter .fieldlabel input.ui-autocomplete-input {
            width: 150px;
        }
        
        /* Date pickers */
        #savedqueryeditor .ui-datepicker {
            z-index: 9999999999 !important;
        }
        
        /* Marker Type Pickers */
        .markertype-wrapper { 
            position: relative;
        }
        .markertype-wrapper .markertype-color, .markertype-wrapper .markertype-shape, .markertype-wrapper .ui-combobox input {
            width: 200px;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }
        .markertype-wrapper .markertype-selector {
            display: inline-block;
            vertical-align: top;
            margin-top: 3px !important; padding-top: 5px !important;
        }
        .referencevalue.row .add-row-icon {
        	display: inline-block;
            vertical-align: middle;
        	cursor: pointer;
        }
        .markertype-wrapper .markertype-selector img {
            cursor: pointer;
        }
        
        #savedqueryeditor .filterbyowner-ownerfield-wrapper .ui-autocomplete-input {
        	width: 200px;
        }
        
        /* Marker Grids */
		#savedqueryeditor .markergrid-row .add-row-icon, #savedqueryeditor .markergrid-row .remove-row {
			cursor: pointer;
			display:none;
		}
		#savedqueryeditor .markergrid-row:hover .add-row-icon, #savedqueryeditor .markergrid-row:hover .remove-row {
			display: inline-block;
		}
		#savedqueryeditor .markergrid-row.other .add-row-icon, #savedqueryeditor .markergrid-row.other .remove-row {
			display: none;
		}
        .markergrid-row td {
            height: 30px;
        }
        .markertype-color-preview {
            display: inline-block;
            cursor: pointer;
            border-right: 1px solid black;
            padding-right: 5px !important; margin-top: 3px !important;
            height: 30px;
        }
        .markertype-color-preview svg {
            margin-top: 5px !important;
        }
        .markertype-color-preview.massaction {
        	margin-top: 0 !important;
        	border: none;
        }
        .markertype-color-preview.massaction svg {
        	margin-top: 0 !important;
        	position: relative; top: 3px; left: 2px;
        }
        .markerpicker h4 {
            display: block; padding: 5px 0;
            color: #2265BB;
        }
        .markerpicker .markerpicker-color {
            height: 0;
            border: none;
            padding: 0; margin: 0;
        }
        .markerpicker .markerpicker-shapes {
            position: absolute; bottom: 5px; left: 0px;
            width: 100%;
            text-align: center;
        }
        .markerpicker .markerpicker-shapes svg {
            margin: 0 10px;
            cursor: pointer;
        }
		
		/* Related Lists */
		#relatedlist-addnew-wrapper {
			text-align: right;
			padding: 5px 0 !important;
		}
		#relatedlist-addnew-wrapper .ui-autocomplete-input {
			width: 350px;
			box-sizing: border-box;
		}
		#relatedlist-watermark {
			height: 150px;
			line-height: 150px;
			font-weight: bold;
			font-size: 24px;
			color: #C0C0C0;
			background: rgba(0, 0, 0, 0.04);
			padding: 0 25px !important;
			box-shadow: inset 0px 0px 8px #000;
			box-sizing: border-box;
			font-style: italic;
		}
		.relatedlist-row + #relatedlist-watermark {
			display: none;
		}
		.relatedlist-row {
			position: relative;
			background: rgba(0, 0, 0, 0.04);
			margin: 5px 0 !important; padding: 15px 15px 15px 35px !important;
			box-shadow: inset 0px 0px 8px #000;
			box-sizing: border-box;
		}
		.relatedlist-row .ui-combobox .ui-autocomplete-input {
			font-size: 10px;
		}
		.relatedlist-label {
			border-bottom: 1px solid silver;
		}
		.relatedlist-label.watermark {
			font-style: italic;
			color: #B2B2B2;
		}
		.relatedlist-columns, .relatedlist-filters {
			margin: 10px 0 !important;
		}
		.relatedlist-addcolumn, .relatedlist-addfilter {
			color: blue;
			cursor: pointer;
			font-size: 10px;
			margin-top: 5px !important;
		}
		.relatedlist-addcolumn {
			display: inline-block;
			margin-left: 5px !important;
		}
		.relatedlist-columns .ui-autocomplete-input {
			width: 120px;
		}
		.relatedlist-numtodisplay-wrapper {
			margin-top: 20px !important;
			margin-bottom: 5px !important;
		}
		.relatedlist-draghandle {
			position: absolute; left: 10px; top: 50%; margin-top: -17px !important;
		}
		.relatedlist-draghandle .arrow-up {
			border-left-width: 7px;
			border-right-width: 7px;
			border-bottom-width: 16px;
		}
		.relatedlist-draghandle .arrow-down {
			border-left-width: 7px;
			border-right-width: 7px;
			border-top-width: 16px;
		}
		.relatedlist-draghandle .arrow-up:hover, .relatedlist-draghandle .arrow-down:hover {
			border-bottom-color: #009AFF;
			border-top-color: #009AFF;
			cursor: pointer;
		}
		.relatedlist-remove {
			position: absolute; top: 10px; right: 14px;
			width:18px; height:18px;
			cursor: pointer;
		}
		.relatedlist-remove > div {
			position: absolute; top: 0; left: 7px;
			width:3px; height:18px;
			background-color: #797979;
		}
		.relatedlist-remove:hover > div {
			background-color: #3F3F3F;
		}
		.relatedlist-remove > div:first-child {
			transform: rotate(45deg);
			-ms-transform: rotate(45deg); /* IE 9 */
			-webkit-transform: rotate(45deg); /* Safari and Chrome */
		}
		.relatedlist-remove > div:last-child {
			transform: rotate(135deg);
			-ms-transform: rotate(135deg); /* IE 9 */
			-webkit-transform: rotate(135deg); /* Safari and Chrome */
		}
		.relatedlist-filters .filter > table {
			border-spacing: 0;
		}
		.relatedlist-filters .filter .indexlabel {
			display: none;
		}

        .orderby-dir {
            vertical-align: top; cursor: pointer;
            -webkit-transition: .5s ease-in-out; -moz-transition: .5s ease-in-out; -o-transition: .5s ease-in-out; transition: .5s ease-in-out;
        }
        .orderby-dir.desc {
            -webkit-transform: rotate(180deg); -moz-transform: rotate(180deg); -o-transform: rotate(180deg); -ms-transform: rotate(180deg); transform: rotate(180deg);
        }



		/*-------------------Derek edits--------------------*/
		
.placeholder-preview {
    height: 385px;
  width: 100%;
  border: 1px solid #ccc;
  background: #eeeeef;
  padding: 0;
  margin: 0;
}
		
.heatmap-options-format td {
  vertical-align: top;
  font-size: 13px;
  font-weight: normal;
  color: #666667;
}
		
table.heatmap-options-format {
  width: 100%;
  width: 846px;
}

table.heatmap-options-format .heatmap-options-col {
  width: 255px;
}

.hmo-input-col {
    width:200px;
}

#savedqueryeditor .heatmap-arrange-wrapper {
  border: 1px solid #ccccce;
  height: 386px;
  width: 245px;
  border-radius: 4px;
}

#savedqueryeditor .heatmap-arrange-cell-rows {
  padding: 10px;
  height: 262px;
  width:225px;
  overflow-y: auto;
  background: #f3f3f5;
}

#savedqueryeditor .heatmap-arrange-wrapper-header {
    padding: 6px 10px;
    border-bottom:1px solid #ccccce;
}

#savedqueryeditor .heatmap-arrange-wrapper-footer {
    padding:6px 10px;
    border-top:1px solid #ccccce;
}

.heatmap-arrange-cell-rows .boundary-style {
  border: 1px solid rgba(0, 0, 0, 0.2);
    cursor: pointer;
    font-family: "Helvetica Neue",Arial,sans-serif;
    font-size: 13px;
    width: 100%;
    border-radius: 4px;
    height: 25px;
    text-align: center;
    outline: none;
      max-width: 100px;
}

#savedqueryeditor .heatmap-arrange-add-cell {
  padding: 10px 10px 10px;
  overflow: auto;
  border-bottom: 1px solid #dddddf;
  background: #f3f3f5;
}

.heatmap-arrange-add-cell a {
  border: 1px solid #ccccce;
  background: #fff;
  padding: 6px 10px 4px;
  border-radius: 4px;
  float: left;
  display: inline-block;
  text-decoration: none;
  vertical-align: middle;
  color: #444446;
}

.heatmap-arrange-add-cell a:hover {
    text-decoration:none;
    background:#dddddf;
    color:#222224;
}

.heatmap-arrange-add {
  float: left;
  margin-top: -2px;
  margin: -2px 5px 0 -2px;
}

.heatmap-arrange-delete {
    cursor:pointer;
}

.heatmap-arrange-delete img {
  margin-top: 5px;
  margin-left: 2px;
}

td.hmo-input-cell {
  max-width: 180px;
}

td.hmo-input-cell .ui-combobox {
  max-width: 120px;
}


.hmo-short-value input, .hmo-short-value select {
    width:60px;
}
.heatmap-options-format label.label {
  font-weight: bold;
  color: #222;
}

.heatmap-options-format td span.helptext {
  color: #99999b;
  font-size: 12px;
}

.hmo-arrow-down {
  width: 20px;
  height: 12px;
}

.hmo-arrow-down {
  width: 20px;
  height: 12px;
}

a.hmo-button {
  width: 20px;
  height: 12px;
  border: 1px solid transparent;
  display: block;
  float:left;
  clear:both;
  border-radius: 2px;
  opacity:0.5;
  cursor:pointer;
}

a.hmo-button:hover {
  border: 1px solid #ccc;
  background:#fff;
  opacity:1;
}

    </style>

    
    <!-- JS -->
    <script type='text/javascript'>
        var query = {};
        var baseObject = '{!query.baseObject}';
        var globalIndex = 0;        //this is used to generate unique names for elements like radio buttons.  hoping to replace this with a nice form plugin
        
        
        function AddColorRow(hexColor, int)
        {
            var UnixTimeInMilliseconds = (new Date).getTime() + int; //we use the 'int' var because in a loop getTime() might result in the same so value;
            var rgbArray = hexToRgbHeatMap(hexColor);
            var rgbStr = 'rgb(' + rgbArray.r +', '+ rgbArray.g +', '+ rgbArray.b +')';
            
            $('#heatmap-options-color-table').append('<tr><td><a onclick="MoveHeatMapOptionsColorRowUp(this)" class="hmo-button"><img class="hmo-arrow-up" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-up.png')}" width="9" height="5" /></a>' +
                '<a onclick="MoveHeatMapOptionsColorRowDown(this)" class="hmo-button"><img class="hmo-arrow-down" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-down.png')}" width="9" height="5" /></a></td>' +
                '<td><input id="heatmap-options-color-input-'+ UnixTimeInMilliseconds +'" class="color boundary-style" style="background-color: ' + rgbStr +'; color:  ' + rgbStr +';" type="text" autocomplete="off" value="' + hexColor + '" /></td>' + 
                '<td><a onclick="RemoveHeatMapOptionsColorRow(this)"><img class="heatmap-arrange-delete" src="{!URLFOR($Resource.MapAnything, 'images/hmo-delete.png')}" width="19" height="18" /></a></td></tr>'
            );
            
            new jscolor.color(document.getElementById('heatmap-options-color-input-' + UnixTimeInMilliseconds), {});
        }
        
        function MoveHeatMapOptionsColorRowUp(obj)
        {
            var row = $(obj).parents("tr:first");
            row.insertBefore(row.prev());
        }
        
        function MoveHeatMapOptionsColorRowDown(obj)
        {
            var row = $(obj).parents("tr:first");
            row.insertAfter(row.next());
        }
        
        function RemoveHeatMapOptionsColorRow(obj)
        {
            $(obj).parents("tr:first").remove();
        }
        
        function hexToRgbHeatMap(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        
        
        $(function () {
			//Display Filter tabs on click
			$('#tab-filters').on('click', '.filtericon', function () {
				if (!$(this).is('.active')) {
					$('.filtericon').removeClass('active');
            		$('.htab-content:visible').slideUp(400);
            		$(this).addClass('active');
            		$('.htab-content.'+$(this).attr('data-tab')).slideDown(400);
				}
			});
            
			//Manage Marker tabs on icon click
			$('.markertabs').on('click', '.markercolortab', function ()            
            {
            	$('.markericon').removeClass('active');
            	$(this).addClass('active');
            	$('#tab-markers .shapemarker').hide();
            	$('#tab-markers .symbolmarker').hide();
            	$('#tab-markers .colormarker').show();
            });
            
            $('.markertabs').on('click', '.markershapetab', function ()            
            {
            	$('.markericon').removeClass('active');
            	$(this).addClass('active');
            	$('#tab-markers .colormarker').hide();
            	$('#tab-markers .symbolmarker').hide();
            	$('#tab-markers .shapemarker').show();
            });
            
            $('.markertabs').on('click', '.markersymboltab', function ()            
            {
            	$('.markericon').removeClass('active');
            	$(this).addClass('active');
            	$('#tab-markers .shapemarker').hide();
            	$('#tab-markers .colormarker').hide();
            	$('#tab-markers .symbolmarker').show();
            });

            //Removes row on related list tab
			$('#savedqueryeditor').on('click', '.relatedlist-remove', function () 
            {
                $(this).closest('.relatedlist-row').remove()
            });

            //handle events
            $('#savedqueryeditor')

                //clicking marker color previews needs to display an editor
                .on('click', '.markertype-color-preview', function (e) {
                    var $preview = $(this);

                    //build editor bubble
                    var offset = $(this).offset();
                    var offsetTop = (offset.top + 25) + 'px';
                    var offsetLeft = offset.left + 'px';
                    var $bubble = $('#savedqueryeditor-templates .markerpicker').clone()
                        .addClass('bubble top')
                        .css({ position: 'absolute', top: offsetTop, left: offsetLeft, width: 185, height: 245, padding: '5px' })
                        .appendTo('body')
                        .on('click', function (e) { e.stopPropagation(); })
                    ;

                    //init color picker
                    var $shapeWrapper = $bubble.find('.markerpicker-shapes');
                    var $colorPicker = $bubble.find('.markerpicker-color');
                    $colorPicker.minicolors({
                        inline: true,
                        control: 'brightness',
                        change: function(hex, opacity) {
                            try {
                                $shapeWrapper.empty();
                                $.each(MA.Marker.shapes, function (shape, shapeMeta) {
                                    if ($.inArray('dynamic', shapeMeta.types) != -1) {
                                        $(MA.Marker.createSVG({ color: hex + ':' + shape })).attr('data-shape', shape).appendTo($shapeWrapper);
                                    }
                                });
                            } catch(e) {}
                        }
                    }).minicolors('value', '#00FF00');

                    //handle color picker selection
                    $shapeWrapper.on('click', 'svg', function () {
                        var color = $colorPicker.minicolors('value')+':'+$(this).attr('data-shape');
                        
                        //if this is a mass action, update all rows.  otherwise, just update this row
                        if ($preview.is('.massaction')) {
                        	$preview.closest('.markergrid').find('.markergrid-row .markertype-color-preview').attr('data-color', color).html(MA.Marker.createSVG({ color: color, forLegend: true }));
                        }
                        else {
                        	$preview.attr('data-color', color).html(MA.Marker.createSVG({ color: color, forLegend: true }));
                        }
                        
                        //remove the picker
                        $bubble.remove();
                    });

                    //stop propagation to avoid closing bubble
                    e.stopPropagation();
                })

            ; 
        
            //i don't think any of this is needed
            if ($.browser.msie) {
                if ('{!pageState}' == 'error') {
                    $('#savedqueryeditor-error').show();
                    $('#savedqueryeditor').hide();
                }
                else {
                    $('#savedqueryeditor-error').hide();
                    $('#savedqueryeditor').show();
                }
                
                if ('{!isOwnable}' == 'true') {
                    $('#savedqueryeditor .filtericon.filterbyownertab').show();
                } else {
                    $('#savedqueryeditor .filtericon.filterbyownertab').show();
                }
            }
        
            //get the query that we're creating/editing
            query = JSON.parse($('[id$="serializedQuery"]').val());
            $('#savedqueryeditor span.baseobject-name').text(query.baseObjectName);
            if (query.createdBy && query.createdDate) {
                var systemInfo = '***Created By ' +query.createdBy+ ' on ' +query.createdDate;
                if (query.modifiedBy && query.modifiedDate) {
                    systemInfo += ', Modified By ' +query.modifiedBy+ ' on ' +query.modifiedDate;
                }
            	$('#savedqueryeditor .systeminfo').text(systemInfo);
            }
            if ('{!queryIndex}' != '') {
            	$('.savebtn.plotbtn').addClass('refreshbtn').attr('value', 'Save & Refresh');
            }
        
            //initialize tabs
            $('#savedqueryeditor .tabs').tabs();
            
            //initialize color pickers
            jscolor.init();
            $('.colormarker .Static .markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
            
            //combobox settings
            $('#savedqueryeditor').on('focus', '.ui-autocomplete-input', function () { var $me = $(this); setTimeout(function () {$me.select();}, 100); });
            $('.filterbyactivity .combobox').combobox();
            $('.Static .markertype-select').combobox();
            
            //Populate sortable field options
        	$.ajax({
                url: MA.resources.QueryBuilderAPI+"{!pageSuffix}?securityToken={!securityToken}&action=getSortableFieldOptions&core.apexpages.devmode.url=0",
                type: 'POST',
                dataType: 'JSON',
                data: { baseObject: query.baseObject },
                success: function (response)
                {
                    if (response.success)
                    {
                    	//populate sortable filed options
                        var $sortableField = $('select.orderby-field');
                        $sortableField.append(
                		$('<option></option>').attr('value','--None--').text('--None--')
                		);
                        $.each(response.data.sortableFieldOptions || [], function (index, option) {
                            $('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($sortableField);
                        });
                        $sortableField.removeAttr('disabled');
                        $sortableField.combobox();
                        refreshBadges();
                    }

                    //Populate existing Marker Field Order Options
	                if (query.rowOrder != null) {
	                	$('#savedqueryeditor .advanced').find('.orderby-field').val(query.rowOrder).next().find('input').val($('#savedqueryeditor .advanced').find('.orderby-field option:selected').text());
	                	refreshBadges();
                        if(query.rowOrderDirection == 'desc') {
                            $('#savedqueryeditor .orderby-dir').addClass('desc');
                        }
	                }
                }
            });
            
            //get metadata for the selected query (or base object)
            $.ajax({
                url: MA.resources.QueryBuilderAPI+"{!pageSuffix}?securityToken={!securityToken}&action=getSavedQueryMetadata&core.apexpages.devmode.url=0",
                type: 'POST',
                dataType: 'JSON',
                data: { baseObject: baseObject },
                success: function (response)
                {
                    if (response.success)
                    {
                        //populate tooltip options
                        var $tooltips = $('select.tooltip');
                        var $HeatmapOptionsWeightedValue = $('#heatmap-options-weighted-value');
                        $.each(response.data.tooltipOptions || [], function (index, option) {
                            $('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($tooltips);
                            
                            if (option.fieldSOAPType == 'double' || option.fieldSOAPType == 'integer')
                            {
                                $('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($HeatmapOptionsWeightedValue);
                            }
                            
                        });
                        $tooltips.removeAttr('disabled').find('option:first-child').remove();
                        $($tooltips[0]).val('Name');
                        
                        //populate marker color field options
                        var $picklistField = $('select.color-picklistfield').data('needToUpdate', query.colorAssignmentType == 'Dynamic, Field');
                        $.each(response.data.picklistOptions || [], function (index, option) {
                            $('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($picklistField);
                        });
                        $picklistField.removeAttr('disabled').find('option:first-child').remove();
                        
                        //populate marker image options
                        var $markerImageFields = $('select.markertype-image');
                        $.each(response.data.markerImageOptions || [], function (index, option) {
                            $('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($markerImageFields);
                        });
                        $markerImageFields.removeAttr('disabled').find('option:first-child').remove();
                        $('.Static .markertype-image').combobox();
                        
                        //populate related list options
                        var $relatedListOptions = $('#relatedlist-addnew-object').html('<option value="--">--Add New--</option>');
                        $.each(response.data.crossObjectOptions || [], function (index, option) {
                        	$('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($relatedListOptions);
                        });
                        $relatedListOptions.removeAttr('disabled').combobox();
                        
                        //populate existing data for this query if we have it
                        if (query.id != null || query.isClone)
                        {
                            //tooltips
                            $('#savedqueryeditor .tooltip').each(function () {
                                $(this).val(query[$(this).attr('data-tooltip')]);
                            });
                            
                            //color assignment type
                            $('.color-assignmenttype').val(query.colorAssignmentType).change();
                            if (query.colorAssignmentType == 'Dynamic-Order')
                            {
                            	try {
                            		$('.order-drawline').attr('checked', JSON.parse(query.colorAssignment).drawLine);
                            	}
                            	catch (err) { }
                            }
                            
                            //icon color
                            try {
                                if (query.iconColor.indexOf('image:') == 0) {
                                    $('.colormarker .Static .markertype-selector-image').click();
                                    $('.colormarker .Static .markertype-image').val(query.iconColor.split('image:')[1]).next().find('input').val($('.colormarker .Static .markertype-image').find('option:selected').text());
                                }
                                else {
                                    $('.colormarker .Static .markertype-selector-color').click();
                                    $('.colormarker .Static .markertype-color-preview').attr('data-color', query.iconColor).html(MA.Marker.createSVG({ color: query.iconColor, forLegend: true }));
                                }
                            } catch (err) { 
                                $('.colormarker .Static .markertype-selector-color').click();
                            }
                            try {
                            	
                            }
                            catch (err) { }
                            $('.color-picklistfield').val(query.picklistField).change();
                            
                            if (query.advancedOptions.heatmapWeightedValue)
        		            {
                	            $('#heatmap-options-weighted-value').val(query.advancedOptions.heatmapWeightedValue).change();
                	            $('#heatmap-options-dissipate-with-zoom').attr('checked', query.advancedOptions.heatmapDissipating == 'true' ? 'checked' : false);
                	            $('#heatmap-options-radius').val(query.advancedOptions.heatmapRadius);
                	            $('#heatmap-options-opacity').val(query.advancedOptions.heatmapOpacity);
                	            $('#heatmap-options-max-intensity').val(query.advancedOptions.heatmapMaxIntensity);
                	            
                	            $( "#heatmap-options-color-table" ).empty();
        		                
        		                //javascript:AddColorRow('#FFFFFF')
        		                
        		                $.each(JSON.parse(query.advancedOptions.heatmapGradient), function( index, value ) {
                                    AddColorRow(value, index);
                                });
        		                
        		            }
                            
                        }
                        else
                        {
                            //no existing query so set defaults
                            $('.Static .markertype-selector-color').click();
                            if (query.baseObject == 'Task' || query.baseObject == 'Event') {
                                $('#savedqueryeditor .tooltip').first().val('Subject');
                            }
                        }
                        
                        //if we don't have a picklist field selected yet, pick the first option
                        if ($picklistField.val() == '') { $picklistField.val($picklistField.find('.option:first-child').val()); }
                        
                        //render comboboxes
                        $('#savedqueryeditor .color-assignmenttype').combobox();
                        $picklistField.combobox();
                        $tooltips.combobox();
                        $HeatmapOptionsWeightedValue.combobox();
                    }
                    else
                    {
                        //show error message
                        
                    }
                },
                error: function (request, error, exception)
                {
                    //show error
                    $('#savedqueryeditor .buttons .msgs').html('<b>Unknown Error Retrieving Query</b>: Please try again').show();
                }
            });
        
            //handle adding new filters
            $('.htab-content-button.add').click(function () {
                if ($(this).closest('.htab-content').is('.fieldfilters'))
                {
                    var $loader = $('.ajaxload.template').clone().removeClass('template').appendTo($('.fieldfilters > .listbox'))
                    $loader.slideDown(
                        200,
                        function ()
                        {
                            var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', baseObject);
                            $newFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', MA.SObject.nameField(baseObject)));
                            $newFilter.find('.fieldoptions .combobox').val('Name');
                            
                            updateFilter($newFilter, $loader);
                        }
                    );
                }
                else if ($(this).closest('.htab-content').is('.crossfilters'))
                {
                    //make sure this object has a valid child relationship
                    if (query.initialCrossObject == null || query.initialCrossField == null)
                    {
                        alert("{!$Label.MA_Base_Object_Child_Error}");
                        return;
                    }
                    
                    //make sure we don't already have 2 cross filters
                    if ($('.crossfilters .listbox > div').length > 1)
                    {
                        alert("{!$Label.MA_Cross_Filters_Allowed_Error}");
                        return;
                    }
                    
                    var $loader = $('.ajaxload.template').clone().removeClass('template').appendTo($('.crossfilters .listbox'));
                    $loader.slideDown(
                        200,
                        function ()
                        {
                            var $newCrossFilter = $('.crossfilter.template').clone().removeClass('template').attr('data-baseobject', baseObject).attr('data-index', 'AND');
                            $newCrossFilter.find('.fieldlabel .baseobject').text(query.baseObjectName);
                            $newCrossFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', 'Id'));
                            $newCrossFilter.find('.fieldoptions .combobox').val('Id');
                            $newCrossFilter.find('.crossobjectoptions .combobox').append($("<option></option>").attr('value', query.initialCrossObject));
                            $newCrossFilter.find('.crossobjectoptions .combobox').val(query.initialCrossObject);
                            $newCrossFilter.find('.crossfieldoptions .combobox').append($("<option></option>").attr('value', query.initialCrossField));
                            $newCrossFilter.find('.crossfieldoptions .combobox').val(query.initialCrossField);
                            
                            updateCrossFilter($newCrossFilter, $loader);
                        }
                    );
                }
            });
            
            //date control functions
            $('#savedqueryeditor').on('keyup', '.datejs', function (event)
            {
                //don't parse on enter because it is probably an autocomlete selection and can't change the value if it isn't
                if (event.which == 13) { return; }
                
                //don't validate controls that are marked as novalidation
                if ($(this).is('.novalidation')) { return; }
                
                //validate the input
                parseDateInput($(this));
            });
            $('#savedqueryeditor').on('click', '.dateliteralpicker', function () 
            {
                //open the date literal autocomplete list when clicking the date literal picker icon
                $(this).siblings('.datejs').autocomplete("search", "").focus();
            });
            
            //on blur, set the text value of floating point inputs to the parsed value just to avoid little issues like '2.' being valid (2. parses to 2)
            $('#savedqueryeditor').on('blur', '.NUMBER, .CURRENCY, .DOUBLE, .PERCENT', function ()
            {
                if ($(this).val() != '')
                {
                    $(this).val(parseFloat($(this).val()));
                }
            });
            
            //validation for numeric fields
            $('#savedqueryeditor').on('keyup change', '.INTEGER, .NUMBER, .CURRENCY, .DOUBLE, .PERCENT', function () 
            {
                var isValid = true;
                
                //blank is valid for all numeric fields unless the operator is range (because null is invalid with > and <)
                if ($(this).val() == '')
                {
                    if ($(this).closest('.filter').find('.operator .combobox').val() == 'range')
                    {
                        isValid = false;
                    }
                }
                else
                {
                    if ($(this).is('.INTEGER'))
                    {
                        if (isNaN(parseInt($(this).val())))
                        {
                            isValid = false;
                        }
                        else
                        {
                            //on a successful parse, set the text value to the parsed value just to avoid little issues like '2.' being valid (2. parses to 2)
                            $(this).val(parseInt($(this).val()));
                        }
                    }
                    else
                    {
                        if (isNaN(parseFloat($(this).val())))
                        {
                            isValid = false;
                        }
                    }
                }
                
                if (isValid)
                {
                    $(this).removeClass('invalid');
                }
                else
                {
                    $(this).addClass('invalid');
                }
            });
            
            /**************************************
             *  FILTER HANDLERS
             **************************************/
            
            //filter delete link
            $('#savedqueryeditor').on('click', '.filter .deletelink', function () 
            {
                $(this).closest('.filter').slideUp(
                    500, 
                    function () { 
                        $(this).remove();
                        refreshIndices();
                        refreshCrossIndices();
                        refreshBadges();
                    }
                ); 
            });
            
            
            $('#removeFiltersLink').click(function ()
            {
                $('#queryfilters .filter .deletelink, #queryfilters .crossfilter .deletelink').click();
            });
            
            //handling selecting a new field for a filter
            $('#savedqueryeditor').on('change', '.filter .fieldoptions .combobox, .filter .parentfieldoptions .combobox, .filter .grandparentfieldoptions .combobox', function ()
            {
                updateFilter($(this).closest('.filter'));
            });
            
            //handling selecting a new operator for a filter
            $('#savedqueryeditor').on('change', '.filter .operator .combobox', function ()
            {
                var $updatedFilter = $(this).closest('.filter');
            
            	//handle the range operator
                if ($(this).val() == 'range')
                {
                    $updatedFilter.find('.range').show(500);
                    $updatedFilter.find('.nextlast').hide(500);
                }
                else if ($(this).val() == 'next' || $(this).val() == 'last')
                {
                    $updatedFilter.find('.range').hide(500);
                    $updatedFilter.find('.nextlast').show(500);
                }
                else
                {
                    $updatedFilter.find('.range').hide(500);
                    $updatedFilter.find('.nextlast').hide(500);
                }
                
                //handle the in and not in operators
                if ($(this).val() == 'in' || $(this).val() == 'not in')
                {
                	$updatedFilter.find('.idfiltervalue').hide();
                	$updatedFilter.find('.queryfiltervalue').show();
                }
                else
                {
                	$updatedFilter.find('.queryfiltervalue').hide();
                	$updatedFilter.find('.idfiltervalue').show();
                }
                
                //the range operator affects validity so revalidate
                $updatedFilter.find('.value input').change();
            });
            
            //filter logic link
            $('#savedqueryeditor .filterlogiclink').click(function ()
            {
                if ($(this).text() == "{!$Label.MA_Add}")
                {
                    var filterArr = [];
                    $('.fieldfilters .filter').each(function () { filterArr.push($(this).find('.indexlabel').text()); } );
                    $('.filterlogic').val('(' + filterArr.join(' AND ') + ')').show(500);
                    $(this).text("{!$Label.MA_Remove}");
                }
                else
                {
                    $('.filterlogic').hide(500);
                    $(this).text("{!$Label.MA_Add}");
                }
            });
            
            /************************************
             *  CROSS FILTER HANDLERS
             ************************************/
            
            //handle changing field on a cross filter
            $('#savedqueryeditor').on('change', '.crossfilter > table .fieldoptions .combobox, .crossfilter .crossobjectoptions .combobox', function ()
            {
            	//remove all subfilters if the cross object is changing
            	if ($(this).is('.crossobjectoptions .combobox')) {
            		$(this).closest('.crossfilter').find('.subfilters .filter .deletelink').click();
            	}
            
                updateCrossFilter($(this).closest('.crossfilter'));
            });
            
            //handle clicking links on a cross filter
            $('#savedqueryeditor').on('click', '.crossfilter .crossfilteractions span.link', function ()
            {
                if ($(this).text() == 'Show Advanced')
                {
                    $(this).closest('.crossfilter').find('.advanced').show('slide');
                    $(this).text('Hide Advanced');  
                }
                else if ($(this).text() == 'Hide Advanced')
                {
                    $(this).closest('.crossfilter').find('.advanced').hide('slide');
                    $(this).text('Show Advanced');  
                }
                else if ($(this).text() == "{!$Label.MA_Delete}")
                {
                    $(this).closest('.crossfilter').slideUp(
                    500, 
                    function () { 
                        $(this).remove();
                        refreshIndices();
						refreshCrossIndices();
                        refreshBadges();
                    }
                ); 
                }
            });
            
            //handle subfilter links
            $('#savedqueryeditor').on('click', '.crossfilter .addfilter span.link', function ()
            {
                var $updatedCrossFilter = $(this).closest('.crossfilter');
            
                var $loader = $('.ajaxload.template').clone().removeClass('template').appendTo($updatedCrossFilter.find('.subfilters'));
                $loader.slideDown(
                    200,
                    function ()
                    {
                        var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', $updatedCrossFilter.find('.crossobjectoptions .combobox').val());
                        updateFilter($newFilter, $loader);
                    }
                );
            });
            
            //crossfilter logic link
            $('#savedqueryeditor').on('click', '.crossfilterlogiclink', function ()
            {
                if ($(this).text() == "{!$Label.MA_Add}")
                {
                    var crossfilterArr = [];
                    $(this).closest('.crossfilter').find('.subfilters > .filter').each(function () { crossfilterArr.push($(this).find('.indexlabel').text()); } );
                    $(this).closest('.crossfilterlogic').find('.crosslogic').val('(' + crossfilterArr.join(' AND ') + ')').show(500);
                    $(this).text("{!$Label.MA_Remove}");
                }
                else
                {
                    $(this).closest('.crossfilterlogic').find('.crosslogic').hide(500);
                    $(this).text("{!$Label.MA_Add}");
                }
            });
            
            /*******************************
             * ADVANCED FILTER HANDLERS
             *******************************/
            //enable disable limits with checkbox
            $('.limit-proximity-enabled').click(function()
            {
	            if ($(this).is(':checked'))
	            {
	            	$(this).closest('.htab-content-body').find('.distance-value').removeAttr('disabled', 'disabled');
            		$(this).closest('.htab-content-body').find('.distance-type').removeAttr('disabled', 'disabled');
            		$(this).closest('.htab-content-body').find('.address-value').removeAttr('disabled', 'disabled');
            		refreshBadges();
	            }
	            else
	            {
	            	$(this).closest('.htab-content-body').find('.distance-value').attr('disabled', 'disabled');
            		$(this).closest('.htab-content-body').find('.distance-type').attr('disabled', 'disabled');
            		$(this).closest('.htab-content-body').find('.address-value').attr('disabled', 'disabled');
            		refreshBadges();
	            }
	        });
	        $(".advanced-route-disablewaypoints").change(function() {			        
    			if(this.checked)		
            	{		
        			$('.advanced-route-options-inputs').show();		
    			} else {		
                    $('.advanced-route-options-inputs').hide();		
                }		
			});
	        //enable disable record limits
	        $('.limit-records-enabled').click(function()
            {
	            if ($(this).is(':checked'))
	            {
	            	$(this).closest('.htab-content-body').find('.limits-rowcount-value').removeAttr('disabled', 'disabled');
	            	refreshBadges();
	            }
	            else
	            {
	            	$(this).closest('.htab-content-body').find('.limits-rowcount-value').attr('disabled', 'disabled');
	            	refreshBadges();
	            }
	        });
            
            /*******************************
             *  ACTIVITY FILTER HANDLERS
             *******************************/
             
            //handle changing activity filters
            $('.filterbyactivity .activityfilter-task, .filterbyactivity .activityfilter-event').change(function () {
               var activityType = $(this).closest('.activityfilter-wrapper').attr('data-type');
               if ($(this).val() == 'all') {
                   $('.activitysubfilters-wrapper[data-type="'+activityType+'"]').slideUp(400);
               }
               else {
                   $('.activitysubfilters-wrapper[data-type="'+activityType+'"]').slideDown(400);
               }
               
               refreshBadges();
            });
            
            $('.activitysubfilters-wrapper .link.addfilter').click(function () {
               var baseObject = $(this).closest('.activitysubfilters-wrapper').attr('data-type') == 'task' ? 'Task' : 'Event';
               var $loader = $('.ajaxload.template').clone().removeClass('template').appendTo($(this).closest('.activitysubfilters-wrapper').find('.subfilters'));
               $loader.slideDown(
                   200,
                   function ()
                   {
                       var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', baseObject);
                       $newFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', 'Subject'));
                       $newFilter.find('.fieldoptions .combobox').val('Subject');
                       
                       updateFilter($newFilter, $loader);
                   }
               );
            });
            
            /******************************
            *	FILTER BY OWNER HANDLERS
            ********************************/
            
            //init the combobox for the owner specifier
            $('.filterbyowner-owner').combobox();
            
            //populate dynamic owner options
            var $ownerField = $('.filterbyowner-ownerfield').empty();
            $.each(JSON.parse($('[id$=":serializedFilterByOwnerOptions"]').val()), function (index, option) {
            	$ownerField.append($('<option />').attr('value', option.value).text(option.label));
            });
            $ownerField.val('OwnerId').combobox();
            
            //handle changing filter by owner
            $('input[type="radio"][name="filterByOwner"]').click(function () {
            	if ($('input[type="radio"][name="filterByOwner"]:checked').attr('value') == 'TRUE') {
            		$('.filterbyowner-ownerfield-wrapper').slideDown(400);
            	} 
            	else {
            		$('.filterbyowner-ownerfield-wrapper').slideUp(400);
            	}
            });
            
            /*****************************
            *  Jquery Sort Function
            *****************************/
			
			jQuery.fn.sortElements = (function(){
 
			    var sort = [].sort;
			 
			    return function(comparator, getSortable) {
			 
			        getSortable = getSortable || function(){return this;};
			 
			        var placements = this.map(function(){
			 
			            var sortElement = getSortable.call(this),
			                parentNode = sortElement.parentNode,
			 
			                // Since the element itself will change position, we have
			                // to have some way of storing its original position in
			                // the DOM. The easiest way is to have a 'flag' node:
			                nextSibling = parentNode.insertBefore(
			                    document.createTextNode(''),
			                    sortElement.nextSibling
			                );
			 
			            return function() {
			 
			                if (parentNode === this) {
			                    throw new Error(
			                        "You can't sort elements if any one is a descendant of another."
			                    );
			                }
			 
			                // Insert before flag:
			                parentNode.insertBefore(this, nextSibling);
			                // Remove flag:
			                parentNode.removeChild(nextSibling);
			 
			            };
			 
			        });
			 
			        return sort.call(this, comparator).each(function(i){
			            placements[i].call(getSortable.call(this));
			        });
			 
			    };
			 
			})();
            
            /*****************************
            *  COLOR MARKER HANDLERS
            *****************************/

             //handle changing assignment type
             $('.color-assignmenttype').change(function () {
                $('.color-options tr.toggle').hide().filter('.'+$(this).val()).show();
                $('.color-picklistfield').val('--Select a Field--').change().next().find('input').val('--Select a Field--');
             });
             
             //handle changing picklist field
             $('.color-picklistfield').change(function () {

                $('.color-picklistvalues').empty().show();
                if ($(this).val() == '--Select a Field--')
                {
                    //no field is selected, hide the marker grid
                    $('.color-picklistvalues').hide();
                }
                else
                {
                    var needToUpdate = $(this).data('needToUpdate');
                    $(this).data('needToUpdate', false);
                    $('#savedqueryeditor .buttons .msgs').hide();

                    $.getJSON(
                        MA.resources.QueryBuilderAPI+"{!pageSuffix}?securityToken={!securityToken}&action=getFieldMarkerMetaData&core.apexpages.devmode.url=0",
                        { baseObject: baseObject, fieldName: $(this).val() }, 
                        function (response) {
                            $('.color-picklistvalues').data('markerGrid', new MarkerGrid({ type: response.data.fieldType, needToUpdate: needToUpdate, picklistOptions: response.data.picklistOptions }));
                        	$('.color-picklistvalues').data('markerGrid').el.appendTo($('.color-picklistvalues'));
                        	
                        	if (response.data.fieldType == "REFERENCE")
                        	{
                        	    $("#advanced-reference-options").show();
                        	}
                        	else
                        	{
                        	    $("#advanced-reference-options").hide();
                        	}
                        	
                        }
                    );
                }  
			});
			
			//handle selecting a different marker type
			$('#savedqueryeditor .colormarker').on('click', '.markertype-selector img', function () {
					             
				//only show the markertype selector that matches the selected type
				if ($(this).is('.markertype-selector-color')) {
					$(this).closest('.markertype-wrapper').find('.markertype-image').next().hide();
					$(this).closest('.markertype-wrapper').find('.markertype-color-preview').show();
				}
				else {
					$(this).closest('.markertype-wrapper').find('.markertype-color-preview').hide();
					$(this).closest('.markertype-wrapper').find('.markertype-image').next().show();
				}
					                
			});
			
			//handle interacting with reference marker grid options
			$('.color-picklistvalues').on('blur', '.markertable[data-type="reference"] input.comparedisplay', function () {
        		if ($(this).next().val() == '') {
        			$(this).val('');
        		}
        	});
        	$('.color-picklistvalues').on('keydown', '.markertable[data-type="reference"] input.comparedisplay', function (e) {
        		if ($.inArray(e.which, [9,13,37,38,39,40]) == -1) {
        			$(this).next().val('');
        		}
        	});
			
			/****************************
             *	PROXIMITY HANDLERS
             ****************************/
            $('.proximity-select').change(function () {
                if ($(this).val() == 'circle')
                {
                    $('.proximity-isoline').hide();
                    $('.proximity-circle').show();
				}
				else if ($(this).val() == 'isoline')
				{
					$('.proximity-isoline').show();
					$('#savedqueryeditor .proximity-isoline-unit-type').change();
                    $('.proximity-circle').hide();
				}
			});
            
            //handle selecting a different isoline unit type
            $('#savedqueryeditor').on('change', '.proximity-isoline-unit-type', function () {
                if ($(this).val() == 'Distance') {
                    $(this).closest('.proximity-wrapper').find('.proximity-isoline-unit').html('').append("<option value='MILES'>Miles</option><option value='KM'>Km</option><option value='METERS'>Meters</option><option value='YARDS'>Yards</option><option value='FEET'>Feet</option>");
                }
                else {
                    $(this).closest('.proximity-wrapper').find('.proximity-isoline-unit').html('').append("<option value='MINUTES'>Minutes</option><option value='HOURS'>Hours</option>");
                }
            });
            
            /****************************
             *  SAVING
             ****************************/
            
            //handle clicking close
            $('#savedqueryeditor .closebtn, #savedqueryeditor-error .closebtn').click(function () {
                //attempt to fire the close callback
                if (queryEditorClose) { queryEditorClose(); }
                else if (parent.queryEditorClose) { parent.queryEditorClose(); }
            });
            
            //handle clicking save
            $('#savedqueryeditor .savebtn').click(function () 
            {
                //hide previous error messages
                $('#savedqueryeditor .buttons .msgs').hide();
                    
                //make sure we aren't already saving
                if ($(this).attr('value') == "{!$Label.MA_Saving}...")
                {
                    return false;
                }
                
                //make sure we have a query name
                if ($('#savedqueryeditor input.name').val().trim() == '')
                {
                    $('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_name}").show();
                    return;
                }
                
                //make sure we have a query description
                // if ($('#savedqueryeditor input.description').val().trim() == '')
                // {
                //     $('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_name}").show();
                //     return;
                // }
                
                //make sure there are no invalid filters (QUICK FIX HERE TO IGNORE VALIDATION PROBLEMS WITH ADVANCED CROSS FILTER OPTIONS)
                if ($('#savedqueryeditor input.invalid').not('.advanced.crossfieldoptions input').length > 0)
                {
                    $('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_filters}").show();
                    
                    //show any advanced filters that are hiding an invalid value
                    //$('#savedqueryeditor .crossfilter input.invalid:hidden').closest('.crossfilter').find('span.link:contains("Show Advanced")').click();
                
                    return false;
                }
                
                //make sure there aren't more than 3 query filters
                var queryFilterCount = 0;
                $('#savedqueryeditor .fieldfilters .filter[data-basetype="ID"]').each(function () {
                	if ($(this).find('.operator .combobox').val() == 'in' || $(this).find('.operator .combobox').val() == 'not in') {
                		queryFilterCount++;
                	}
                });
                if (queryFilterCount > 3) 
                {
                	$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_3_query_filters}").show();
                    return;
                }
                
                //make sure there are no invalid limits
               	try {
               		var rowLimit = parseInt($('.limits-rowcount-value').val());
               		if (isNaN(rowLimit) || rowLimit < 1 || rowLimit > 250000) {
               			$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_record_limit}").show();
                   		return;
               		}	
               	}
               	catch (err) {
               		$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_Invalid_record_limit}").show();
                   	return;
               	}
               	 //make sure there are no invalid numbers in before and after route waypoint days and that neither field is empty if disable is checked		
                if ($('#savedqueryeditor .advanced-route-disablewaypoints').is(':checked'))		
                try {		
               		var waypointsBefore = parseInt($('.advanced-route-before').val());		
                    var waypointsAfter = parseInt($('.advanced-route-after').val());		
                    		
               		if (isNaN(waypointsBefore) || isNaN(waypointsAfter)) {		
               			$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_Invalid_Day_Integer}").show();		
                   		return;		
               		}		
                    		
               	}		
               	catch (err) {		
               		$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_Invalid_Day_Integer}").show();		
                   	return;		
               	}                
               	//make sure there is not a invalid limit by address filter
               	if ($('#savedqueryeditor .limit-proximity-enabled').is(':checked'))
               	{
	               	try{
		               	var distance = $('#savedqueryeditor .advanced .distance-value').val();
		               	var address = $('#savedqueryeditor .advanced .address-value').val();
		               	var type = $('#savedqueryeditor .advanced .distance-type').val();
		                if (distance == '' || address == '')
		                {
		                    $('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_Invalid_Address_limits_blank}").show();
		                    return;
		                }
		                else if (isNaN(parseInt(distance)))
		                {
		                	$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_distance_number}").show();
		                    return;
		                }
	               	}
	               	catch (err) {
	               		$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_address_limit}").show();
	                   	return;
	               	}
	            }
               	
               	//make sure there are no invalid settings
               	if ($('#savedqueryeditor .advanced-enablecaching').is(':checked') && isNaN(parseInt($('#savedqueryeditor .advanced-caching-value').val())) || parseInt($('#savedqueryeditor .advanced-caching-value').val()) < 1)
               	{
               		$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_Caching_interval}").show();
                   	return;
               	}
               	else if ($('#savedqueryeditor .advanced-enablecaching').is(':checked') && $('#savedqueryeditor .filterbyowner input:radio[name=filterByOwner]:checked').val() == 'TRUE')
               	{
               		$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_Caching_owner}").show();
                   	return;
               	}
                
                //make sure we have a value for tooltip 1
                if ($('[data-tooltip="tooltip1"]').val() == '--None--')
                {
                    $('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: {!$Label.MA_Validation_Error_Tooltip1}").show();
                    return false;
                }
                
                //delete any blank multipicklist values under marker selection
				$('#savedqueryeditor table.markertable .multipicklistvalue').each(function()
				{
					if($(this).find('.comparevalue').multiselect('getChecked').length == 0)
					{
						$(this).remove();
					}
				});
                
                //validate currency grids if needed
                if ($('.color-assignmenttype').val() == 'Dynamic, Field' && $('.Dynamic.toggle .markertable.currency').length > 0)
                {
	                //compare blank values currency marker
	                var markerRulesValid = true;
					$('.color-picklistvalues .markertable .currencyvalue.row:not(:first, :last)').each(function()
	               	{ 
	                	if($(this).find('.comparevalue').val() == '' || $(this).find('.toVal').val() == '') { 
		                	markerRulesValid = false;
		                }
		            });
			        $('.color-picklistvalues .markertable .currencyvalue.row(:first, :last)').each(function()
	               	{ 
	                	if($(this).find('.comparevalue').val() == '' && $(this).find('.toVal').val() == '') { 
		                	markerRulesValid = false;
		                }
		            });
		            
					//make sure markers return a valid value range
					$('.color-picklistvalues .markertable .currencyvalue.row').each(function()
	               	{ 
	                	if(parseInt($(this).find('.comparevalue:not(:first)').val()) > parseInt($(this).find('.toVal').val())) { 
		                	markerRulesValid = false;
		                }
		            });
			        if(!markerRulesValid)
	                { 
	                	$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: You must enter a valid FROM-TO range for markers before proceeding.").show();  
	                	return false;
	                }
	            }
                
                //make sure there are no conflicting settings
                if ($('.limit-proximity-enabled').is(':checked') && $('.advanced-enablecaching').is(':checked'))
                {
                	$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: Distance filtering and caching cannot currently be used together.").show();  
                	return false;
                }
                else if ($('.proximity-enabled').is(':checked') && (isNaN(parseFloat($('.proximity-circle-radius').val())) || parseFloat($('.proximity-circle-radius').val()) <= 0))
                {
                	$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: Proximity radius must be greater than 0.").show();  
                	return false;
                }
                
                //make sure there are no blank reference values in the marker grid
                if ($('.color-picklistvalues .markertable').attr('data-type') == 'reference')
				{
					var referenceOptionError = false;
					$('.color-picklistvalues .markertable input.comparevalue[type="hidden"]').each(function () {
						if ($(this).val() == '') {
							referenceOptionError = true;
						}
					});
					
					if (referenceOptionError) {
						$('#savedqueryeditor .buttons .msgs').html("<b>{!$Label.MA_Validation_Error}</b>: You must enter a value for each option in the marker grid before proceeding.").show();
						return false;
					}
				}
                
                //loading indicator
                var $button = $(this);
                $button.attr('value', "{!$Label.MA_Saving}...");
                
                //build query object to send
                validateQuery(function (response){
                	if(response.success)
                	{
	                	$.ajax({
		                    url: MA.resources.QueryBuilderAPI+"{!pageSuffix}?securityToken={!securityToken}&action=saveQuery&core.apexpages.devmode.url=0",
		                    type: 'POST',
		                    dataType: 'JSON',
		                    data: { serializedQuery: JSON.stringify(response.query) },
		                    success: function (successResponse)
		                    {
		                        //remove loading indicator
		                        $button.attr('value', 'Save');
		                        //console.log('success:',successResponse.success);
		                        //console.log('data:',successResponse.data);
		                        if (successResponse.success)
		                        {
		                            //attempt to fire the success callback
		                            var plotQueryOnComplete = $button.is('.plotbtn');
		                            if (queryEditorSaveComplete) { queryEditorSaveComplete(successResponse.data.id, $('.baseobject-name').text(), response.query, plotQueryOnComplete, $button.is('.refreshbtn') ? '{!queryIndex}' : null); }
		                            else if (parent.queryEditorSaveComplete) { parent.queryEditorSaveComplete(successResponse.data.id, $('.baseobject-name').text(), response.query, plotQueryOnComplete, $button.is('.refreshbtn') ? '{!queryIndex}' : null); }
		                        }
		                        else
		                        {
		                            //show error message
		                            $('#savedqueryeditor .systeminfo').hide();
		                            var data = '';
		                            var msg = '';
		                            
		                            if(successResponse.data.indexOf('STRING_TOO_LONG') > -1) {
		                                data = 'Description is too long. Please limit to 255 characters.';
		                                msg = 'Error';
		                            } else {
		                                data = successResponse.data;
		                                msg = successResponse.message;
		                            }
		                            
		                            $('#savedqueryeditor .buttons .msgs').html('<b>' + msg + '</b>' + ': ' + data).show();
		                        }
		                    },
		                    error: function (request, error, exception)
		                    {
                                //show error
                                $('#savedqueryeditor .systeminfo').hide();
		                        $('#savedqueryeditor .buttons .msgs').html('<b>Error Saving Query</b>: Please check your filters try again').show();
		                    }
		                });
		             }
		             else
		             {
		             	if($button.hasClass('plotbtn') == true)
		                {
			             	//show error and update button
			                $('#savedqueryeditor .buttons .msgs').html('<b>Geocode Error</b>: Please check the entered address and distance value (Filters > Advanced > Limits)').show();
			                $button.attr('value', 'Save & Plot');
			            }
			            else
			            {
			            	//show error update button
			            	$('#savedqueryeditor .buttons .msgs').html('<b>Geocode Error</b>: Please check the entered address and distance value (Filters > Advanced > Limits)').show();
			                $button.attr('value', 'Save');
			            }
		             }
                });
            });
            
            /******************************************
             *  POPULATE DATA FROM EXISTING QUERY
             *****************************************/
            if (query.id || query.isClone)
            {
                //populate name
                $('#savedqueryeditor input.name').val(query.name);
                
                //populate description
                $('#savedqueryeditor input.description').val(query.description);

                //update filter by owner settings
                if (query.filterByOwner.indexOf('My:') == 0)
                {
                    $('.filterbyowner input:radio[name=filterByOwner][value=TRUE]').click();
                    $('.filterbyowner-ownerfield-wrapper').slideDown(400);
                    refreshBadges();
                    $('.filterbyowner-owner').val(query.filterByOwner.split(':')[1]).next().find('input').val($('.filterbyowner-owner option:selected').text());
                    $('.filterbyowner-ownerfield').val(query.filterByOwner.split(':')[2]).next().find('input').val($('.filterbyowner-ownerfield option:selected').text());
                }
                else if (query.filterByOwner == 'QUEUE')
                {
                    $('.filterbyowner input:radio[name=filterByOwner][value=QUEUE]').click()
                    .parent()
                    .find('select')
                    .val(query.selectedQueue);
                }
                
                //update activity filter settings
                $('.filterbyactivity .activityfilter-operator').val(query.filterByActivity.operator).next().find('> input').val(query.filterByActivity.operator);
                if (query.filterByActivity.task != 'all')
                {
                    //update operator
                    $('.filterbyactivity .activityfilter-task').val(query.filterByActivity.task).change().next().find('> input').val(query.filterByActivity.task);
                }
                if (query.filterByActivity.event != 'all')
                {
                    //update operator
                    $('.filterbyactivity .activityfilter-event').val(query.filterByActivity.event).change().next().find('> input').val(query.filterByActivity.event);
                }
                
                //add activity subfilters
                $.each(query.activitySubfilters, function (index, filter) {
                
                    //add new filter
                    var baseObject = filter.baseObject.toLowerCase();
                    var $loader = $('.ajaxload.template').clone().removeClass('template').appendTo($('.activitysubfilters-wrapper[data-type="'+baseObject+'"] .subfilters'));
                    $loader.slideDown(
                        200,
                        function ()
                        {
                            var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', filter.baseObject);
                            $newFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', filter.fieldName));
                            $newFilter.find('.fieldoptions .combobox').val(filter.fieldName);
                            $newFilter.find('.parentfieldoptions .combobox').append($("<option></option>").attr('value', filter.parentFieldName));
                            $newFilter.find('.parentfieldoptions .combobox').val(filter.parentFieldName);
                            $newFilter.find('.grandparentfieldoptions .combobox').append($("<option></option>").attr('value', filter.grandparentFieldName));
                            $newFilter.find('.grandparentfieldoptions .combobox').val(filter.grandparentFieldName);
                            
                            updateFilter($newFilter, $loader, filter.operator, filter.value, filter.value2);
                        }
                    );
                });
                
                //filter logic settings
                if (query.useFilterLogic)
                {
                    $('#savedqueryeditor .filterlogiclink').click();
                    $('#savedqueryeditor .filterlogic').val(query.filterLogicString);
                }
                
                //filters
                $.each(query.filters, function (index, filter)
                {
                    //add new filter
                    var $loader = $('.ajaxload.template').clone().removeClass('template').appendTo($('.fieldfilters > .listbox'))
                    $loader.slideDown(
                        200,
                        function ()
                        {
                            var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', filter.baseObject);
                            $newFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', filter.fieldName));
                            $newFilter.find('.fieldoptions .combobox').val(filter.fieldName);
                            $newFilter.find('.parentfieldoptions .combobox').append($("<option></option>").attr('value', filter.parentFieldName));
                            $newFilter.find('.parentfieldoptions .combobox').val(filter.parentFieldName);
                            $newFilter.find('.grandparentfieldoptions .combobox').append($("<option></option>").attr('value', filter.grandparentFieldName));
                            $newFilter.find('.grandparentfieldoptions .combobox').val(filter.grandparentFieldName);
                            
                            updateFilter($newFilter, $loader, filter.operator, filter.value, filter.value2);
                        }
                    );
                });
                   
                //cross filters 
                $.each(query.crossFilters, function (index, crossFilter) 
                {
                    //add new cross filter
                    var $loader = $('.ajaxload.template').clone().removeClass('template').appendTo($('.crossfilters > .listbox'));
                    $loader.slideDown(
                        200,
                        function ()
                        {
                            var $newCrossFilter = $('.crossfilter.template').clone().removeClass('template').attr('data-baseobject', crossFilter.baseObject).attr('data-index', 'AND');
                            $newCrossFilter.find('.fieldlabel .baseobject').text(query.baseObjectName);
                            $newCrossFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', crossFilter.fieldName));
                            $newCrossFilter.find('.fieldoptions .combobox').val(crossFilter.fieldName);
                            $newCrossFilter.find('.operator .combobox').val(crossFilter.operator);
                            $newCrossFilter.find('.crossobjectoptions .combobox').append($("<option></option>").attr('value', crossFilter.crossObjectName));
                            $newCrossFilter.find('.crossobjectoptions .combobox').val(crossFilter.crossObjectName);
                            $newCrossFilter.find('.crossfieldoptions .combobox').append($("<option></option>").attr('value', crossFilter.crossFieldName));
                            $newCrossFilter.find('.crossfieldoptions .combobox').val(crossFilter.crossFieldName);
                            if(crossFilter.useCrossFilterLogic)
                            {
                            	$newCrossFilter.find('.crossfilterlogic .crossfilterlogiclink').text("{!$Label.MA_Remove}");
                            	$newCrossFilter.find('.crossfilterlogic .crosslogic').show();
                            	$newCrossFilter.find('.crossfilterlogic .crosslogic').val(crossFilter.crossFilterLogicString);
                            }
                            
                            //add subfilters
                            $.each(crossFilter.filters, function (index, filter)
                            {
                                var $subloader = $('.ajaxload.template').clone().removeClass('template').appendTo($newCrossFilter.find('.subfilters'));
                                $subloader.slideDown(
                                    200,
                                    function ()
                                    {
                                        var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', $newCrossFilter.find('.crossobjectoptions .combobox').val());
                                        $newFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', filter.fieldName));
                                        $newFilter.find('.fieldoptions .combobox').val(filter.fieldName);
                                        $newFilter.find('.parentfieldoptions .combobox').append($("<option></option>").attr('value', filter.parentFieldName));
                                        $newFilter.find('.parentfieldoptions .combobox').val(filter.parentFieldName);
                                        $newFilter.find('.grandparentfieldoptions .combobox').append($("<option></option>").attr('value', filter.grandparentFieldName));
                                        $newFilter.find('.grandparentfieldoptions .combobox').val(filter.grandparentFieldName);
                                        updateFilter($newFilter, $subloader, filter.operator, filter.value, filter.value2);
                                    }
                                );
                            });
                    
                            //console.log('not going to do it');
                            // console.log('$newCrossFilter');
                            // console.log($newCrossFilter.html());
                            
                            // console.log('$loader');
                            // console.log($loader.html());
                            
                            updateCrossFilter($newCrossFilter, $loader);
                        }
                    );
	            });
	            
	            //advanced filter options
	            if (query.advancedOptions) {
	            	$('.limit-records-enabled').attr('checked', query.advancedOptions.enableLimit == 'true' ? 'checked' : false);
	            	$('.limit-proximity-enabled').attr('checked', query.advancedOptions.enableProxLimit == 'true' ? 'checked' : false);
	            	$('.advanced-enableaggregates').attr('checked', typeof query.advancedOptions.aggregateType == 'undefined' || query.advancedOptions.aggregateType != '');
	            	$('.advanced-aggregates-type').val($('.advanced-enableaggregates').is(':checked') ? query.advancedOptions.aggregateType : 'sum');
	            	$('#advanced-tooltip-defaulttab').val(query.advancedOptions.defaultTab || 'info');
                    $('#markers-defaultrendermode').val(query.advancedOptions.defaultRenderMode || 'Default');
                    $('#markers-defaultrenderarea').val(query.advancedOptions.defaultRenderArea || 'EntireMap');
               		$('.distance-value').val(query.advancedOptions.distance);
               		$('.address-value').val(query.advancedOptions.address);
		            $('.distance-type').val(query.advancedOptions.selectType);
		            if (query.advancedOptions.automaticassign)
		            {
		                $('#advanced-reference-option-automaticassign').attr('checked', query.advancedOptions.automaticassign == 'true' ? 'checked' : false);
		            }
		            if (query.advancedOptions.otherthreshold)
		            {
		                $('#advanced-reference-option-otherthreshold').val(query.advancedOptions.otherthreshold);
		            }
		            
		            if (query.advancedOptions.markerLabelTextColor)
		            {
		                $('#marker-label-text-color')[0].color.fromString( query.advancedOptions.markerLabelTextColor );
		            }
		            
		            if (query.advancedOptions.markerLabelBackgroundColor)
		            {
		                $('#marker-label-background-color')[0].color.fromString( query.advancedOptions.markerLabelBackgroundColor );
		            }
		            
		            refreshBadges();
	            }
	            if (!query.advancedOptions || query.advancedOptions.enableProxLimit == 'false')
            	{
            		$('.limit-proximity-enabled').closest('.htab-content-body').find('.distance-value').attr('disabled', 'disabled');
            		$('.limit-proximity-enabled').closest('.htab-content-body').find('.distance-type').attr('disabled', 'disabled');
            		$('.limit-proximity-enabled').closest('.htab-content-body').find('.address-value').attr('disabled', 'disabled');
            	}
            	
            	//limits
                $('.limits-rowcount-value').val(query.rowLimit);
                if (!query.advancedOptions || query.advancedOptions.enableLimit == 'false')
                {
                	$('.limit-records-enabled').closest('.htab-content-body').find('.limits-rowcount-value').attr('disabled', 'disabled');
                	refreshBadges();
                }
	            
	            //proximity
	            if (query.proximityOptions) {
	            	if(query.proximityOptions.selectType == 'circle')
	            	{
	            		$('.proximity-select').val(query.proximityOptions.selectType);
	            		$('.proximity-isoline').hide();
               			$('.proximity-circle').show();
		            	$('.proximity-enabled').attr('checked', query.proximityOptions.enabled == 'true' ? 'checked' : false);
		            	$('.proximity-hidemarkers').attr('checked', query.proximityOptions.hideMarkers == 'true' ? 'checked' : false);
                        $('.proximity-affectvisibility').attr('checked', query.proximityOptions.affectVisibility == 'false' ? false : 'checked');
		            	$('.proximity-circle-radius').val(query.proximityOptions.radius);
		            	$('.proximity-circle-unit').val(query.proximityOptions.measurementType);
		            	
		            	$('#proximity-fill')[0].color.fromString( (query.proximityOptions.fill) ? query.proximityOptions.fill : '#223388');
		            	$('#proximity-border')[0].color.fromString( (query.proximityOptions.border) ? query.proximityOptions.border : '#882233');
		            	$('#proximity-opacity').val( (query.proximityOptions.opacity) ? query.proximityOptions.opacity : '0.60');
	            	}
	            	else if (false && query.proximityOptions.selectType == 'isoline')
            		{
            			$('.proximity-isoline').show();
	                    $('.proximity-circle').hide();
            			$('.proximity-select').val(query.proximityOptions.selectType);
            			$('.proximity-enabled').attr('checked', query.proximityOptions.enabled == 'true' ? 'checked' : false);
            			$('.proximity-hidemarkers').attr('checked', query.proximityOptions.hideMarkers == 'true' ? 'checked' : false);
                        $('.proximity-affectvisibility').attr('checked', query.proximityOptions.affectVisibility == 'false' ? false : 'checked');
		            	$('.proximity-isoline-radius').val(query.proximityOptions.radius);
		            	$('.proximity-isoline-mode').val(query.proximityOptions.mode);
		            	$('.proximity-isoline-unit-type').val(query.proximityOptions.unitType);
		            	$('#savedqueryeditor .proximity-isoline-unit-type').change();
		            	$('.proximity-isoline-unit').val(query.proximityOptions.measurementType);
		            	$('.proximity-isoline-traffic').attr('checked', query.proximityOptions.traffic == 'true' ? 'checked' : false);
            		}
	            }
	            
	            //related list
                $.each(query.relatedLists, function (index, relatedList) {
                    RelatedList_Update($('#savedqueryeditor-templates .relatedlist-row').clone().insertBefore($('#relatedlist-watermark')).data({ crossObjectName: relatedList.relatedobject, crossObjectFieldName: relatedList.referencefield }), relatedList);
                });
                
                //advanced
                if (query.cacheInterval != null) {
	                try {
	           			$('#savedqueryeditor .advanced-enablecaching').attr('checked', 'checked');
	           			$('#savedqueryeditor .advanced-caching-value').val(query.cacheInterval.split(' ')[0]);
	           			$('#savedqueryeditor .advanced-caching-unit').val(query.cacheInterval.split(' ')[1]);
	           			$('#savedqueryeditor .advanced-caching-lastcachedate').text('(Last cache date: ' + query.lastCacheDate + ')');
	                }
	                catch (err) { }
	            }
	            if (query.refreshInterval != null) {
	            	try {
	            		$('#savedqueryeditor .advanced-enablerefreshing').attr('checked', 'checked');
	           			$('#savedqueryeditor .advanced-refreshing-value').val(query.refreshInterval.split(' ')[0]);
	           			$('#savedqueryeditor .advanced-refreshing-unit').val(query.refreshInterval.split(' ')[1]);
	            	}
	            	catch (err) { }
	            }
	            //if the waypoints are null don't check the disable route waypoints box and hide the input fields		
                if (query.advancedOptions.waypointsAfter == null && query.advancedOptions.waypointsBefore == null) {		
                    		
	                try {		
                        $('#savedqueryeditor .advanced-route-options-inputs').hide();                                   					
	                }		
	                catch (err) { }		
	            }		
                //if the waypoints are not null check the diable route waypoints box and show the input fields with the query data.		
                if (query.advancedOptions.waypointsAfter != null && query.advancedOptions.waypointsBefore != null) {		
                    		
	                try {		
                        $('#savedqueryeditor .advanced-route-options-inputs').show();		
	           			$('#savedqueryeditor .advanced-route-disablewaypoints').attr('checked', 'checked');		
	           			$('#savedqueryeditor .advanced-route-before').val(query.advancedOptions.waypointsBefore);		
	           			$('#savedqueryeditor .advanced-route-after').val(query.advancedOptions.waypointsAfter);	           					
	                }		
	                catch (err) { }		
	            }		
                
	            //temp fix for blank indices
                setTimeout(function(){
                	refreshCrossIndices();
                },1500);
            }
            else
            {
                //this is a new query so use default values
                setTimeout(function () { $('#savedqueryeditor input.name').focus() }, 100);
            }
        });	//end onready
        
        function disableFilter($filter)
        {
            if ($filter.is('.crossfilter')) {
        		$filter.find('.crossfilter-fields td.indexlabel').text('').append($('#savedqueryeditor-templates img.loader').clone());
        	}
        	else {
            	$filter.find('td.indexlabel').text('').append($('#savedqueryeditor-templates img.loader').clone());
            }
            return $filter;
        }
        function enableFilter($filter)
        {
            if ($filter.is('.crossfilter')) {
        		$filter.find('.crossfilter-fields td.indexlabel').empty().text($filter.attr('data-index'));
        	}
        	else {
            	$filter.find('td.indexlabel').empty().text($filter.attr('data-index'));
            }
            return $filter;
        }
        function updateFilter($updatedFilter, $loaderToReplace, operator, value, value2)
        {
            disableFilter($updatedFilter);
            
                
            $.ajax({
                url: MA.resources.QueryBuilderAPI+"{!pageSuffix}?securityToken={!securityToken}&action=getFilter&baseObject=::baseObject::&fieldName=::fieldName::&parentFieldName=::parentFieldName::&grandparentFieldName=::grandparentFieldName::&core.apexpages.devmode.url=0"
                        .replace('::baseObject::', $updatedFilter.attr('data-baseobject').split('~~')[0])
                        .replace('::fieldName::', $updatedFilter.find('.fieldoptions .combobox').val() == null ? '' : $updatedFilter.find('.fieldoptions .combobox').val())
                        .replace('::parentFieldName::', $updatedFilter.find('.parentfieldoptions .combobox').val() == null ? '' : $updatedFilter.find('.parentfieldoptions .combobox').val())
                        .replace('::grandparentFieldName::', $updatedFilter.find('.grandparentfieldoptions .combobox').val() == null ? '' : $updatedFilter.find('.grandparentfieldoptions .combobox').val()),
                type: 'POST',
                dataType: 'JSON',
                success: function (response)
                {
                    //update type information
                    $updatedFilter.attr('data-basetype', response.baseType).attr('data-fieldtype', response.fieldType);
                
                    //field options
                    var $fieldSelect = $updatedFilter.find('.fieldoptions .combobox').empty();
                    $.each(response.fieldOptions || [], function (i, opt) {
                        $fieldSelect.append(
                            $("<option></option>")
                                .attr('value', opt.value)
                                .text(opt.label)
                        );
                    });
                    $fieldSelect.val(response.fieldName);
                    $updatedFilter.find('.fieldoptions .ui-combobox > input').val($fieldSelect.find('option:selected').text());
                
                    //refresh parent field options if there are any
                    if (response.parentFieldOptions != null && response.parentFieldOptions.length > 0)
                    {
                        $parentFieldSelect = $updatedFilter.find('.parentfieldoptions .combobox').empty();
                        $.each(response.parentFieldOptions || [], function (i, opt) {
                            $parentFieldSelect.append(
                                $("<option></option>")
                                    .attr('value', opt.value)
                                    .text(opt.label)
                            );
                        });
                        $parentFieldSelect.val(response.parentFieldName);
                        $updatedFilter.find('.parentfieldoptions .ui-combobox > input').val($parentFieldSelect.find('option:selected').text());
                        $updatedFilter.find('.parentfieldoptions').show();
                    }
                    else
                    {
                        $updatedFilter.find('.parentfieldoptions').hide().find('.combobox').empty().val('');
                    }
                    
                    //refresh grandparent field options if there are any
                    if (response.grandparentFieldOptions != null && response.grandparentFieldOptions.length > 0)
                    {
                        $grandparentFieldSelect = $updatedFilter.find('.grandparentfieldoptions .combobox').empty();
                        $.each(response.grandparentFieldOptions || [], function (i, opt) {
                            $grandparentFieldSelect.append(
                                $("<option></option>")
                                    .attr('value', opt.value)
                                    .text(opt.label)
                            );
                        });
                        $grandparentFieldSelect.val(response.grandparentFieldName);
                        $updatedFilter.find('.grandparentfieldoptions .ui-combobox > input').val($grandparentFieldSelect.find('option:selected').text());
                        $updatedFilter.find('.grandparentfieldoptions').show();
                    }
                    else
                    {
                        $updatedFilter.find('.grandparentfieldoptions').hide().find('.combobox').empty().val('');
                    }
                
                    //refresh operator options
                    var $operatorOptions = $updatedFilter.find('.operator .combobox').empty();
                    $.each(response.operatorOptions || [], function (i, opt) {
                        $operatorOptions.append(
                            $("<option></option")
                                .attr('value', opt)
                                .text(opt)
                        );
                    });
                    $operatorOptions.combobox();
                    $updatedFilter.find('.operator input').val($operatorOptions.find('option:selected').change().text());
                    
                    //if we were passed an operator, populate
                    if (operator)
                    {
                    	$operatorOptions.val(operator).change().next().find('input').val($operatorOptions.find('option:selected').text());
                    }
                    
                    //change value input to match the new field type
                    $updatedFilter.find('.value .STRING input:text').removeAttr('class').val('');
                    if (response.baseType == 'STRING')
                    {
                        $updatedFilter.find('.value .STRING input').addClass(response.fieldType);
                    }
                    $updatedFilter.find('.value > div').hide().filter('.' + response.baseType).show();
                    
                    //update value options if this is a type that requires it
                    if (response.fieldType == 'PICKLIST' || response.fieldType == 'MULTIPICKLIST')
                    {
                        var $picklistOptions = $updatedFilter.find('.value .PICKLIST .multiselect').empty();
                        $.each(response.picklistOptions || [], function (i, opt) {
                            $("<option></option>")
                                .attr('value', opt.value)
                                .text(opt.label || opt.value)
                                .appendTo($picklistOptions);
                        });
                        
                        //multiselect widget might not be enabled yet which would throw an error so just catch it and do nothing
                        try {
                        	$picklistOptions.multiselect('refresh').multiselect('uncheckAll');
                        }
                        catch (err) { }
                    }
                    else if (response.fieldType == 'ID')
                    {
                    	var $cachedQueryOptions = $updatedFilter.find('.value .ID .queryfiltervalue .combobox').empty();
                    	$.each(response.cachedQueryOptions || [], function (i, opt) {
                    		$("<option></option>")
                                .attr('value', opt.value)
                                .text(opt.label)
                                .appendTo($cachedQueryOptions);
                    	});
                    	$cachedQueryOptions.next().find('input').val($cachedQueryOptions.find('option:selected').text());
                    	
                    	//set up merge field autocomplete
                    	$updatedFilter.find('.value .ID .idfiltervalue').autocomplete({
                    		source: response.currentBaseObjectNames.indexOf('User') != -1
                                ? [':Dynamic', ':UserId', ':DirectReportIds', ':SubordinateIds', ':TeamAccountIds'] //this is for the dynamic filter functionality (currently only supporting user)
                                : [':UserId', ':DirectReportIds', ':SubordinateIds', ':TeamAccountIds']
                    	});
                    }
                    
                    enableFilter($updatedFilter);
                    
                    //if we were passed a loader then replace it with this filter
                    if ($loaderToReplace)
                    {
                        $loaderToReplace.slideUp(
                            200,
                            function ()
                            {
                                $(this).replaceWith($updatedFilter);
                                $updatedFilter.attr('data-basetype', response.baseType).attr('data-fieldtype', response.fieldType).slideDown(500);
                                    
                                //assign unique names to the boolean radio buttons
                                $updatedFilter.find('.value .BOOLEAN input').attr('name', 'bool_' + globalIndex++);
                                
                                $updatedFilter.find('.combobox').combobox();
                                $updatedFilter.find('.multiselect').multiselect({
                                    noneSelectedText: 'Click here to select options',
                                    selectedList: 2
                                }).multiselectfilter().multiselect('uncheckAll');
                                buildDatePickers($updatedFilter.find('input.datejs'), { fieldType: response.fieldType });
                                
                                refreshIndices();
                                refreshCrossIndices();
                                refreshBadges();
                                
                                //if we were passed a value then use it to populate the currently displayed value input
                                if (value)
                                {
                                    switch (response.baseType)
                                    {
                                        case 'STRING':
                                            if (value != 'NULL')
                                            {
                                                $updatedFilter.find('.value > div.STRING > input').val(value);
                                            }
                                            if (value2 && value2 != 'NULL')
                                            {
                                                $updatedFilter.find('.value > div.STRING .range input').val(value2);
                                            }
                                            break;
                                        case 'PICKLIST':
                                            if (value != '')
                                            {
                                                var selectedOptions = value.split('~~');
                                                for (var s in selectedOptions)
                                                {
                                                    $updatedFilter.find('.value .PICKLIST .multiselect').multiselect("widget").find('input[value="'+selectedOptions[s]+'"]').click();// option[value='+selectedOptions[s]+']').attr('selected', 'selected');
                                                }
                                            }
                                            break;
                                        case 'BOOLEAN':
                                            if (value != 'NULL')
                                            {
                                                $updatedFilter.find('.value > div.BOOLEAN input[value='+value+']').attr('checked', 'checked');
                                            }
                                            break;
                                        case 'DATE':
                                       		if (value != 'NULL') {
                                                $updatedFilter.find('.value > div.DATE > input.datejs').val(valueToDateString(value, $updatedFilter.attr('data-fieldtype')));
                                            }
                                            if (value2 != 'NULL') {
                                                $updatedFilter.find('.value > div.DATE .range > input.datejs').val(valueToDateString(value2, $updatedFilter.attr('data-fieldtype')));
                                            }
                                            break;
                                        case 'ID':
                                        	var operator = $updatedFilter.find('.operator .combobox').val();
                                        	if (operator == 'in' || operator == 'not in')
                                        	{
                                        		$updatedFilter.find('.value .ID .queryfiltervalue .combobox').val(value)
                                        			.next().find('input').val($updatedFilter.find('.value .ID .queryfiltervalue .combobox option:selected').text());
                                        	}
                                        	else
                                        	{
                                        		$updatedFilter.find('.value .ID .idfiltervalue').val(value);
                                        	}
                                        	$updatedFilter.find('.operator .combobox').change();
                                        	break;
                                    }
                                }
                                
                                //for some reason, operator changes aren't being caught during the population process for these filters (maybe because they're hidden?).  just refire the change event now
                                $operatorOptions.find('option:selected').change();
                            }
                        );
                    }
                },
                error: function (request, error, exception)
                {
                    //show error
                    $('#savedqueryeditor .buttons .msgs').html('<b>Error Updating Filter</b>: Please try again').show();
                }
            });
            
        }
        
        function updateCrossFilter($updatedCrossFilter, $loaderToReplace)
        {
            disableFilter($updatedCrossFilter);
                
            $.ajax({
                url: MA.resources.QueryBuilderAPI+"{!pageSuffix}?securityToken={!securityToken}&action=getCrossFilter&baseObject=::baseObject::&fieldName=::fieldName::&crossObjectName=::crossObjectName::&crossFieldName=::crossFieldName::&core.apexpages.devmode.url=0"
                    .replace('::baseObject::', $updatedCrossFilter.attr('data-baseobject'))
                    .replace('::fieldName::', $updatedCrossFilter.find('.fieldoptions .combobox').val() == null ? '' : $updatedCrossFilter.find('.fieldoptions .combobox').val())
                    .replace('::crossObjectName::', $updatedCrossFilter.find('.crossobjectoptions .combobox').val() == null ? '' : $updatedCrossFilter.find('.crossobjectoptions .combobox').val())
                    .replace('::crossFieldName::', $updatedCrossFilter.find('.crossfieldoptions .combobox').val() == null ? '' : $updatedCrossFilter.find('.crossfieldoptions .combobox').val()),
                type: 'POST',
                dataType: 'JSON',
                success: function (response)
                {
                    //field options
                    $newFieldOptions = $updatedCrossFilter.find('.crossfilter-fields .fieldoptions .combobox').empty();
                    $.each(response.fieldOptions || [], function (i, opt) {
                        $newFieldOptions.append(
                            $("<option></option>")
                                .attr('value', opt.value)
                                .text(opt.label)
                        );
                    });
                    $newFieldOptions.val(response.fieldName);
                    $updatedCrossFilter.find('.crossfilter-fields .fieldoptions .ui-combobox > input').val($newFieldOptions.find('option:selected').text());
                    
                    //only update operator options if we don't have any because cross filter operator options are not affected by any changes
                    $operatorOptions = $updatedCrossFilter.find('.crossfilter-fields .operator .combobox');
                    if ($operatorOptions.children().length == 0)
                    {
                        $.each(response.operatorOptions || [], function (i, opt) {
                            $operatorOptions.append(
                                $("<option></option")
                                    .attr('value', opt.value)
                                    .text(opt.label)
                            );
                        });
                    }
                    
                    //cross object options
                    $crossObjectOptions = $updatedCrossFilter.find('.crossfilter-fields .crossobjectoptions .combobox').empty();
                    $.each(response.crossObjectOptions || [], function (i, opt) {
                        $crossObjectOptions.append(
                            $("<option></option")
                                .attr('value', opt.value)
                                .text(opt.label)
                        );
                    });
                    $crossObjectOptions.val(response.crossObjectName);
                    $updatedCrossFilter.find('.crossfilter-fields .crossobjectoptions .ui-combobox > input').val($crossObjectOptions.find('option:selected').text());
                                                                
                    //need to update cross field options
                    $crossFieldOptions = $updatedCrossFilter.find('.crossfilter-fields .crossfieldoptions .combobox').empty();
                    $.each(response.crossFieldOptions || [], function (i, opt) {
                        $crossFieldOptions.append(
                            $("<option></option")
                                .attr('value', opt.value)
                                .text(opt.label)
                        );
                    });
                    $crossFieldOptions.val(response.crossFieldName);
                    $updatedCrossFilter.find('.crossfilter-fields .crossfieldoptions .ui-combobox > input')
                        .val($crossFieldOptions.find('option:selected').text())
                        .removeClass('invalid');
                    
                    if (response.crossFieldOptions.length == 0)
                    {
                        $updatedCrossFilter.find('.crossfilter-fields .crossfieldoptions .ui-combobox > input').addClass('invalid');
                    }
                    
                    enableFilter($updatedCrossFilter);
                    
                    if ($loaderToReplace)
                    {
                        $loaderToReplace.slideUp(
                            200,
                            function ()
                            {
                                jQuery(this).replaceWith($updatedCrossFilter);
                                $updatedCrossFilter.slideDown(500);
                                
                                $updatedCrossFilter.find('.crossfilter-fields .combobox').combobox();
                                buildDatePickers($updatedCrossFilter.find('.crossfilter-fields input.datejs'));
                                
                                refreshBadges();
                            }
                        );
                    }
                },
                error: function (request, error, exception)
                {
                    //show error
                    $('#savedqueryeditor .buttons .msgs').html('<b>Error Updating Cross Filter</b>: Please try again').show();
                }
            });
        }
        function validateQuery (callback)
        {
        	//convert distance to meters
        	var distancevalue = $('.distance-value').val();
        	var distancetype = $('.distance-type').val();
        	if (distancetype == 'MILES')
        	{
        		distancemeters = distancevalue*1609.344;
        	}
        	else if (distancetype == 'KM')
        	{
        		distancemeters = distancevalue*1000;
        	}
        	else if (distancetype == 'YARDS')
        	{
        		distancemeters = distancevalue*0.9144;
        	}
        	else if (distancetype == 'FEET')
        	{
        		distancemeters = distancevalue*0.3048;
        	}
        	else
        	{
        		distancemeters = distancevalue;
        	}
        	
        	if($('.limit-proximity-enabled').is(':checked') == true)
            {
                geocode({
                    address: $('#savedqueryeditor .address-value').val(),
                    complete : function(response) 
                    {
                        if(response.success)
                        {
                            var addressLatLng = new google.maps.LatLng(response.results.Latitude, response.results.Longitude);
                            var latRadius = google.maps.geometry.spherical.computeOffset(addressLatLng, distancemeters, 0).lat() - addressLatLng.lat();
                            var lngRadius = google.maps.geometry.spherical.computeOffset(addressLatLng, distancemeters, 90).lng() - addressLatLng.lng();
                            var minLat = addressLatLng.lat() - latRadius;
                            var maxLat = addressLatLng.lat() + latRadius;
                            var minLong = addressLatLng.lng() - lngRadius;
                            var maxLong = addressLatLng.lng() + lngRadius;
                            $('#savedqueryeditor .buttons .msgs').hide();
                            callback ({
                                success:true, 
                                query:buildQuery({
                                    distanceMeters  : distancemeters,
                                    lat             : response.results.Latitude,
                                    long            : response.results.Longitude,
                                    minLat          : minLat,
                                    maxLat          : maxLat,
                                    minLong         : minLong,
                                    maxLong         : maxLong
                                })
                            });
                        }
                        else
                        {
                            callback ({success:false});
                        }
                    }
                });
            }
            else
            {
                callback ({success:true, query:buildQuery()});
            }
        }
        
        function buildQuery(options)
        {
        	var options = options || {};
            var componentIndex = 0;
            var queryObj = {
                id                  : query.id,
                name                : $('#savedqueryeditor .name').val(),
                description         : $('#savedqueryeditor .description').val(),
                folderId            : query.folderId,
                folderType          : query.folderType,
                baseObject          : query.baseObject,
                baseObjectId        : query.baseObjectId,
                filterByOwner       : 'All',
                selectedQueue       : $('#savedqueryeditor .filterbyowner select[id$=queueselect]').val(),
                useFilterLogic      : $('#savedqueryeditor .filterlogiclink').text() == "{!$Label.MA_Add}" ? false : true,
                filterLogicString   : $('#savedqueryeditor .filterlogic').val(),
                rowLimit			: $('#savedqueryeditor .limit-records-enabled').is(':checked') == true ? parseInt($('#savedqueryeditor .limits-rowcount-value').val()) : 250000,
                rowOrder			: $('#savedqueryeditor select.orderby-field').val()== '--None--' ? '' : $('select.orderby-field').val(),
                rowOrderDirection   : $('#savedqueryeditor .orderby-dir').is('.desc') ? 'desc' : 'asc',
                cacheInterval		: $('#savedqueryeditor .advanced-enablecaching').is(':checked') ? parseInt($('#savedqueryeditor .advanced-caching-value').val()) + ' ' + $('#savedqueryeditor .advanced-caching-unit').val() : null,
                refreshInterval		: $('#savedqueryeditor .advanced-enablerefreshing').is(':checked') ? parseInt($('#savedqueryeditor .advanced-refreshing-value').val()) + ' ' + $('#savedqueryeditor .advanced-refreshing-unit').val() : null,
                activitySubfilters  : [],
                filters             : [],
                crossFilters        : [],
                relatedLists		: [],
                columns             : []
            };
            
            //filter by owner settings
            var filterByOwnerValue = $('#savedqueryeditor .filterbyowner input:radio[name=filterByOwner]:checked').val();
            if (filterByOwnerValue == 'TRUE')
            {
            	queryObj.filterByOwner = 'My:' + $('.filterbyowner-owner').val() + ':' + $('.filterbyowner-ownerfield').val();
            }
            
            //add advanced options
            queryObj.advancedOptions = {
            	enableLimit		      : $('#savedqueryeditor .limit-records-enabled').is(':checked'),
               	enableProxLimit	      : $('#savedqueryeditor .limit-proximity-enabled').is(':checked'),
            	distance		      : $('.distance-value').val(),
            	selectType		      : $('.distance-type').val(),
            	address			      : $('.address-value').val(),
            	distanceMeters	      : options.distanceMeters,
				distanceLat		      : options.lat,
				distanceLong	      : options.long,
            	distanceMinLat	      : options.minLat,
            	distanceMaxLat 	      : options.maxLat,
		       	distanceMinLong	      : options.minLong,
		       	distanceMaxLong	      : options.maxLong,
		       	aggregateType	      : $('.advanced-enableaggregates').is(':checked') ? $('.advanced-aggregates-type').val() : '',
		       	defaultTab		      : $('#advanced-tooltip-defaulttab').val(),
                defaultRenderMode     : $('#markers-defaultrendermode').val(),
                defaultRenderArea     : $('#markers-defaultrenderarea').val(),
                automaticassign       : $('#advanced-reference-option-automaticassign').is(':checked'),
                otherthreshold        : $('#advanced-reference-option-otherthreshold').val(),
                heatmapWeightedValue  : $('#heatmap-options-weighted-value').val(),
	            heatmapDissipating    : $('#heatmap-options-dissipate-with-zoom').is(':checked'),
	            heatmapRadius         : $('#heatmap-options-radius').val(),
	            heatmapOpacity        : $('#heatmap-options-opacity').val(),
	            heatmapMaxIntensity   : $('#heatmap-options-max-intensity').val(),
	            heatmapGradient       : '',
	            markerLabelTextColor    : $('#marker-label-text-color').val(),
                markerLabelBackgroundColor : $('#marker-label-background-color').val(),
                waypointsBefore     : $('#savedqueryeditor .advanced-route-disablewaypoints').is(':checked') ? parseInt($('#savedqueryeditor .advanced-route-before').val()) : null,		
                waypointsAfter      : $('#savedqueryeditor .advanced-route-disablewaypoints').is(':checked') ? parseInt($('#savedqueryeditor .advanced-route-after').val()) : null		
                
	        };
	        
	        //add Heatmap Options
	        var heatmapGradient = []
	        $.each($( "#heatmap-options-color-table" ).find('input'), function( index, value ) {
                //console.log($(value).val());
                heatmapGradient.push($(value).val());
            });
	        
	        queryObj.advancedOptions.heatmapGradient = JSON.stringify(heatmapGradient);
            
            //add proximity options
            var proximityType = $('#savedqueryeditor .proximity-select').val();
            if(proximityType == 'circle')
           	{
           		queryObj.proximityOptions = {
	            	enabled			: $('.proximity-enabled').is(':checked'),
	            	hideMarkers		: $('.proximity-hidemarkers').is(':checked'),
                    affectVisibility: $('.proximity-affectvisibility').is(':checked'),
	            	radius			: $('.proximity-circle-radius').val(),
	            	selectType		: $('.proximity-select').val(),
	            	measurementType	: $('.proximity-circle-unit').val(),
	            	fill        	: $('#proximity-fill').val(),
	            	border      	: $('#proximity-border').val(),
	            	opacity     	: $('#proximity-opacity').val()
	            };
           	}
            else if(proximityType == 'isoline')
           	{
           		queryObj.proximityOptions = {
            		enabled			: $('.proximity-enabled').is(':checked'),
            		hideMarkers		: $('.proximity-hidemarkers').is(':checked'),
                    affectVisibility: $('.proximity-affectvisibility').is(':checked'),
            		radius			: $('.proximity-isoline-radius').val(),
	            	selectType		: $('.proximity-select').val(),
	            	unitType		: $('.proximity-isoline-unit-type').val(),
	            	measurementType	: $('.proximity-isoline-unit').val(),
	            	mode			: $('.proximity-isoline-mode').val(),
	            	traffic			: $('.proximity-isoline-traffic').is(':checked')
           		};
           	}
            
            //add activity filtering options
            queryObj.filterByActivity = {
                task: $('#savedqueryeditor .filterbyactivity .activityfilter-task').val(),
                event: $('#savedqueryeditor .filterbyactivity .activityfilter-event').val(),
                operator: $('#savedqueryeditor .filterbyactivity .activityfilter-operator').val()
            }; 
            
            //loop through and add activity subfilters
            var activitySubfilterSelectors = [];
            if (queryObj.filterByActivity.task != 'all') { activitySubfilterSelectors.push('#savedqueryeditor .filterbyactivity .activitysubfilters-wrapper[data-type="task"] .subfilters > .filter'); }
            if (queryObj.filterByActivity.event != 'all') { activitySubfilterSelectors.push('#savedqueryeditor .filterbyactivity .activitysubfilters-wrapper[data-type="event"] .subfilters > .filter'); }
            if (activitySubfilterSelectors.length > 0) {
                $(activitySubfilterSelectors.join(',')).each(function () {
                    queryObj.activitySubfilters.push({
                        index                   : componentIndex++,
                        baseObject              : $(this).attr('data-baseobject'),
                        fieldName               : $(this).find('.fieldoptions .combobox').val(),
                        parentFieldName         : $(this).find('.parentfieldoptions .combobox').val(),
                        grandparentFieldName    : $(this).find('.grandparentfieldoptions .combobox').val(),
                        fieldType               : $(this).attr('data-fieldtype'),
                        operator                : $(this).find('.operator .combobox').val(),
                        value                   : extractValue1($(this)),
                        value2                  : extractValue2($(this))
                    });
                });
            }
            
            //loop through and add filters
            $('.fieldfilters .filter').each(function ()
            {
                queryObj.filters.push({
                    index                   : componentIndex++,
                    baseObject              : $(this).attr('data-baseobject'),
                    indexLabel              : $(this).find('.indexlabel').text(),
                    fieldName               : $(this).find('.fieldoptions .combobox').val(),
                    parentFieldName         : $(this).find('.parentfieldoptions .combobox').val(),
                    grandparentFieldName    : $(this).find('.grandparentfieldoptions .combobox').val(),
                    fieldType               : $(this).attr('data-fieldtype'),
                    operator                : $(this).find('.operator .combobox').val(),
                    value                   : extractValue1($(this)),
                    value2                  : extractValue2($(this))
                });
            });
            
            //loop through and add cross filters
            $('.crossfilters .crossfilter').each(function ()
            {
                var crossFilter = {
                    index               	: componentIndex++,
                    baseObject          	: $(this).attr('data-baseobject'),
                    indexLabel          	: 0,
                    fieldName           	: $(this).find('.fieldoptions .combobox').val(),
                    crossObjectName     	: $(this).find('.crossobjectoptions .combobox').val(),
                    crossFieldName      	: $(this).find('.crossfieldoptions .combobox').val(),
                    operator            	: $(this).find('.operator .combobox').val(),
                    useCrossFilterLogic	  	: $(this).find('.crossfilterlogiclink').text() == "{!$Label.MA_Add}" ? false : true,
	                crossFilterLogicString	: $(this).find('.crosslogic').val(),
                    filters             	: []
                };
                
                //loop through and add subfilters
                var subfilterIndex = 1;
                $(this).find('.subfilters > .filter').each(function ()
                {
                    crossFilter.filters.push({
                        index                   : subfilterIndex++,
                        baseObject              : $(this).attr('data-baseobject').split('~~')[0],
                        indexLabel              : $(this).find('.indexlabel').text(),
                        fieldName               : $(this).find('.fieldoptions .combobox').val(),
                        parentFieldName         : $(this).find('.parentfieldoptions .combobox').val(),
                        grandparentFieldName    : $(this).find('.grandparentfieldoptions .combobox').val(),
                        fieldType               : $(this).attr('data-fieldtype'),
                        operator                : $(this).find('.operator .combobox').val(),
                        value                   : extractValue1($(this)),
                        value2                  : extractValue2($(this))
                    });
                });

                queryObj.crossFilters.push(crossFilter);
            });
            
            //loop through and add columns
            $('#querycolumns > li').each(function () {
                queryObj.columns.push({
                    fieldName       : $(this).attr('data-fieldname'),
                    fieldType       : $(this).attr('rel'),
                    isDefaultSort   : $(this).find('.sortcolumnindicator').length > 0
                });
            });
            
            //add tooltip settings
            $('#savedqueryeditor .tooltip').each(function () {
                queryObj[$(this).attr('data-tooltip')] = $(this).val() == '--None--' ? null : $(this).val();
            });
            
            //add basic color settings
            queryObj.colorAssignmentType = $('#savedqueryeditor .color-assignmenttype').val();
            queryObj.iconColor  = $('.colormarker .Static .markertype-color-preview').css('display') == 'none' 
                ? 'image:' + $('.colormarker .Static .markertype-image').val()
                : $('.Static .markertype-color-preview').attr('data-color');
            queryObj.picklistField  = $('#savedqueryeditor .color-picklistfield').val() == '--Select a Field--' ? '' : $('#savedqueryeditor .color-picklistfield').val();
            
            //add settings based on assignment type
            if (queryObj.colorAssignmentType == 'Dynamic-Order')
	        {
	        	//this is a weird place to put this, but it kind of makes sense.  We should move away from these color fields later.
	        	queryObj.colorAssignment = JSON.stringify({ drawLine: $('.order-drawline').is(':checked') });
	        }
            else if (queryObj.colorAssignmentType == 'Dynamic, Field')
            {
            	queryObj.colorAssignment = JSON.stringify($('.color-picklistvalues').data('markerGrid').colorAssignments());
	        }
            
            //loop through and add relatedlist
            $('#relatedlist-list .relatedlist-row').each(function (index)
            {
            	//build related list
                var relatedList = ({
                	index					: index, 
                    baseObject              : query.baseObject,
                    relatedobject           : $(this).data('crossObjectName'),
                    referencefield			: $(this).data('crossObjectFieldName'),
                    numtodisplay            : $(this).find('.relatedlist-numtodisplay').val(),
                    filter                  : undefined,
                    field1                  : $(this).find('.relatedlist-column').eq(0).val() || '',
                    field2                  : $(this).find('.relatedlist-column').eq(1).val() || '',
                    field3                  : $(this).find('.relatedlist-column').eq(2).val() || '',
                    field4                  : $(this).find('.relatedlist-column').eq(3).val() || '',
                    field5                  : $(this).find('.relatedlist-column').eq(4).val() || '',
                    aggregate1              : undefined,
                    aggregate2              : undefined,
                    relatedlistname			: $(this).find('.relatedlist-label').is('.watermark') ? '' : $(this).find('.relatedlist-label').text(),
                    relatedlistsort			: $(this).find('.relatedlist-orderby').val() + ' ' + $(this).find('.relatedlist-orderby-direction').val(),
                    filters					: []
                });
                
                //add filters
	            $(this).find('.relatedlist-filters .filter').each(function (index) {
	                relatedList.filters.push({
	                    index                   : componentIndex++,
	                    baseObject              : relatedList.relatedobject,
	                    indexLabel              : index,
	                    fieldName               : $(this).find('.fieldoptions .combobox').val(),
	                    parentFieldName         : $(this).find('.parentfieldoptions .combobox').val(),
	                    grandparentFieldName    : $(this).find('.grandparentfieldoptions .combobox').val(),
	                    fieldType               : $(this).attr('data-fieldtype'),
	                    operator                : $(this).find('.operator .combobox').val(),
	                    value                   : extractValue1($(this)),
	                    value2                  : extractValue2($(this))
	                });
	            });
	            
	            //add to the query
	            queryObj.relatedLists.push(relatedList);
            });
            
            
            return queryObj;
        }
        function extractValue1($filter)
        {
            switch ($filter.attr('data-basetype'))
            {
                case 'STRING':
                    return $filter.find('.value .STRING > input').val();
                    break;
                case 'PICKLIST':
                    var selectedOptions = [];
                    $filter.find('.value .PICKLIST select.multiselect').multiselect('widget').find('input[type="checkbox"]:checked').each(function () { selectedOptions.push($(this).attr('value'))});
                    //$filter.find('.value .PICKLIST select.multiselect > option:checked').each(function () { selectedOptions.push($(this).val()); } );
                    return selectedOptions.join('~~');
                    break;
                case 'BOOLEAN':
                    return $filter.find('.value .BOOLEAN input:radio:checked').val() == undefined ? 'NULL' : $filter.find('.value .BOOLEAN input:radio:checked').val();
                    break;
                case 'DATE':
                    var stringVal = $filter.find('.value .DATE > input.datejs').val();
                    var returnVal = '';
                    
                    //check if the value is a date literal
                    $.each(dateLiterals, function (i, dateLiteral)
                    {
                        //check if the label matches and the value is not blank (blank value denotes a dynamic date literal and cannot be matched directly)
                        if (dateLiteral.label == stringVal && dateLiteral.value != 'DYNAMIC')
                        {
                            //this is a date literal, so the text itself is our value
                            returnVal = dateLiteral.value;
                            return false;
                        }
                    });
                    if (returnVal != '') { return returnVal; }
                    
                    //check if the value is a dynamic date literal
                    try {
                        var stringParts = stringVal.split(' ');
                        if (stringParts[0] == 'NEXT' || stringParts[0] == 'LAST') {
                            if (!isNaN(parseInt(stringParts[1]))) {
                                if (stringParts.length == 3 && $.inArray(stringParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
                                    return stringParts[0] + '_N_' + stringParts[2] + ':' + parseInt(stringParts[1]); 
                                }
                                else if (stringParts.length == 4 && stringParts[2] == 'FISCAL') {
                                    if (stringParts[3] == 'QUARTERS' || stringParts[3] == 'YEARS') {
                                        return stringParts[0] + '_N_FISCAL_' + stringParts[3] + ':' + parseInt(stringParts[1]);
                                    }
                                }
                            }
                        }
                    }
                    catch (err) { }
                    
                    //if we made it this far, we aren't dealing with a date literal so parse the date
                    try {
                        if ($filter.attr('data-fieldtype') == 'DATE')
                        {
							var formatedDate = formatUserLocaleDate({datepicker:true}).replace('mm','MM').replace('dd','DD').replace('yy','YYYY');
                            var formattedMoment = moment(stringVal,formatedDate);
                            return formattedMoment.isValid() ? formattedMoment.format('YYYY-MM-DD') : 'NULL';
                        }
                        else
                        {
                        	var formatedDate = formatUserLocaleDate({moment:true});
                            var formattedMoment = moment(stringVal,formatedDate);
                        	return formattedMoment.isValid() ? formattedMoment.utc().format('YYYY-MM-DDTHH:mm:ss\\Z') : 'NULL';
                        }
                    }
                    catch (err) {
                        return 'NULL';
                    }
                    break;
                case 'ID':
                	var operator = $filter.find('.operator .combobox').val();
                	if (operator == 'in' || operator == 'not in')
                	{
                		return $filter.find('.value .ID .queryfiltervalue .combobox').val();
                	}
                	else
                	{
                		return $filter.find('.value .ID .idfiltervalue').val();
                	}
                	break;
                default:
                    return '';
            }
        }
        function extractValue2($filter)
        {
            switch ($filter.attr('data-basetype'))
            {
                case 'STRING':
                    return $filter.find('.value .STRING .range input').val();
                    break;
                case 'DATE':
                    var stringVal = $filter.find('.value .DATE .range input.datejs').val();
                    var returnVal = '';
                
                    //check if the value is a date literal
                    $.each(dateLiterals, function (i, dateLiteral)
                    {
                        //check if the label matches and the value is not blank (blank value denotes a dynamic date literal and cannot be matched directly)
                        if (dateLiteral.label == stringVal && dateLiteral.value != 'DYNAMIC')
                        {
                            //this is a date literal, so the text itself is our value
                            returnVal = dateLiteral.value;
                            return false;
                        }
                    });
                    if (returnVal != '') { return returnVal; }
                    
                    //check if the value is a dynamic date literal
                    try {
                        var stringParts = stringVal.split(' ');
                        if (stringParts[0] == 'NEXT' || stringParts[0] == 'LAST') {
                            if (!isNaN(parseInt(stringParts[1]))) {
                                if (stringParts.length == 3 && $.inArray(stringParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
                                    return stringParts[0] + '_N_' + stringParts[2] + ':' + parseInt(stringParts[1]); 
                                }
                                else if (stringParts.length == 4 && stringParts[2] == 'FISCAL') {
                                    if (stringParts[3] == 'QUARTERS' || stringParts[3] == 'YEARS') {
                                        return stringParts[0] + '_N_FISCAL_' + stringParts[3] + ':' + parseInt(stringParts[1]);
                                    }
                                }
                            }
                        }
                    }
                    catch (err) { }
                    
                    //if we made it this far, we aren't dealing with a date literal so parse the date
                    try {
                        if ($filter.attr('data-fieldtype') == 'DATE')
                        {
                            var formatedDate = formatUserLocaleDate({datepicker:true}).replace('mm','MM').replace('dd','DD').replace('yy','YYYY');
                            var formattedMoment = moment(stringVal,formatedDate);
                            return formattedMoment.isValid() ? formattedMoment.format('YYYY-MM-DD') : 'NULL';
                        }
                        else
                        {
                            var formatedDate = formatUserLocaleDate({moment:true});
                            var formattedMoment = moment(stringVal,formatedDate);
                            return formattedMoment.isValid() ? formattedMoment.utc().format('YYYY-MM-DDTHH:mm:ss\\Z') : 'NULL';
                        }
                    }
                    catch (err) {
                        return 'NULL';
                    }
                    break;
                default:
                    return '';
            }
        }
        function valueToDateString(value, fieldType)
        {
            //check if the value is a date literal
            for (var i in dateLiterals)
            {
                if (dateLiterals.hasOwnProperty(i) && dateLiterals[i].value == value && value != 'DYNAMIC')
                {
                    //this is a date literal, so the text itself is our value
                    return dateLiterals[i].label;
                }
            }
            
            //check if the value is a dynamic date literal
            try {
                var stringParts = value.split(':');
                if (stringParts.length == 2 && !isNaN(parseInt(stringParts[1]))) {
                    var literalParts = stringParts[0].split('_');
                    if (literalParts[0] == 'NEXT' || literalParts[0] == 'LAST') {
                        if (literalParts[1] == 'N') {
                            if (literalParts.length == 3 && $.inArray(literalParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
                                return literalParts[0] + ' ' + parseInt(stringParts[1]) + ' ' + literalParts[2]; 
                            }
                            else if (literalParts.length == 4 && literalParts[2] == 'FISCAL') {
                                if (literalParts[3] == 'QUARTERS' || literalParts[3] == 'YEARS') {
                                    return literalParts[0] + ' ' + parseInt(stringParts[1]) + ' FISCAL ' + literalParts[3];
                                }
                            }
                        }
                    }
                }
            }
            catch (err) { }
                
            //if we made it this far, we aren't dealing with a date literal so parse the date
            try
            {
                if (fieldType == 'DATE')
                {
                	var formatedDate = formatUserLocaleDate({datepicker:true}).replace('mm','MM').replace('dd','DD').replace('yy','YYYY');
                    return moment(value).format(formatedDate);
                }
                else
                {
                	var formatedDate = formatUserLocaleDate({moment:true});
                    return moment(value).format(formatedDate);
                }
            }
            catch (err) {}

            return '';
        }
        
        var dateLiterals = [
            { value:"YESTERDAY", label:"YESTERDAY" },
            { value:"TODAY", label:"TODAY" },
            { value:"TOMORROW", label:"TOMORROW" },
            { value:"LAST_WEEK", label:"LAST WEEK" },
            { value:"THIS_WEEK", label:"THIS WEEK" },
            { value:"NEXT_WEEK", label:"NEXT WEEK" },
            { value:"LAST_MONTH", label:"LAST MONTH" },
            { value:"THIS_MONTH", label:"THIS MONTH" },
            { value:"NEXT_MONTH", label:"NEXT MONTH" },
            { value:"DYNAMIC", label:"LAST N DAYS" },
            { value:"DYNAMIC", label:"NEXT N DAYS" },
            { value:"THIS_QUARTER", label:"THIS QUARTER" },
            { value:"LAST_QUARTER", label:"LAST QUARTER" },
            { value:"NEXT_QUARTER", label:"NEXT QUARTER" },
            { value:"DYNAMIC", label:"LAST N QUARTERS" },
            { value:"DYNAMIC", label:"NEXT N QUARTERS" },
            { value:"THIS_YEAR", label:"THIS YEAR" },
            { value:"LAST_YEAR", label:"LAST YEAR" },
            { value:"NEXT_YEAR", label:"NEXT YEAR" },
            { value:"DYNAMIC", label:"LAST N YEARS" },
            { value:"DYNAMIC", label:"NEXT N YEARS" },
            { value:"THIS_FISCAL_QUARTER", label:"THIS FISCAL QUARTER" },
            { value:"LAST_FISCAL_QUARTER", label:"LAST FISCAL QUARTER" },
            { value:"NEXT_FISCAL_QUARTER", label:"NEXT FISCAL QUARTER" },
            { value:"DYNAMIC", label:"LAST N FISCAL QUARTERS" },
            { value:"DYNAMIC", label:"NEXT N FISCAL QUARTERS" },
            { value:"THIS_FISCAL_YEAR", label:"THIS FISCAL YEAR" },
            { value:"LAST_FISCAL_YEAR", label:"LAST FISCAL YEAR" },
            { value:"NEXT_FISCAL_YEAR", label:"NEXT FISCAL YEAR" },
            { value:"DYNAMIC", label:"LAST N FISCAL YEARS" },
            { value:"DYNAMIC", label:"NEXT N FISCAL YEARS" }
        ];
        function buildDatePickers ($elements)
        {
        	//format date for locale
        	var formatedDate = formatUserLocaleDate({datepicker:true});
        	
            $elements
                .datepicker({
                    showOn: "button",
                    buttonImage: "{!URLFOR($Resource.QueryEditor, 'images/icons/16_calendar.png')}",
                    buttonImageOnly: true,
                    dateFormat: formatedDate,
                    constrainInput: false,
                    onSelect: function () {
                        //parse this new date
                        $(this).val(parseDateInput($(this)));
                    }
                })
                .autocomplete({
                    minLength: 0,
                    source: dateLiterals,
                    focus: function (event, ui) {
                        return false;
                    },
                    select: function( event, ui ) {
                        parseDateInput($(this).val( ui.item.label ));    
                        return false;
                    }
                })
                .blur(function () {
                    $(this).val(parseDateInput($(this)));
                });
        }
        function parseDateInput ($dateInput)
        {
            var stringVal = $dateInput.val();
        
            //check if the value is a date literal
            for (var i in dateLiterals)
            {
                //check if the label matches and the value is not blank (blank value denotes a dynamic date literal and cannot be matched directly)
                if (dateLiterals.hasOwnProperty(i) && dateLiterals[i].label == stringVal && dateLiterals[i].value != 'DYNAMIC')
                {
                    //this is a date literal, so the text itself is our value
                    $dateInput.removeClass('invalid').prev().val('');
                    return stringVal;
                }
            }
            
            //check if the value is a dynamic date literal
            try {
                var stringParts = stringVal.split(' ');
                if (stringParts[0] == 'NEXT' || stringParts[0] == 'LAST') {
                    if (!isNaN(parseInt(stringParts[1]))) {
                        if (stringParts.length == 3 && $.inArray(stringParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
                            $dateInput.removeClass('invalid').prev().val('');
                            return stringVal;
                        }
                        else if (stringParts.length == 4 && stringParts[2] == 'FISCAL') {
                            if (stringParts[3] == 'QUARTERS' || stringParts[3] == 'YEARS') {
                                $dateInput.removeClass('invalid').prev().val('');
                                return stringVal;
                            }
                        }
                    }
                }
            }
            catch (err) { }
            
            //validate the date
            var formatedDate = formatUserLocaleDate({datepicker:true}).replace('dd','DD').replace('mm','MM').replace('yy','YYYY');
            var parsedDate = moment($dateInput.val(),formatedDate);
            
            if ($dateInput.val() == '')
            {
                $dateInput.removeClass('invalid').prev().val('NULL');
                return '';
            }
            else if (!parsedDate.isValid())
            {
                $dateInput.addClass('invalid').prev().val('NULL');
                return $dateInput.val();
            }
            else
            {
                if ($dateInput.closest('.filter').attr('data-fieldtype') == 'DATE')
                {
                	//format date for locale
                	formatedDate = formatUserLocaleDate({datepicker:true}).replace('dd','DD').replace('mm','MM').replace('yy','YYYY');
           			parsedDate = moment($dateInput.val(),formatedDate);
                	
                    $dateInput.removeClass('invalid').prev().val(
                        parsedDate.format(formatedDate)
                    );
                    
                    return parsedDate.format(formatedDate);
                }
                else
                {
                	//format date for locale
                	formatedDate = formatUserLocaleDate({moment:true});
                	parsedDate = moment($dateInput.val(),formatedDate);
                	
                    $dateInput.removeClass('invalid').prev().val(
                        parsedDate.format(formatedDate)
                    );
                    
                    return parsedDate.format(formatedDate);
                }
            }
        }
        function refreshIndices()
        {
            $('.fieldfilters .listbox > .filter').each(function (index, element)
            {
                $(this).attr('data-index', index + 1).find('.indexlabel').text(index + 1);
            });
        }
        function refreshCrossIndices()
        {
        	$('.crossfilters .listbox .subfilters:first > .filter').each(function (index, element)
            	{
                	$(this).attr('data-index', index + 1).find('.indexlabel').text(index + 1);
            });
            
            $('.crossfilters .listbox .subfilters:last > .filter').each(function (index, element)
            	{
                	$(this).attr('data-index', index + 1).find('.indexlabel').text(index + 1);
            });            	
        }
        function refreshBadges()
        {
        	//filter by owner
        	var filterByOwnerCount = $('#savedqueryeditor .filterbyowner input:radio[name=filterByOwner]:checked').val() == 'TRUE' ? 1 : 0;
        	if (filterByOwnerCount == 0) {
        		$('.filtericon.filterbyownertab .filtericon-badge').hide();
        	}
        	else {
        		$('.filtericon.filterbyownertab .filtericon-badge').text(filterByOwnerCount).show();
        	}
        
        	//field filters
        	var filterCount = $('.fieldfilters .listbox .filter').length;
        	if (filterCount == 0) {
        		$('.filtericon.fieldfiltertab .filtericon-badge').hide();
        	}
        	else {
        		$('.filtericon.fieldfiltertab .filtericon-badge').text(filterCount).show();
        	}
        	
        	//cross object filters
        	var crossfilterCount = $('.crossfilters .listbox .crossfilter').length;
        	if (crossfilterCount == 0) {
        		$('.filtericon.crossfiltertab .filtericon-badge').hide();
        	}
        	else {
        		$('.filtericon.crossfiltertab .filtericon-badge').text(crossfilterCount).show();
        	}
        	
        	//filter by activity
        	var filterByActivityCount = ($('.activityfilter-task.combobox').val() == 'all' ? 0 : 1) + ($('.activityfilter-event.combobox').val() == 'all' ? 0 : 1);
        	if (filterByActivityCount == 0) {
        		$('.filtericon.filterbyactivitytab .filtericon-badge').hide();
        	}
        	else {
        		$('.filtericon.filterbyactivitytab .filtericon-badge').text(filterByActivityCount).show();
        	}
        	
        	//advanced filter options
        	var advancedOptionsCount = ($('.advanced .orderby-field').val() == '--None--' ? 0 : 1) + ($('.advanced .limit-records-enabled').is(':checked') == true ? 1 : 0) + ($('.advanced .limit-proximity-enabled').is(':checked') == true ? 1 : 0);
        	if (advancedOptionsCount == 0)
        	{
        		$('.advancedtab.filtericon .filtericon-badge').hide();
        	}
        	else {
        		$('.advancedtab.filtericon .filtericon-badge').text(advancedOptionsCount).show();
        	}
        }
		function randomHexColorCode()
        {
            var hexList = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'];
            var hexCode = '#';
            for (var i = 0; i < 6; i++)
            {
                hexCode += hexList[Math.floor(Math.random() * 16)];
            }
            return hexCode;
        }

        /***********************************************
        *   Marker Grids
        ***********************************************/

        //object
        var MarkerGrid = function (opts) {

            //defaults
            $.extend(this, {
                el: $('<div class="markergrid-wrapper"></div>'),
                tableEl: null,
                type: null,
                picklistOptions: []
            }, opts);

            //build grid element
            this.redraw();
        };

        //methods
        $.extend(MarkerGrid.prototype, {
            
            //type metadata
            types: {
                'BOOLEAN'       : { baseType: 'PICKLIST' },
                'PICKLIST'      : { baseType: 'PICKLIST' },
                'MULTIPICKLIST' : { baseType: 'MULTIPICKLIST' },
                'DATE'          : { baseType: 'DATE' },
                'DATETIME'      : { baseType: 'DATE' },
                'STRING'        : { baseType: 'STRING' },
                'TEXTAREA'      : { baseType: 'STRING' },
                'URL'           : { baseType: 'STRING' },
                'COMBOBOX'      : { baseType: 'STRING' },
                'REFERENCE'     : { baseType: 'REFERENCE' },
                'ID'            : { baseType: 'REFERENCE' },
                'CURRENCY'      : { baseType: 'NUMBER' },
                'INTEGER'       : { baseType: 'NUMBER' },
                'DOUBLE'        : { baseType: 'NUMBER' },
                'PERCENT'       : { baseType: 'NUMBER' },
                'PHONE'         : { baseType: 'PHONE' }    
            },

            //get/set type
            type: function (type) {
                if (type) {
                    this.type = type;
                    return this.redraw();
                }
                else {
                    return this.type;
                }
            },

            //get base type
            baseType: function () {
                return this.types[this.type].baseType;
            },

            //redraw the grid based on type
            redraw: function () {

                //remove existing content
                this.el.empty();

                //add quickfill options
                this.el.append($('.markergrid-quickfill[data-type="'+this.baseType()+'"]').clone());
				this.el.find('.markergrid-quickfill .numberval').blur(function() {
					$(this).formatCurrency({negativeFormat: '-%s%n', roundToDecimalPlace: -1 });
				})
				.on('keyup change', function(e) {
					var e = window.event || e;
					var keyUnicode = e.charCode || e.keyCode;
					if (e !== undefined) {
						switch (keyUnicode) {
							case 16: break; // Shift
							case 17: break; // Ctrl
							case 18: break; // Alt
							case 27: this.value = ''; break; // Esc: clear entry
							case 35: break; // End
							case 36: break; // Home
							case 37: break; // cursor left
							case 38: break; // cursor up
							case 39: break; // cursor right
							case 40: break; // cursor down
							case 78: break; // N (Opera 9.63+ maps the "." from the number key section to the "N" key too!) (See: http://unixpapa.com/js/key.html search for ". Del")
							case 110: break; // . number block (Opera 9.63+ maps the "." from the number block to the "N" key (78) !!!)
							case 190: break; // .
							default: $(this).formatCurrency({negativeFormat: '-%s%n', roundToDecimalPlace: -1});
						}
					}
				});
                
                //parse color assignments
				var colorAssignmentMap = {};
				try {
					var colorAssignmentRules = JSON.parse(query.colorAssignment);
                	$.each(colorAssignmentRules, function (index, rule) {
                    	colorAssignmentMap[rule.comparevalue] = rule;
                    });
                }
                catch (err) {
            		$.each((query.colorAssignment || '').split('~~'), function (index, colorAssignment) {
          				if (colorAssignment != '') {
          					var assignmentParts = colorAssignment.split('~');
          					colorAssignmentMap[assignmentParts[0]] = { value: assignmentParts[1] };
          				}
          			});
                }

                //add grid
                var $table = this.tableEl = $('<table class="markergrid" />').appendTo(this.el);
                $table.append($('.markergrid-header[data-type="'+this.baseType()+'"]').clone());
                
                //init headers
                $table.find('.markergrid-header .markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                
                //handlers
                $table.find('.color-dynamicallyassign').click(function () { grid.dynamicallyAssign({ dimension: $(this).attr('data-dimension') || 'all' }); });
                $table.on('click', '.add-row-icon', function () { grid.addRow({ target: this }); });
                $table.on('click', '.remove-row', function () { $(this).closest('.markergrid-row').remove(); });
                
                //add rows
                var grid = this;
                if (this.baseType() == 'PICKLIST')
                {
                	//picklists are a special case because we need to populate a row for each option even for a new grid
                    var grid = this;
                    $.each(grid.picklistOptions || [], function (index, option) {
                        grid.addRow({ comparevalue: option.itemValue });
                    });
                    grid.addRow({ comparevalue: '<Other>' }).tableEl.find('.markergrid-row').last().addClass('other');
                       
                    //update the colors based on the existing query if we have one
                    if (this.needToUpdate)
					{   
						//assign color values
						this.tableEl.find('.markergrid-row').each(function()
						{
							var text = $(this).find('.comparevalue').text();
							var color = (colorAssignmentMap[text] || { value:'#00FF00:Marker' }).value;
							if(color.indexOf('image') == 0)
							{
								var imageval = color.split('image:')[1];
								$(this).find('.markertype-image').val(imageval);
								$(this).find('.markertype-image').next().find('input').val($(this).find('.markertype-image option:selected').first().text());
								$(this).find('.markertype-wrapper > .markertype-color-preview').hide();
								$(this).find('.markertype-wrapper > .ui-combobox').show();
							}
							else
							{
                                $(this).find('.markertype-color-preview').attr('data-color', color).html(MA.Marker.createSVG({ color: color, forLegend: true }));
							}
						});
			        }
                }
				else if (this.needToUpdate) 
				{
					//create a row for each existing rule
                	$.each(colorAssignmentMap, function (index, rule) {
                    	grid.addRow({ rule: rule });
                    });
                }
                else 
                {
                	//just create a blank row and the <Other> row
                   	grid.addRow({});
                   	grid.addRow({ rule: { comparedisplay: '<Other>', comparevalue: '<Other>', value: '#00FF00' } });
                }
            },

            //add a row to the marker grid
            addRow: function (options) {
            
            	//create row
            	var $row = $('#savedqueryeditor-templates .markergrid-row[data-type="'+this.baseType()+'"]').clone();
            	if (options.target && $(options.target).closest('tr').is('.markergrid-row')) {
            		$row.insertAfter($(options.target).closest('tr'));
            	}
            	else if (this.tableEl.find('.markergrid-row.other').length > 0) {
            		$row.insertBefore(this.tableEl.find('.markergrid-row.other'));
            	}
            	else {
            		$row.appendTo(this.tableEl);
            	}

                switch (this.baseType())
                {
                    case 'PICKLIST':
                    	$row.find('.comparevalue').text(options.comparevalue);
                        $row.find('.markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                        $row.find('.markertype-image').combobox();
                        $row.find('.markertype-wrapper > .ui-combobox').hide();
                    break;
                    case 'MULTIPICKLIST':
                    
                    	//update row
                        $row.find('.markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                        $row.find('.markertype-image').combobox();
                        $row.find('.markertype-wrapper > .ui-combobox').hide();
                        
                        //add picklist options
                        $.each(this.picklistOptions, function (index, option) {
                        	$row.find('.comparevalue').append($('<option>', { value : option.itemValue }).text(option.itemLabel)); 
                        });
						$row.find('.comparevalue').multiselect({ noneSelectedText: 'Click here to select options', selectedList: 2 }).multiselectfilter().multiselect('uncheckAll');
						
						//populate
						if (options.rule) {
							if(options.rule.comparevalue == '<Other>') {
								$row.addClass('other');
								$row.find('.comparevalue option').remove();
								$row.find('.comparevalue').append($('<option></option>').attr('value', '<Other>').text('--Other--'));
								$row.find('.comparevalue').multiselect('refresh').multiselect('checkAll');
                 				$row.find('.comparevalue').multiselect('disable');
								$row.find('.operator').attr('disabled', 'disabled');
								$row.find('.remove-row').hide();
							}
							else {
								$row.find('.operator').val(options.rule.operator);
								
								var selectedOptions = options.rule.comparevalue.split('~~');
								for (var i in selectedOptions) {
                                    if (selectedOptions.hasOwnProperty(i)) {
									   $row.find('.comparevalue').multiselect('widget').find('input[value="'+selectedOptions[i]+'"]').click();
                                    }
								}
							}
							
							if(options.rule.value.indexOf('image') == 0) {
								$row.find('.markertype-selector-image').click();
								$row.find('.markertype-image').val(options.rule.value.split('image:')[1]).next().find('input').val($row.find('.markertype-image option:selected').first().text());
								$row.find('.markertype-wrapper > .markertype-color-preview').hide();
								$row.find('.markertype-wrapper > .ui-combobox').show();
							}
							else {
								$row.find('.markertype-color-preview').attr('data-color', options.rule.value).html(MA.Marker.createSVG({ color: options.rule.value, forLegend: true }));
							}
						}
                    break;
                    case 'DATE':
                    
                    	//create row
                        $row.find('.markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                        $row.find('.markertype-image').combobox();
                        $row.find('.markertype-wrapper > .ui-combobox').hide();
                        
                        //init datepickers
                        var formatedDate = formatUserLocaleDate({
			            	datepicker	: true,
			            	salesforce	: false,
			            	moment		: false
			            });
						$row.find('.comparevalue, .enddate').removeAttr('disabled').val('').datepicker({
							dateFormat: formatedDate,
                            defaultDate: "-8w",
                            numberOfMonths: 3,
                            showOn: "button",
			                buttonImage: "{!URLFOR($Resource.QueryEditor, 'images/icons/16_calendar.png')}",
			                buttonImageOnly: true,
			                constrainInput: false,
                            onClose: function( selectedDate ) {
                               	if ($(this).is('.comparevalue')) {
									$row.find('.enddate').datepicker( "option", "minDate", selectedDate );
								}
								else {
									$row.find('.comparevalue').datepicker( "option", "maxDate", selectedDate );
								}
							}
                        })
                        .autocomplete({
                            minLength: 0,
		                    source: MADateLiterals,
		                    focus: function (event, ui) {
		                        return false;
		                    },
		                    select: function( event, ui ) {
		                        $(this).val(ui.item.label);    
		                        return false;
		                    }
                    	});
						
						//populate
						if (options.rule) {
							if(options.rule.comparevalue == '<Other>') {
								$row.addClass('other');
								$row.find('.comparevalue').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
								$row.find('.enddate').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
								$row.find('.operator').attr('disabled', 'disabled');
								$row.find('.remove-row').hide();
								$row.find('.ui-datepicker-trigger').hide();
								$row.find('.dateliteralpicker').hide();
							}
							else {
								$row.find('.operator').val(options.rule.operator);
								
								var formatedDate = formatUserLocaleDate({ datepicker: true }).replace('mm','MM').replace('dd','DD').replace('yy','YYYY');
								var formatCompareValue;
								var formatEndDate;
								var comparevalueIsDateLiteral;
								var enddateIsDateLiteral;
										
								//check for date literals
			            		for (var i in MADateLiterals)
			                    {
                                    if (MADateLiterals.hasOwnProperty(i))
                                    {
    			                        //check if the label matches and the value is not blank (blank value denotes a dynamic date literal and cannot be matched directly)
    			                        if (MADateLiterals[i].label == options.rule.comparevalue && MADateLiterals[i].value != 'DYNAMIC')
    			                        {
    			                        	formatCompareValue = options.rule.comparevalue;
    			                        	comparevalueIsDateLiteral = true;
    			                        	
    			                        }
    			                        if (MADateLiterals[i].label == options.rule.enddate && MADateLiterals[i].value != 'DYNAMIC')
    			                        {
    			                        	formatEndDate = options.rule.enddate;
    			                        	enddateIsDateLiteral = true;
    			                        }
                                    }
			                    }
										
								//check if the from value is a dynamic date literal
			                    try {
			                        var stringParts = options.rule.comparevalue.split(' ');
			                        if (stringParts[0] == 'NEXT' || stringParts[0] == 'LAST') {
			                        	if (!isNaN(parseInt(stringParts[1])) && stringParts.length == 3 && $.inArray(stringParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
			                        		formatCompareValue = options.rule.comparevalue;
			                        		comparevalueIsDateLiteral = true;
					                    }
			                        }
			                        else if (stringParts[2] == 'AGO' || stringParts[2] == 'FROM') {
			                        	var stringPartsValue = parseInt(stringParts[0]);
			                        	var stringPartsUnit = stringParts[1].toLowerCase();
			                        	if (!isNaN(stringPartsValue) && $.inArray(stringPartsUnit, ['days', 'years']) != -1) {
			                        		formatCompareValue = options.rule.comparevalue;
			                        		comparevalueIsDateLiteral = true;
			                        	}
				                    }
			                    }
			                    catch (err) { }
					                    
			                    //check if the to value is a dynamic date literal
			                    try {
			                        var stringParts = options.rule.enddate.split(' ');
			                        if (stringParts[0] == 'NEXT' || stringParts[0] == 'LAST') {
			                        	if (!isNaN(parseInt(stringParts[1])) && stringParts.length == 3 && $.inArray(stringParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
			                        		enddateIsDateLiteral = true;
			                        		formatEndDate = options.rule.enddate;
					                    }
			                        }
			                        else if (stringParts[2] == 'AGO' || stringParts[2] == 'FROM') {
			                        	var stringPartsValue = parseInt(stringParts[0]);
			                        	var stringPartsUnit = stringParts[1].toLowerCase();
			                        	if (!isNaN(stringPartsValue) && $.inArray(stringPartsUnit, ['days', 'years']) != -1) {
			                        		enddateIsDateLiteral = true;
			                        		formatEndDate = options.rule.enddate;
			                        	}
				                    }
			                    }
			                    catch (err) { }
										
								//format date to display correct user locale
								if(enddateIsDateLiteral != true || comparevalueIsDateLiteral != true)
								{
									formatCompareValue = moment(options.rule.comparevalue,'YYYY-MM-DD').utc().format(formatedDate);
									formatEndDate = moment(options.rule.enddate,'YYYY-MM-DD').utc().format(formatedDate);
								}
								
								//populate
								$row.find('.comparevalue').val(formatCompareValue);
								$row.find('.enddate').val(formatEndDate);
							}
							
							if(options.rule.value.indexOf('image') == 0) {
								$row.find('.markertype-selector-image').click();
								$row.find('.markertype-image').val(options.rule.value.split('image:')[1]).next().find('input').val($row.find('.markertype-image option:selected').first().text());
								$row.find('.markertype-wrapper > .markertype-color-preview').hide();
								$row.find('.markertype-wrapper > .ui-combobox').show();
							}
							else {
								$row.find('.markertype-color-preview').attr('data-color', options.rule.value).html(MA.Marker.createSVG({ color: options.rule.value, forLegend: true }));
							}
						}
                    break;
                    case 'STRING':
                    
                    	//create row
                        $row.find('.markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                        $row.find('.markertype-image').combobox();
                        $row.find('.markertype-wrapper > .ui-combobox').hide();
                        
						//populate
						if (options.rule) {
							if(options.rule.comparevalue == '<Other>') {
								$row.addClass('other');
								$row.find('.comparevalue').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
								$row.find('.operator').attr('disabled', 'disabled');
								$row.find('.remove-row').hide();
							}
							else {
								$row.find('.operator').val(options.rule.operator);
								$row.find('.comparevalue').val(options.rule.comparevalue);
							}
							
							if(options.rule.value.indexOf('image') == 0) {
								$row.find('.markertype-selector-image').click();
								$row.find('.markertype-image').val(options.rule.value.split('image:')[1]).next().find('input').val($row.find('.markertype-image option:selected').first().text());
								$row.find('.markertype-wrapper > .markertype-color-preview').hide();
								$row.find('.markertype-wrapper > .ui-combobox').show();
							}
							else {
								$row.find('.markertype-color-preview').attr('data-color', options.rule.value).html(MA.Marker.createSVG({ color: options.rule.value, forLegend: true }));
							}
						}
						
                    break;
                   	case 'REFERENCE':
                   		
                   		//create row
                        $row.find('.markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                        $row.find('.markertype-image').combobox();
                        $row.find('.markertype-wrapper > .ui-combobox').hide();
                        
                        //handle autocomplete of related records
                        $row.find('.comparedisplay').autocomplete({
			            	source: function (request, response) {
					            var searchTerm = request.term;
							            
					            $.ajax({
				             		url: MA.resources.QueryBuilderAPI+'{!pageSuffix}?securityToken={!securityToken}&action=getLookupOptions&core.apexpages.devmode.url=0',
				             		type: 'POST',
					                dataType: 'JSON',
					                data: {
					                	baseObject	: query.baseObject,
					                	term		: searchTerm,
					                	fieldName	: $('#savedqueryeditor .color-picklistfield').val()
					                },
				             		success: function (lookupOptionsResponse) {
				             			
				             			var options = [];
				             			$.each(lookupOptionsResponse.data, function (index, data) {	
				             				options.push({
				             					label: data.Name,
				             					value: data.Id
				             				});
				             			});
				             			
				             			response(options);
				             		}
				            	});
				            },
				            minLength: 2,
				            select: function( event, ui) {
				            	$(this).closest('.markergrid-row').find('.searchText').val(ui.item.label);
				            	$(this).closest('.markergrid-row').find('.valueText').val(ui.item.value);
				            	return false;
				            },
				            focus: function( event, ui) {
					            $(this).closest('.markergrid-row').find('.searchText').val(ui.item.label);
					            $(this).closest('.markergrid-row').find('.valueText').val(ui.item.value);
					            return false;
							}
			            });
                        
						//populate
						if (options.rule) {
							if(options.rule.comparedisplay == '<Other>') {
								$row.addClass('other');
								$row.find('.comparedisplay').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
                                $row.find('.comparevalue').val('<Other>');
								$row.find('.remove-row').hide();
							}
							else {
								$row.find('.comparedisplay').val(options.rule.comparedisplay);
								$row.find('.comparevalue').val(options.rule.comparevalue);
							}
							
							if(options.rule.value.indexOf('image') == 0) {
								$row.find('.markertype-selector-image').click();
								$row.find('.markertype-image').val(options.rule.value.split('image:')[1]).next().find('input').val($row.find('.markertype-image option:selected').first().text());
								$row.find('.markertype-wrapper > .markertype-color-preview').hide();
								$row.find('.markertype-wrapper > .ui-combobox').show();
							}
							else {
								$row.find('.markertype-color-preview').attr('data-color', options.rule.value).html(MA.Marker.createSVG({ color: options.rule.value, forLegend: true }));
							}
						}
						
                   	break;
                   	case 'NUMBER':
                   	
                   		//create row
                        $row.find('.markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                        $row.find('.markertype-image').combobox();
                        $row.find('.markertype-wrapper > .ui-combobox').hide();
                        
                        //init currency mask
                        $row.find('.numberval').blur(function() {
							$(this).formatCurrency({negativeFormat: '-%s%n', roundToDecimalPlace: -1 });
						})
						.on('keyup change', function(e) {
							var e = window.event || e;
							var keyUnicode = e.charCode || e.keyCode;
							if (e !== undefined) {
								switch (keyUnicode) {
									case 16: break; // Shift
									case 17: break; // Ctrl
									case 18: break; // Alt
									case 27: this.value = ''; break; // Esc: clear entry
									case 35: break; // End
									case 36: break; // Home
									case 37: break; // cursor left
									case 38: break; // cursor up
									case 39: break; // cursor right
									case 40: break; // cursor down
									case 78: break; // N (Opera 9.63+ maps the "." from the number key section to the "N" key too!) (See: http://unixpapa.com/js/key.html search for ". Del")
									case 110: break; // . number block (Opera 9.63+ maps the "." from the number block to the "N" key (78) !!!)
									case 190: break; // .
									default: $(this).formatCurrency({negativeFormat: '-%s%n', roundToDecimalPlace: -1});
								}
							}
						});
                        
						//populate
						if (options.rule) {
							if(options.rule.comparevalue == '<Other>') {
								$row.addClass('other');
								$row.find('.comparevalue').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
								$row.find('.toVal').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
								$row.find('.remove-row').hide();
							}
							else {
								$row.find('.comparevalue').val(options.rule.comparevalue).change();
								$row.find('.toVal').val(options.rule.toVal).change();
							}
							
							if(options.rule.value.indexOf('image') == 0) {
								$row.find('.markertype-selector-image').click();
								$row.find('.markertype-image').val(options.rule.value.split('image:')[1]).next().find('input').val($row.find('.markertype-image option:selected').first().text());
								$row.find('.markertype-wrapper > .markertype-color-preview').hide();
								$row.find('.markertype-wrapper > .ui-combobox').show();
							}
							else {
								$row.find('.markertype-color-preview').attr('data-color', options.rule.value).html(MA.Marker.createSVG({ color: options.rule.value, forLegend: true }));
							}
						}
                   	
                   	break;
                   	case 'PHONE':
                   	
                   		//create row
                        $row.find('.markertype-color-preview').attr('data-color', '#00FF00:Marker').html(MA.Marker.createSVG({ forLegend: true }));
                        $row.find('.markertype-image').combobox();
                        $row.find('.markertype-wrapper > .ui-combobox').hide();
                        
                        //input mask for phone values
                        $row.find('.comparevalue').mask('(999) 999-9999');
                        
						//populate
						if (options.rule) {
							if(options.rule.comparevalue == '<Other>') {
								$row.addClass('other');
								$row.find('.operator').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
								$row.find('.comparevalue').val('<Other>').attr('disabled', 'disabled').attr('val', '<Other>');
								$row.find('.remove-row').hide();
							}
							else {
								$row.find('.operator').val(options.rule.operator);
								$row.find('.comparevalue').val(options.rule.comparevalue);
							}
							
							if(options.rule.value.indexOf('image') == 0) {
								$row.find('.markertype-selector-image').click();
								$row.find('.markertype-image').val(options.rule.value.split('image:')[1]).next().find('input').val($row.find('.markertype-image option:selected').first().text());
								$row.find('.markertype-wrapper > .markertype-color-preview').hide();
								$row.find('.markertype-wrapper > .ui-combobox').show();
							}
							else {
								$row.find('.markertype-color-preview').attr('data-color', options.rule.value).html(MA.Marker.createSVG({ color: options.rule.value, forLegend: true }));
							}
						}
                   	
                   	break;
                }

                return this;
            },
            
            rowToColorAssignment: function ($row) {
            	switch (this.baseType())
                {
                    case 'PICKLIST':
                        return {
							operator		: $row.find('.operator').val(),
							comparevalue	: $row.find('.comparevalue').text(),
							value 			: $row.find('.markertype-color-preview').css('display') == 'none' ? 'image:' + $row.find('.markertype-image').val() : $row.find('.markertype-color-preview').attr('data-color')
						};
					break;
					case 'MULTIPICKLIST':
						var selectedOptions = [];
						if($row.find('.comparevalue').val() != '<Other>') {
							$row.find('.comparevalue').multiselect('widget').find('input[type="checkbox"]:checked').each(function () { selectedOptions.push($(this).attr('value'))});
						}
	            		
						return {
			           		operator 		: $row.find('.operator').val(),
			           		comparevalue	: $row.find('.comparevalue').val() == '<Other>' ? $row.find('.comparevalue').val() : selectedOptions.join('~~'),
			           		value 			: $row.find('.markertype-color-preview').css('display') == 'none' ? 'image:' + $row.find('.markertype-image').val() : $row.find('.markertype-color-preview').attr('data-color')
			           	};
					break;
					case 'DATE':
					
						//capatalize for moment
	            		var formatedDate = formatUserLocaleDate({datepicker	: true}).replace('mm','MM').replace('dd','DD').replace('yy','YYYY');
			            		
	            		var comparevalueIsDateLiteral = false;
	            		var enddateIsDateLiteral = false;
			            		
	            		//check for date literals
	            		for (var i in MADateLiterals)
	                    {
                            if (MADateLiterals.hasOwnProperty(i))
                            {
    	                        //check if the label matches and the value is not blank (blank value denotes a dynamic date literal and cannot be matched directly)
    	                        if (MADateLiterals[i].label == $row.find('.comparevalue').val())
    	                        {
    	                        	comparevalueIsDateLiteral = true;
    	                        	
    	                        }
    	                        if (MADateLiterals[i].label == $row.find('.enddate').val())
    	                        {
    	                        	enddateIsDateLiteral = true;
    	                        	
    	                        }
                            }
	                    }
			                    
	                    //check if the from value is a dynamic date literal
	                    try {
	                        var stringParts = $row.find('.comparevalue').val().split(' ');
	                        if (stringParts[0] == 'NEXT' || stringParts[0] == 'LAST') {
	                        	if (!isNaN(parseInt(stringParts[1])) && stringParts.length == 3 && $.inArray(stringParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
	                        		comparevalueIsDateLiteral = true;
			                    }
	                        }
	                        else if (stringParts[2] == 'AGO' || stringParts[2] == 'FROM') {
	                        	var stringPartsValue = parseInt(stringParts[0]);
	                        	var stringPartsUnit = stringParts[1].toLowerCase();
	                        	if (!isNaN(stringPartsValue) && $.inArray(stringPartsUnit, ['days', 'years']) != -1) {
	                        		comparevalueIsDateLiteral = true;
	                        	}
		                    }
	                    }
	                    catch (err) { }
			                    
	                    //check if the to value is a dynamic date literal
	                    try {
	                        var stringParts = $row.find('.enddate').val().split(' ');
	                        if (stringParts[0] == 'NEXT' || stringParts[0] == 'LAST') {
	                        	if (!isNaN(parseInt(stringParts[1])) && stringParts.length == 3 && $.inArray(stringParts[2], ['DAYS', 'QUARTERS', 'YEARS']) != -1) {
	                        		enddateIsDateLiteral = true;
			                    }
	                        }
	                        else if (stringParts[2] == 'AGO' || stringParts[2] == 'FROM') {
	                        	var stringPartsValue = parseInt(stringParts[0]);
	                        	var stringPartsUnit = stringParts[1].toLowerCase();
	                        	if (!isNaN(stringPartsValue) && $.inArray(stringPartsUnit, ['days', 'years']) != -1) {
	                        		enddateIsDateLiteral = true;
	                        	}
		                    }
	                    }
	                    catch (err) { }
			                    
	                    //format to utc for storage skip other
	                    if(comparevalueIsDateLiteral == true || enddateIsDateLiteral == true)
	                    {
	                    	var formattedCompareValue = $row.find('.comparevalue').val();
							var formattedEndDate = $row.find('.enddate').val();
	                    }
	            		else if($row.find('.comparevalue').val() == '<Other>' || $row.find('.enddate').val() == '<Other>')
	            		{
	            			var formattedCompareValue = $row.find('.comparevalue').val();
							var formattedEndDate = $row.find('.enddate').val();
						}
						else
						{
							var formattedCompareValue = moment($row.find('.comparevalue').val(),formatedDate).utc().format('YYYY-MM-DD');
							var formattedEndDate = moment($row.find('.enddate').val(),formatedDate).utc().format('YYYY-MM-DD');
						}
								
	            		return {
			           		operator 		: $row.find('.operator').val(),
			           		comparevalue	: formattedCompareValue,
			           		enddate			: formattedEndDate,
			           		value 			: $row.find('.markertype-color-preview').css('display') == 'none' ? 'image:' + $row.find('.markertype-image').val() : $row.find('.markertype-color-preview').attr('data-color')
		           		};
					
					break;
					case 'STRING':
						return {
			           		operator 		: $row.find('.operator').val(),
			           		comparevalue	: $row.find('.comparevalue').val(),
			           		value 			: $row.find('.markertype-color-preview').css('display') == 'none' ? 'image:' + $row.find('.markertype-image').val() : $row.find('.markertype-color-preview').attr('data-color')
		           		};
					break;
					case 'REFERENCE':
						return {
			           		operator 		: $row.find('.operator').val(),
			           		comparevalue	: $row.find('.comparevalue').val(),
			           		value 			: $row.find('.markertype-color-preview').css('display') == 'none' ? 'image:' + $row.find('.markertype-image').val() : $row.find('.markertype-color-preview').attr('data-color'),
			           		comparedisplay	: $row.find('.comparedisplay').val()
		           		};
					break;
					case 'NUMBER':
						return {
							operator 		: $row.find('.operator').val(),
							comparevalue	: $row.find('.comparevalue').val(),
							toVal			: $row.find('.toVal').val(),
							value			: $row.find('.markertype-color-preview').css('display') == 'none' ? 'image:' + $row.find('.markertype-image').val() : $row.find('.markertype-color-preview').attr('data-color')
						};
					break;
					case 'PHONE':
						return {
			           		operator 		: $row.find('.operator').val(),
			           		comparevalue	: $row.find('.comparevalue').val(),
			           		value 			: $row.find('.markertype-color-preview').css('display') == 'none' ? 'image:' + $row.find('.markertype-image').val() : $row.find('.markertype-color-preview').attr('data-color')
		           		};
					break;
                }
            },
            
            //quickfill for supported types
            quickfill: function (options) {
            
            	//remove existing rows if needed
            	if (options.replace) {
            		this.tableEl.find('.markergrid-row:not(.other)').remove();
            	}
            	
            	//add rows based on type
            	switch (this.baseType())
            	{
            		case 'NUMBER':
            		
            			var $quickfill = this.el.find('.markergrid-quickfill');
            			var fromVal = parseFloat($quickfill.find('.numberval.from').val().replace(/,/g, ''));
						var toVal = parseFloat($quickfill.find('.numberval.to').val().replace(/,/g, ''));
						var divisions = parseInt($quickfill.find('.divisions').val());
						var stepVal = (toVal - fromVal) / divisions;
						
						var precision = $quickfill.find('.numberval.from').val().indexOf('.') == -1 ? 0 : $quickfill.find('.numberval.from').val().length - $quickfill.find('.numberval.from').val().indexOf('.') - 1;
						var precisionStepVal = 1;
						if (precision > 0) {
							var precisionStepVal = '0.';
							while (precisionStepVal.length < precision + 1) {
								precisionStepVal += '0';
							}
							precisionStepVal = parseFloat(precisionStepVal + '1');
						}
						
						//make sure the precision step val won't cause us to go over the toVal
						while ((stepVal + precisionStepVal) * divisions > toVal) {
							stepVal -= precisionStepVal;
						}
						
						var currentVal = parseFloat(fromVal.toFixed(precision));
						for (var i = 0; i < divisions; i++) {
							var nextVal = i + 1 == divisions ? toVal : parseFloat((currentVal + stepVal).toFixed(precision));
							this.addRow({ rule: { operator: 'currency', comparevalue: currentVal.toFixed(precision), toVal: nextVal.toFixed(precision), value: '#00FF00' } });
							currentVal = nextVal + precisionStepVal;
						}
            		
            		break;
            	}
            	
            	//sort if new rows were added
            	if (!options.replace) {
            		this.sort({ target: this.el.find('.markergrid-sort').data('sortDir', 'ASC') });
            	}
            
            },
            
            //sort for supported types
            sort: function (options) {
            
            	switch (this.baseType())
            	{
            		case 'NUMBER':
            		
            			if ($(options.target).data('sortDir') == 'DESC')
                  		{
                   			this.tableEl.find('.markergrid-row').sortElements(function(a, b){
				            	if ($(a).find('.comparevalue').val() == '') {
				            		return 1;
				            	}
			            		else if($(b).find('.comparevalue').val() == '') {
			            			 return -1;
			            		}
			            		else {
							    	return parseInt($(a).find('.comparevalue').val().replace(/,/g, '')) < parseInt($(b).find('.comparevalue').val().replace(/,/g, '')) ? 1 : -1;
								}
							});
							$(options.target).data('sortDir', 'ASC');
                        }
                        else
                        {
							this.tableEl.find('.markergrid-row').sortElements(function(a, b){
				            	if ($(a).find('.comparevalue').val() == '') {
				            		return -1;
				            	}
			            		else if($(b).find('.comparevalue').val() == '') {
			            			 return 1;
			            		}
			            		else {
							    	return parseInt($(a).find('.comparevalue').val().replace(/,/g, '')) > parseInt($(b).find('.comparevalue').val().replace(/,/g, '')) ? 1 : -1;
								}
							});
							$(options.target).data('sortDir', 'DESC');
						}
            		
            		break;
            	}
            
            },
            
            //dynamically select options
            dynamicallyAssign: function (options) {
                options = $.extend({
                    dimension: 'all'
                }, options);

            	this.tableEl.find('.markergrid-row').each(function () {
                    var shapeKeys = $.map(MA.Marker.shapes, function (markerShape, key) { return $.inArray('dynamic', markerShape.types) == -1 ? null : key; });
                    var shape = (options.dimension == 'all' || options.dimension == 'shape') ? shapeKeys[Math.floor(Math.random() * shapeKeys.length)] : ($(this).find('.markertype-color-preview').attr('data-color').split(':')[1] || 'Marker');
                    var color = (options.dimension == 'all' || options.dimension == 'color') ? randomHexColorCode() : $(this).find('.markertype-color-preview').attr('data-color').split(':')[0];
			    	$(this).find('.markertype-color-preview').attr('data-color', color+':'+shape).html(MA.Marker.createSVG({ color: color+':'+shape, forLegend: true }));
			                             
			    	var $imageOptions = $(this).find('.markertype-image option');
                    var image = (options.dimension == 'all' || options.dimension == 'image') ? $($imageOptions.get(Math.floor(Math.random() * $imageOptions.length))).attr('value') : $(this).find('.markertype-image').val();
			   		$(this).find('.markertype-image').val(image).next().find('input').val($(this).find('.markertype-image option:selected').text());
			   	}); 
            },
            
            //get/set color assignments
            colorAssignments: function (options) {
            	var grid = this;
            	return grid.tableEl.find('.markergrid-row').map(function (index, row) {
            		return grid.rowToColorAssignment($(row));
            	}).get();
            }

        });
        
        /***********************
        * Related Lists
        ************************/
        function RelatedList_Add()
        {
        	var relatedListParts = $(this).val().split('~~');
        	if (relatedListParts[0] != '--') {
        		var $relatedList = $('#savedqueryeditor-templates .relatedlist-row').clone().insertBefore('#relatedlist-watermark').data({ crossObjectName: relatedListParts[0], crossObjectFieldName: relatedListParts[1] });
        		$relatedList.find('.relatedlist-label').text($(this).find('option:selected').text());
        		RelatedList_Update($relatedList);
        	}
        	
        	setTimeout(function () {
        		$('#relatedlist-addnew-object').val('--').next().find('input').val('--Add New--');
        	}, 500);
        }
        function RelatedList_EditLabel($relatedList)
        {
        	var $label = $relatedList.find('.relatedlist-label');
        	if (!$label.is('editing')) {
	        	var label = $label.is('.watermark') ? '' : $label.text();
	        	$relatedList.find('.relatedlist-label').empty().append($('<input class="relatedlist-label-input" />').val(label)).removeClass('watermark').addClass('editing');
	        	$relatedList.find('.relatedlist-label-input').select().on('blur', function () {
	        		$label.text($relatedList.find('.relatedlist-label-input').val().trim()).removeClass('editing');
	        		if ($label.text() == '') {
	        			$label.text('Click to add a label').addClass('watermark');
	        		}
	        	});
	        }
        }
        function RelatedList_Update($relatedList, relatedList)
        {
        	//create comboboxes
        	$relatedList.find('.combobox').combobox();
        	$('.relatedlist-numtodisplay-wrapper .ui-autocomplete-input:first').width(40);
        	$('.relatedlist-numtodisplay-wrapper .ui-autocomplete-input:last').width(60);
        
        	var requestData = { baseObject: query.baseObject, crossObjectName: $relatedList.data('crossObjectName') };
        	$.ajax({
				url: MA.resources.QueryBuilderAPI+"{!pageSuffix}?securityToken={!securityToken}&action=getRelatedList&core.apexpages.devmode.url=0",
                type: 'POST',
                dataType: 'JSON',
                data: requestData,
                success: function (response)
                {
                	$relatedList.data('columnOptions', response.data.crossObjectFieldOptions);
                	
                	//populate sort options
                	var $orderBy = $relatedList.find('.relatedlist-orderby').empty();
                	$.each(response.data.crossObjectSortFieldOptions || [], function (index, option) {
                		$('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($orderBy);
                	});
                	$orderBy.val('CreatedDate').combobox();
                	
                	//select existing values
                	if (relatedList)
                	{
                		//basic settings
                		relatedList.relatedlistsort = relatedList.relatedlistsort || 'CreatedDate DESC';
                		$relatedList.find('.relatedlist-numtodisplay').val(relatedList.numtodisplay).next().find('input').val(relatedList.numtodisplay);
                		$relatedList.find('.relatedlist-orderby').val(relatedList.relatedlistsort.split(' ')[0]).next().find('input').val($relatedList.find('.relatedlist-orderby option:selected').text());
                		$relatedList.find('.relatedlist-orderby-direction').val(relatedList.relatedlistsort.split(' ')[1]).next().find('input').val($relatedList.find('.relatedlist-orderby-direction option:selected').text());
                		
                		//label
                		$relatedList.find('.relatedlist-label').text(relatedList.relatedlistname);
                		if (relatedList.relatedlistname == null) {
                			$relatedList.find('.relatedlist-label').text('Click to add a label').addClass('watermark');
                		}
                		
                		//add columns
                		for (var i = 1; i < 6; i++) {
                			if (relatedList['field'+i]) {
                				RelatedList_AddColumn($relatedList, relatedList['field'+i]);
                			}
                		}
                		
                		//add filters
                		$.each(relatedList.filters || [], function (index, filter) {
                			
                			//add new filter
		                    var $loader = $('.ajaxload.template').clone().removeClass('template').insertBefore($relatedList.find('.relatedlist-addfilter'))
		                    $loader.slideDown(
		                        200,
		                        function ()
		                        {
		                            var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', filter.baseObject);
		                            $newFilter.find('.fieldoptions .combobox').append($("<option></option>").attr('value', filter.fieldName));
		                            $newFilter.find('.fieldoptions .combobox').val(filter.fieldName);
		                            $newFilter.find('.parentfieldoptions .combobox').append($("<option></option>").attr('value', filter.parentFieldName));
		                            $newFilter.find('.parentfieldoptions .combobox').val(filter.parentFieldName);
		                            $newFilter.find('.grandparentfieldoptions .combobox').append($("<option></option>").attr('value', filter.grandparentFieldName));
		                            $newFilter.find('.grandparentfieldoptions .combobox').val(filter.grandparentFieldName);
		                            
		                            updateFilter($newFilter, $loader, filter.operator, filter.value, filter.value2);
		                        }
		                    );
                			
                		});
	                }
	                
	                //populate the first column with the name field if it's not already populated
	                if ($relatedList.find('.relatedlist-column').length == 0) {
	                	RelatedList_AddColumn($relatedList);
	                	$relatedList.find('.relatedlist-column').val(response.data.nameField).change().next().find('input').val($relatedList.find('.relatedlist-column option:selected').text());
	                }
             	}
            });
        }
        function RelatedList_AddColumn($relatedList, value)
        {
        	//add column
        	var $column = $('<select class="relatedlist-column"><option value="--">--None--</option></select>');
        	$.each($relatedList.data('columnOptions'), function (index, option) {
        		$('<option></option>').attr('value', option.itemValue).text(option.itemLabel).appendTo($column);
        	});
        	$column.insertBefore($relatedList.find('.relatedlist-addcolumn')).combobox();
        	
        	//populate value if we have one, otherwise use default
        	if (value) {
        		$column.val(value).next().find('input').val($column.find('option:selected').text());
        	}
        	else {
        		$column.find('option').each(function () {
        			if ($(this).attr('value') == 'Name') {
        				$column.val('Name').next().find('input').val($(this).text());
        				return false;
        			}
        		});
        		
        		if ($column.val() == '--None--') {
        			var $firstOption = $column.children(':first').next();
        			$column.val($firstOption.attr('value')).next().find('input').val($firstOption.text());
        		}
        	}
        	
        	//handle removing the column when --None-- is selected
        	$column.on('change', function () {
        		if ($(this).val() == '--') {
        			$(this).next().remove();
        			$(this).remove();
        			$relatedList.find('.relatedlist-addcolumn').show();
        		}
        	});
        	
        	//hide the add column link if we already have 5
        	if ($relatedList.find('.relatedlist-column').length >= 5) {
        		$relatedList.find('.relatedlist-addcolumn').hide();
        	}
        }
        function RelatedList_AddFilter($relatedList)
        {
        	var baseObject = $relatedList.data('crossObjectName');
            var $loader = $('.ajaxload.template').clone().removeClass('template').insertBefore($relatedList.find('.relatedlist-addfilter'));
            $loader.slideDown(
                200,
                function ()
                {
                    var $newFilter = $('.filter.template').clone().removeClass('template').attr('data-baseobject', baseObject);
                    updateFilter($newFilter, $loader);
                }
            );
        }
        function RelatedList_Move($relatedList, direction)
        {
        	if (direction == 'up' && $relatedList.prev('.relatedlist-row').length > 0) {
        		$relatedList.insertBefore($relatedList.prev());
        	}
        	else if (direction == 'down' && $relatedList.next('.relatedlist-row').length > 0) {
        		$relatedList.insertAfter($relatedList.next());
        	}
        }
        function RelatedList_Remove($relatedList)
        {
        	$relatedList.remove();
        }
    </script>
    
    <div class='modal-layer'></div>
    
    <apex:form >
        <apex:inputHidden id="serializedQuery" value="{!serializedQuery}" />
        <apex:inputHidden id="serializedFilterByOwnerOptions" value="{!serializedFilterByOwnerOptions}" />
    
        <!-- Error State -->
        <div id='savedqueryeditor-error'>
        
            <!-- Title -->
            <h2>{!$Label.MA_Error}</h2>
            <h3>{!$Label.MA_EQ_Error_Message}</h3>
        
            <!-- Message -->
            <div></div>
            
            <!-- Buttons -->
            <div class='buttons'>
                <input type='button' class='closebtn btn btn-white' value='Close' />​
            </div>
            
        </div>
    
        <!-- Non-Error State -->
        <div id='savedqueryeditor'>
            <!-- Title -->
            <h2>{!$Label.MA_Create_Edit_Saved_Query}</h2>
            
            <!-- Basic Information -->
            <div class='gray box'>
                <table class='form'>
                    <tr>
                        <td>{!$Label.MA_Name}</td>
                        <td><input type='text' class='name' style='width: 200px;' /></td>
                    </tr>
                    <tr>
                        <td>{!$Label.MA_Description}</td>
                        <td><input type='text' class='description' style='width: 400px;' /> (Limit: 255 Characters)</td>
                    </tr>
                    <tr>
                        <td>{!$Label.MA_Base_Object}</td>
                        <td><span class='baseobject-name'></span></td>
                    </tr>
                </table>
            </div>
            
            <!-- Tabs -->
            <div class='tabs'>
                <ul>
                    <li><a href="#tab-filters">{!$Label.MA_Filters}</a></li>
                    <li><a href="#tab-tooltips">{!$Label.MA_Tooltips}</a></li>
                    <li><a href="#tab-markers">{!$Label.MA_Markers}</a></li>
                    <li><a href="#tab-heatmap-options">Heatmap Options</a></li>
                    <li><a href="#tab-relatedlist">{!$Label.MA_Related_Lists}</a></li>
	                <li><a href="#tab-proximity">{!$Label.MASettings_Proximity}</a></li>
	                <li><a href="#tab-advanced">{!$Label.MATerritoryBuilder_Advanced}</a></li>
	                <li><a href="#tab-aggregates" style='display: none;'>{!$Label.MA_Aggregates}</a></li>
                </ul>
                
                <!-- Filters Tab -->
                <div class='filterbyownertab-selected' style='display: none;'></div>
                <div id='tab-filters'>
                	<table style='width: 100%;'>
                		<tr>
                			<td style='vertical-align:top; padding-right: 10px;'>
                				<div class='fieldfiltertab filtericon active' data-tab='fieldfilters'><div class='filtericon-badge'></div></div>
      	 						<div class='crossfiltertab filtericon' data-tab='crossfilters'><div class='filtericon-badge'></div></div>
       	 						<div class='filterbyactivitytab filtericon' data-tab='filterbyactivity'><div class='filtericon-badge'></div></div>
       	 						<div class='filterbyownertab filtericon' data-tab='filterbyowner'><div class='filtericon-badge'></div></div>
       	 						<div class='advancedtab filtericon' data-tab='advanced'><div class='filtericon-badge'></div></div>
                			</td>
                			<td style='vertical-align:top; width: 100%;'>
			                    <div class='htab-content-wrapper' style='min-height: 340px;'>
			                    
				                    <!-- Field Filters -->
				                    <div class='htab-content fieldfilters' data-tab='fieldfilters'>
				                        <div class='htab-content-header'>{!$Label.MA_Field_Filters}</div>
				                        
				                        <!-- Filters -->
				                        <div class='section-body listbox' style='max-height: 250px; overflow: auto;'>
				                        </div>
				                        
				                        <!-- Add Filter -->
				                        <div style='margin-top: 5px; margin-left: 15px;'>
				                        	<span style='color: silver; font-size: 10px; vertical-align: top;'>|_</span> <span class='link htab-content-button add' style='font-size: 10px; font-family: Verdana, Helvetica, sans-serif;'>Add Filter</span>
				                        </div>
				                        
				                        <!-- Footer -->
				                        <div class='section-footer' style='position: absolute; bottom: 10px; width: 100%;'>
				                            <div style='margin: 10px 30px 0 10px; padding: 5px; border-top: 1px solid silver;'>
				                                <b>{!$Label.MA_Filter_Logic}</b> 
				                                <input type='text' class='filterlogic' style='display: none;' /> 
				                                <span class='filterlogiclink small link'>{!$Label.MA_Add}</span>
				                            </div>
				                        </div>
				                    </div>
				                    
				                    <!-- Cross Filters -->
				                    <div class='htab-content crossfilters' data-tab='crossfilters' style='display: none;'>
				                        <div class='htab-content-header'>{!$Label.MA_Cross_Object_Filters}</div>
				                        
				                        <!-- Filters -->
				                        <div class='section-body listbox'>
				                        </div>
				                        
				                        <!-- Add Filter -->
				                        <div style='margin-top: 5px; margin-left: 15px;'>
				                        	<span style='color: silver; font-size: 10px; vertical-align: top;'>|_</span> <span class='link htab-content-button add' style='font-size: 10px; font-family: Verdana, Helvetica, sans-serif;'>Add Cross Object Filter</span>
				                        </div>
				                        
				                    </div>
				                    
				                    <!-- Query Filters -->
				                    <div class='htab-content queryfilters' data-tab='queryfilters' style='display: none;'>
				                    	<div class='htab-content-header'>{!$Label.MA_Query_Filters}</div>
				                    </div>
				                    
				                    <!-- Filter By Activity -->
				                    <div class='htab-content filterbyactivity' data-tab='filterbyactivity' style='display: none;'>
				                        <div class='htab-content-header'>{!$Label.MA_Filter_By_Activity}</div>
				                        
				                        <div class='htab-content-body'>
				                        
				                            <!-- Tasks -->
				                            <div class='activityfilter-type-wrapper'>
				                            
				                                <!-- Task Options -->
				                                <div class='activityfilter-wrapper' data-type='task'>
				                                    {!$Label.MA_Show} {!query.baseObjectPlural}
				                                    <select class='activityfilter-task combobox'>
				                                        <option value='all'>{!$Label.MA_with_or_without}</option>
				                                        <option value='with'>{!$Label.MA_with}</option>
				                                        <option value='without'>{!$Label.MA_without}</option>
				                                    </select>
				                                    {!$Label.MA_Tasks}
				                                </div>
				                                
				                                <!-- Task Subfilters -->
				                                <div class='activitysubfilters-wrapper' data-type='task' style='display: none; padding-left: 25px;'>
				                                    <div class='subfilters'></div>
				                                    <div><span class='link blue addfilter'>{!$Label.MA_Add_Filter}</span></div>
				                                </div>
				                                
				                            </div>
				                            
				                            <!-- Operator -->
				                            <select class='activityfilter-operator combobox'>
				                                <option value='AND'>{!$Label.MA_AND}</option>
				                                <option value='OR'>{!$Label.MA_OR}</option>
				                            </select>
				                            
				                            <!-- Events -->
				                            <div class='activityfilter-type-wrapper'>
				                            
				                                <!-- Event Options -->
				                                <div class='activityfilter-wrapper' data-type='event'>
				                                    {!$Label.MA_Show} {!query.baseObjectPlural}
				                                    <select class='activityfilter-event combobox'>
				                                        <option value='all'>{!$Label.MA_with_or_without}</option>
				                                        <option value='with'>{!$Label.MA_with}</option>
				                                        <option value='without'>{!$Label.MA_without}</option>
				                                    </select>
				                                   {!$Label.MA_Events}
				                                </div>
				                                
				                                <!-- Event Subfilters -->
				                                <div class='activitysubfilters-wrapper' data-type='event' style='display: none; padding-left: 25px;'>
				                                    <div class='subfilters'></div>
				                                    <div><span class='link blue addfilter'>{!$Label.MA_Add_Filter}</span></div>
				                                </div>
				                                
				                            </div>
				                            
				                        </div>
				                    </div>
				                    
				                    <!-- Filter By Owner -->
				                    <div class='htab-content filterbyowner' data-tab='filterbyowner' style='display: none;'>
				                        <div class='htab-content-header'>{!$Label.MA_Filter_By_Owner}</div>
				                        
				                        <div class='htab-content-body'>
				                            <ul>
				                                <li><input type='radio' name='filterByOwner' value='FALSE' checked="checked" onclick="refreshBadges();"/> {!$Label.MA_All} {!query.baseObjectPlural}</li>
				                                <li><input type='radio' name='filterByOwner' value='TRUE' onclick="refreshBadges();" /> 
				                                	{!$Label.MA_My} {!query.baseObjectPlural} 
				                                	<div class='filterbyowner-ownerfield-wrapper' style='padding-left: 25px; display: none;'>
				                                		<select class='filterbyowner-owner'>
				                                			<option value='UserId'>{!$Label.MA_Current_User_Id}</option>
				                                			<option value='DirectReportIds'>{!$Label.MA_Current_User_Or_Direct_Report}</option>
				                                			<option value='SubordinateIds'>{!$Label.MA_Current_User_Or_Subordinate}</option>
				                                		</select>
				                                		<span style='font-size: 10px; font-style: italic;'> = </span>
				                                		<select class='filterbyowner-ownerfield'><option value="{!$Label.MA_Loading}..."></option></select>
				                                	</div>
				                                </li>
				                                <li class='queue' style='display: none;'>
				                                    <input type='radio' name='filterByOwner' value='QUEUE' /> {!$Label.MA_Queue} 
				                                    <apex:selectList id="queueselect" size="1">
				                                        <apex:selectOptions value="{!query.queueOptions}" />
				                                    </apex:selectList>
				                                </li>
				                            </ul>
				                        </div>
				                    </div>
				                    
				                    <!-- advanced -->
				                    <div class='htab-content advanced' data-tab='advanced' style='display: none;'>
				                    	<div class='htab-content-header'>{!$Label.MA_Order}</div>
				                    	
				                    	<div class='htab-content-body'>
				                    		<div>{!$Label.MA_Order_by}  <select class='orderby-field' data-blankvalue='--None--' disabled='disabled' onchange="refreshBadges();"/> <img class='orderby-dir' title='Sort Order' onclick="$(this).toggleClass('desc');" src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAACoUlEQVRIS7WUWU8TURTH/9OhhBYXKG0pUEBFFltkcQ2GRHwzfgEk4WHQxGjig/hA4vJq4pIoDyQaH5x50Kh8Bh98kCBxoWxtWIqGVmjthiEUpMv1dli6wTAt8WZOZjJzzv937rnnDIP/vJhM9F9aAnzM/1pTYZfcONmAmPhKCFxMWKWEIBciCxATJ8jlEFGvJ84GwWBNFmRXQKL4uNMu6tcbq2RDJAEvaOYMoZlH1RhzzGA+4BEBpYU6HC8/CiiCIMyacF3iTHYEPB/28gzyOCaaj9G5Kfzyr4tvrjKNDg0VNRSwTG1VuNGs3fbgtwX0fXXzLKPiFNiPkZ+TVNydIB0PKSvSo7GyFlEsIUJWhJunitMgaYDeASevVOZzOWwBLD9scPoSxdOb01hkQNPhOoTCAYRCS0J3a2USJAnw8IONz8vTcCqVHsOzVji8Lsl23ww2ag1oPmJCMOjC6rJfuHPRvAXZAtzrH+QPFBq4As0hfLdPwOFZkDtLol+5rgQnqszwe2axGHAIjzraRIgIuNLbzx/UGrm6Yy34Nj2GOc/8hviuXZyURIWuFCer6zFp+wz3vF1409PZxVy628ezLMtFFDkoou3nXfQCRLzEFdWUivc4KgXqc8YhhMCgL4PP50L4bxCRaFhgLnQ/Pp9Wi/D6mzUS/qiuapAs1fKMBaxC0baTk2QNmq/eJxrTGUmAb2IIllcPdtSRBJg7e0hx4zlJgGtkANbXT7ID1HbcJiVNrZKABcsnTL59mh2g5nI3MaTtIPm4F+gOpt49yw5Q3X6LGBpapEs0Oojp973ZA/T1ZyUBv8eH9gbQmk6nzEEyz2P9sjeAZPobHzMtkYrG6ajto5ZLTZE0yAlzSx9jAx+iFqTmo/YnNaHMfjZytpPi8w/kSe9ysmBOYAAAAABJRU5ErkJggg==' /></div>
				                        </div>
				                        
				                    	<div class='htab-content-header'>{!$Label.MA_Limits}</div>
				                    	
				                    	<div class='htab-content-body'>
				                    		<div><input type='checkbox' class='limit-records-enabled' /> {!$Label.MA_Limit_records_returned_to} <input type='text' class='limits-rowcount-value' style='width: 100px;' value='250000' /></div>
				                        </div>
				                        <div class='htab-content-body'>
				                    		<div><input type='checkbox' class='limit-proximity-enabled' /> {!$Label.MA_Limit_Records_Within} <input type='text' class='distance-value' style='width: 100px;'/>
				                    			<select class='distance-type'>
							                        <option value='MILES'>{!$Label.MARoutes_Miles}</option>
							                        <option value='KM'>{!$Label.MARoutes_Kilometers}</option>
							                        <option value='METERS'>{!$Label.MA_Meters}</option>
							                        <option value='YARDS'>{!$Label.MA_Yards}</option>
							                        <option value='FEET'>{!$Label.MA_Feet}</option> 
							                    </select> of <textarea class='address-value' style='vertical-align: middle;'/>
				                    		</div>
				                        </div>
				                    </div>
				                    
			            		</div>
			    			</td>
			    		</tr>
			    	</table>
                </div>
                
                <!-- Tooltips Tab -->
                <div id='tab-tooltips'>
                    <table style="width:100%;" cellpadding="5">
                        <tr>
                            <td style="vertical-align:top;">
                                <table cellpadding="5" cellspacing="0">
                                    <tr>
                                        <td style="white-space: nowrap"><b>{!$Label.MA_Tooltip} 1</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip1' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>{!$Label.MA_Tooltip} 2</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip2' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>{!$Label.MA_Tooltip} 3</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip3' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>{!$Label.MA_Tooltip} 4</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip4' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>{!$Label.MA_Tooltip} 5</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip5' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>{!$Label.MA_Tooltip} 6</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip6' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>{!$Label.MA_Tooltip} 7</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip7' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><b>{!$Label.MA_Tooltip} 8</b></td>
                                        <td>
                                            <select class='tooltip' data-tooltip='tooltip8' data-blankvalue='--None--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td style="vertical-align:top;text-align:right;">
                                <img align="right" src="{!URLFOR($Resource.MapAnything, 'images/ToolTipsHelpImage.png')}"/>
                            </td>
                        
                        </tr>
                    </table>
                </div>
                
                <!-- Markers Tab -->
                <div id='tab-markers'>
                    <table>
                		<tr>
                			<td style='vertical-align:top; display: none;'>
                				<table class='markertabs'>
                					<tr>
                						<td>
                	 						<div class='markercolortab markericon active'/>
                	 						 
                						</td>
                					</tr>
                					
                					<tr>
                						<td>
                	 						<div class='markershapetab markericon'/>
                	 						   
                						</td>
                					</tr>
                					<tr>
                						<td>
                	 						<div class='markersymboltab markericon'/>
                	 						   
                						</td>
                					</tr>
                				</table>
                			</td>
                			
                			<td style='vertical-align:top;'>

                                <!-- Marker Grid -->
                                <h2>Color/Shape Assignments</h2>
                    			<div class='colormarker' style='margin: 10px 0;'>
    			                    <table cellpadding="2" cellspacing="0" class='color-options'>
    			                        <tr>
    			                            <td><b>{!$Label.MA_Assignment_Type}</b></td>
    			                            <td style='vertical-align: top; white-space: nowrap; padding: 0 10px;'>
    			                                <select class='color-assignmenttype'>
    			                                    <option value='Static'>{!$Label.MA_Static}</option>
    			                                    <option value='Dynamic, Field'>{!$Label.MA_DynamicField}</option>
    			                                    <option value='Dynamic-Label'>{!$Label.MA_DynamicLabel}</option>
    			                                    <option value='Dynamic-Order'>{!$Label.MA_DynamicOrder}</option>
    			                                </select>
    			                            </td>
    			                        </tr>
    			                        <tr class='Static toggle'>
    			                            <td style='vertical-align: top;'><b>{!$Label.MA_Icon}</b></td>
    			                            <td style='vertical-align: top; white-space: nowrap; padding: 0 10px;'>
    			                                <div class='markertype-wrapper'>
    			                                    <div class='markertype-color-preview'></div>
    			                                    <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
    			                                    
    			                                    <div class='markertype-selector'>
    			                                        <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
    			                                        <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
    			                                    </div>
    			                                </div>
    			                                <div style='font-size: 8px; margin-top: 10px;'>**{!$Label.MA_Upload_Images} <a href='/{!documentsFolderId}' target='_blank'>MapAnything Documents</a></div>
    			                            </td>
    			                        </tr>
    			                        <tr class='Dynamic toggle' style='display: none;'>
    			                            <td style='vertical-align: top;'><b>{!$Label.MA_Field}</b></td>
    			                            <td style='vertical-align: top; white-space: nowrap; padding: 0 10px;'>
    			                                <select class='color-picklistfield' data-blankvalue='--Select a Field--' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
    			                                <div class='color-picklistvalues' style='max-height: 300px; overflow-y: auto; overflow-x: hidden; padding-right: 20px;'>
    			                                </div>
    			                                <!-----Advanced Reference Options------>
                    			                <div id="advanced-reference-options" style="margin-top:15px; display:none;">
                    			                    <table>
                    			                        <tr>
                    			                            <td>
                    			                                <input type="checkbox" id="advanced-reference-option-automaticassign"/> Automatically assign remaining values a color/shape
                    			                            </td>
                    			                        </tr>
                    			                        <tr>
                    			                            <td>
                    			                                <input type="text" id="advanced-reference-option-otherthreshold" style="width: 30px;"/> % Threshold for grouping small quantities into "Other" bucket
                    			                            </td>
                    			                        </tr>
                    			                    </table>
                    			                </div>
    			                            </td>
    			                        </tr>
    			                        <tr class='Dynamic-Label toggle' style='display: none;'>
    			                            <td style='vertical-align: top;'><b>{!$Label.MATerritoryBuilder_Label}</b></td>
    			                            <td style='font-size: 12px; font-style: italic; color: #888; padding: 0 10px;'>{!$Label.MA_Selected_Value_Tooltip1}
    			                                
    			                                <table>
    			                                    <tr>
    			                                        <td>Text Color</td>
    			                                        <td><input id="marker-label-text-color" class="color" style="background-color: rgb(0, 0, 0); color: rgb(0, 0, 0);" type="text" autocomplete="off" value="#000000" /></td>
    			                                    </tr>
    			                                    <tr>
    			                                        <td>Background Color</td>
    			                                        <td><input id="marker-label-background-color" class="color" style="background-color: rgb(0, 0, 0); color: rgb(0, 0, 0);" type="text" autocomplete="off" value="#cccccc" /></td>
    			                                    </tr>
    			                                </table>
    			                                
    			                            </td>
    			                        </tr>
    			                        <tr class='Dynamic-Order toggle' style='display: none;'>
    			                            <td style='vertical-align: top;'><b>{!$Label.MA_Order}</b></td>
    			                            <td style='font-size: 12px; font-style: italic; color: #888; padding: 0 10px;'>
    			                            	{!$Label.MA_DynamicOrder_Info}
    			                            	<div style='padding-top: 10px; font-style: normal; color: black;'>
    			                            		<input type='checkbox' class='order-drawline' /> {!$Label.MA_DrawLine}
    			                            	</div>
    			                            </td>
    			                        </tr>
    			                    </table>
    			                </div>
    			                
    			                

                                <!-- Default Render Mode -->
                                <div>
                                    <h2>Default Render Mode</h2>
                                    <p style='margin: 2px 0 5px 0; color: #757575; font-size: 11px;'>By default, queries will be rendered in Marker mode on desktop and Scatter mode on Tablet.  You can select a different mode to override those defaults.</p>
                                    <select id='markers-defaultrendermode'>
                                        <option value='Default'>Default</option>
                                        <option value='Markers'>Markers</option>
                                        <option value='Heatmap'>Heatmap</option>
                                        <option value='Cluster'>Clusters</option>
                                        <option value='Scatter'>Scatter</option>
                                    </select>
                                </div>
                                
                                <!-- Default Render Area -->
                                <div style="margin-top:15px;">
                                    <h2>Default Render Area</h2>
                                    <p style='margin: 2px 0 5px 0; color: #757575; font-size: 11px;'>By default, queries will plot all markers on the map. For queries with over 10,000 markers, we suggest setting the default render area to "In Visible Area."</p>
                                    <select id='markers-defaultrenderarea'>
                                        <option value='EntireMap'>Entire Map</option>
                                        <option value='VisibleArea'>In Visible Area</option>
                                    </select>
                                </div>

							</td>
						</tr>
					</table>
                </div>
                
                <!--Derek-->
                <!--- Heatmap Options Tab -->
               <div id='tab-heatmap-options'>
                
                     <table class="heatmap-options-format">
                         <tr>
                             <td>
                                 <div class="heatmap-options-col">
                                     <table style="width:255px;" width="255">
                                         <tr>
                                             <td>Radius:</td>
                                         </tr>
                                         <tr>
                                             <td class="hmo-short-value">
                                                 <input type="text" value="15"  id="heatmap-options-radius" /> <span class="helptext">Default: 15</span>
                
                                             </td>
                                         </tr>
                                         <tr>
                                             <td>&nbsp;</td>
                                         </tr>
                                         <tr>
                                             <td>Opacity:</td>
                                         </tr>
                                         <tr>
                                             <td class="hmo-short-value">
                                                 <select id="heatmap-options-opacity">
                                                     <option value='0.05'>5%</option>
                                                     <option value='0.10'>10%</option>
                                                     <option value='0.15'>15%</option>
                                                     <option value='0.20'>20%</option>
                                                     <option value='0.25'>25%</option>
                                                     <option value='0.30'>30%</option>
                                                     <option value='0.35'>35%</option>
                                                     <option value='0.40'>40%</option>
                                                     <option value='0.45'>45%</option>
                                                     <option value='0.50'>50%</option>
                                                     <option value='0.55'>55%</option>
                                                     <option value='0.60'>60%</option>
                                                     <option value='0.65'>65%</option>
                                                     <option value='0.70'>70%</option>
                                                     <option value='0.75'>75%</option>
                                                     <option selected="selected" value='0.80'>80%</option>
                                                     <option value='0.85'>85%</option>
                                                     <option value='0.90'>90%</option>
                                                     <option value='0.95'>95%</option>
                                                     <option value='1'>100%</option>
                                                 </select>
                                             </td>
                                         </tr>
                                         <tr>
                                             <td>&nbsp;</td>
                                         </tr>
                                         <tr>
                                             <td>Max Intensity:</td>
                                         </tr>
                                         <tr>
                                             <td class="hmo-short-value"><input type="text" id="heatmap-options-max-intensity" value="5" /> <span class="helptext">Default: 5</span>
                                             </td>
                                         </tr>
                                         <tr>
                                             <td>&nbsp;</td>
                                         </tr>
                                         <tr>
                                             <td><input type="checkbox" id="heatmap-options-dissipate-with-zoom" checked="true"/> Dissipate with Zoom (i)</td>
                                         </tr>
                                         <tr>
                                             <td>&nbsp;</td>
                                         </tr>
                                         <tr>
                                             <td>Weighted Value:</td>
                                         </tr>
                                         <tr>
                                             <td>
                                                 <select id="heatmap-options-weighted-value" data-blankvalue='None'>
                                                     <option value="None">--None--</option>
                                                 </select>
                                             </td>
                                         </tr>
                                     </table>
                                 </div>
                             </td>
                             <td>
                                 <div class="heatmap-options-col">
                                     <table style="width:255px;" width="255">
                                         <tr>
                                             <td><label class="label">Color gradient</label></td>
                                        </tr>
                                        <tr>
                                             <td>
                                                <div class="heatmap-arrange-wrapper">
                                                     <div class="heatmap-arrange-wrapper-header">
                                                         <label>Outer Color</label>
                                                     </div>
                                                     <div class="heatmap-arrange-add-cell">
                                                         <a href="javascript:AddColorRow('#FFFFFF', 1)"><img class="heatmap-arrange-add" src="{!URLFOR($Resource.MapAnything, 'images/hmo-add.png')}" width="19" height="19" /> Add a color</a>
                                                     </div><!--heatmap-arrange-add-cell-->
                                                     <div class="heatmap-arrange-cell-rows">
                
                                                         <table id="heatmap-options-color-table">
                                                             <tr>
                                                                 <td><a onclick="MoveHeatMapOptionsColorRowUp(this)" class="hmo-button"><img class="hmo-arrow-up" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-up.png')}" width="20" height="12" /></a><a onclick="MoveHeatMapOptionsColorRowDown(this)" class="hmo-button"><img class="hmo-arrow-down" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-down.png')}" width="20" height="12" /></a>
                                                                 </td>
                                                                 <td><input id="shapelayer-label-font-color" class="color boundary-style" style="background-color: rgb(0, 0, 0); color: rgb(0, 0, 0);" type="text" autocomplete="off" value="#000000" /></td>
                                                                 <td><a class="heatmap-arrange-delete" onclick="RemoveHeatMapOptionsColorRow(this)"><img src="{!URLFOR($Resource.MapAnything, 'images/hmo-delete.png')}" width="19" height="19" /></a></td>
                                                             </tr>
                                                             <tr>
                                                                <td><a onclick="MoveHeatMapOptionsColorRowUp(this)" class="hmo-button"><img class="hmo-arrow-up" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-up.png')}" width="20" height="12" /></a><a onclick="MoveHeatMapOptionsColorRowDown(this)" class="hmo-button"><img class="hmo-arrow-down" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-down.png')}" width="20" height="12" /></a></td>
                                                                <td><input id="shapelayer-label-font-color" class="color boundary-style" style="background-color: rgb(0, 0, 255); color: rgb(0, 0, 255);" type="text" autocomplete="off" value="#0000FF" /></td>
                                                                <td><a class="heatmap-arrange-delete" onclick="RemoveHeatMapOptionsColorRow(this)"><img src="{!URLFOR($Resource.MapAnything, 'images/hmo-delete.png')}" width="19" height="19" /></a></td>
                                                            </tr>
                                                            <tr>
                                                                 <td><a onclick="MoveHeatMapOptionsColorRowUp(this)" class="hmo-button"><img class="hmo-arrow-up" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-up.png')}" width="20" height="12" /></a><a onclick="MoveHeatMapOptionsColorRowDown(this)" class="hmo-button"><img class="hmo-arrow-down" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-down.png')}" width="20" height="12" /></a></td>
                                                                 <td><input id="shapelayer-label-font-color" class="color boundary-style" style="background-color: rgb(0, 255, 255); color: rgb(0, 255, 255);" type="text" autocomplete="off" value="#00FFFF" /></td>
                                                                 <td><a class="heatmap-arrange-delete" onclick="RemoveHeatMapOptionsColorRow(this)"><img src="{!URLFOR($Resource.MapAnything, 'images/hmo-delete.png')}" width="19" height="19" /></a></td>
                                                            </tr>
                                                            <tr>
                                                                 <td><a onclick="MoveHeatMapOptionsColorRowUp(this)" class="hmo-button"><img class="hmo-arrow-up" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-up.png')}" width="20" height="12" /></a><a onclick="MoveHeatMapOptionsColorRowDown(this)" class="hmo-button"><img class="hmo-arrow-down" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-down.png')}" width="20" height="12" /></a></td>
                                                                 <td><input id="shapelayer-label-font-color" class="color boundary-style" style="background-color: rgb(0, 255, 0); color: rgb(0, 255, 0);" type="text" autocomplete="off" value="#00FF00" /></td>
                                                                 <td><a class="heatmap-arrange-delete" onclick="RemoveHeatMapOptionsColorRow(this)"><img src="{!URLFOR($Resource.MapAnything, 'images/hmo-delete.png')}" width="19" height="19" /></a></td>
                                                            </tr>
                                                            <tr>
                                                                 <td><a onclick="MoveHeatMapOptionsColorRowUp(this)" class="hmo-button"><img class="hmo-arrow-up" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-up.png')}" width="20" height="12" /></a><a onclick="MoveHeatMapOptionsColorRowDown(this)" class="hmo-button"><img class="hmo-arrow-down" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-down.png')}" width="20" height="12" /></a></td>
                                                                 <td><input id="shapelayer-label-font-color" class="color boundary-style" style="background-color: rgb(255, 255, 0); color: rgb(255, 255, 0);" type="text" autocomplete="off" value="#FFFF00" /></td>
                                                                 <td><a class="heatmap-arrange-delete" onclick="RemoveHeatMapOptionsColorRow(this)"><img src="{!URLFOR($Resource.MapAnything, 'images/hmo-delete.png')}" width="19" height="19" /></a></td>
                                                            </tr>
                                                            <tr>
                                                                <td><a onclick="MoveHeatMapOptionsColorRowUp(this)" class="hmo-button"><img class="hmo-arrow-up" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-up.png')}" width="20" height="12" /></a><a onclick="MoveHeatMapOptionsColorRowDown(this)" class="hmo-button"><img class="hmo-arrow-down" src="{!URLFOR($Resource.MapAnything, 'images/hmo-arrow-down.png')}" width="20" height="12" /></a></td>
                                                                <td><input id="shapelayer-label-font-color" class="color boundary-style" style="background-color: rgb(255, 0, 0); color: rgb(255, 0, 0);" type="text" autocomplete="off" value="#FF0000" /></td>
                                                                <td><a class="heatmap-arrange-delete" onclick="RemoveHeatMapOptionsColorRow(this)"><img src="{!URLFOR($Resource.MapAnything, 'images/hmo-delete.png')}" width="19" height="19" /></a></td>
                                                            </tr>
                                                        </table>
                
                                                    </div><!--heatmap-arrange-wrapper-cell-rows-->
                                                    <div class="heatmap-arrange-wrapper-footer">
                                                    <label>Inner Color</label>
                                                    </div>
                                                </div><!--heatmap-arrange-wrapper-->
                                            </td>
                                        </tr>
                                    </table>
                
                                </div>
                
                            </td>
                            <td style="vertical-align:top; text-align: right;">
                                <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                <a target="_blank" href="http://wiki.cloudbilt.com/mapanything/using-heatmaps/">Help?</a>
                                <div class="heatmap-options-col">
                                </div>
                      
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Related Lists Tab -->
				<div id='tab-relatedlist'>
				
					<!-- Wrapper -->
					<div id='relatedlist-wrapper'>
						
						<!-- Add New -->
						<div id='relatedlist-addnew-wrapper'>
							<select id='relatedlist-addnew-object' onchange='RelatedList_Add.call(this);' disabled='disabled'><option value='--'>Loading...</option></select>
						</div>
						
						<!-- Related Lists -->
						<div id='relatedlist-list'>
						
							<!-- Watermark -->
							<div id='relatedlist-watermark'>
								<div id='relatedlist-watermark-content'>Select a related object from the list</div>
								<!-- <img id='relatedlist-watermark-arrow' /> -->
							</div>
						
						</div>
						
					</div>
					
				</div>               

	            
	            <!-- Proximity Tab -->
	            <div id='tab-proximity'>
	            	<input type='checkbox' class='proximity-enabled' /> {!$Label.MA_Enable_Proximity}
	            	
	            	<div style='padding: 5px; margin-top: 5px; border-top: 1px solid #EEEEEE;'>
	            		<div><input type='checkbox' class='proximity-hidemarkers' /> {!$Label.MA_Hide_Markers}</div>
                        <div><input type='checkbox' class='proximity-affectvisibility' checked='checked' /> Affect Visibility</div>
	            	</div>
	            	<div style='padding: 5px;'>
	            		<select class='proximity-select'>
	            			<option value='circle'>{!$Label.MA_Circle}</option>
	            			<!-- <option value='isoline'>Isoline</option>  -->
	            		</select>
	            	</div>
	            	
	            	<!-- Options -->
		            <div class='proximity-wrapper' style='padding: 5px;'>
		            
		                <!-- Circle -->
		                <div class='proximity-circle'>
		                
		                    {!$Label.MA_Radius}:
		                    <input type='text' class='proximity-circle-radius' size='5' />
		                    <select class='proximity-circle-unit'>
		                        <option value='MILES'>{!$Label.MARoutes_Miles}</option>
		                        <option value='KM'>{!$Label.MARoutes_Kilometers}</option>
		                        <option value='METERS'>{!$Label.MA_Meters}</option>
		                        <option value='YARDS'>{!$Label.MA_Yards}</option>
		                        <option value='FEET'>{!$Label.MA_Feet}</option>
		                    </select>
		            	</div>
		                
		            </div>
		            
		            <!---------Derek please style the below Fill, border, Opacity....feel free to change everything on the tab as well ------->
		            
		            <table  style='margin: 5px;'>
		                <tr>
		                    <td>Fill:</td>
		                    <td><input id="proximity-fill" class="color" style="background-color: rgb(0, 0, 0); color: rgb(0, 0, 0);" type="text" autocomplete="off" value="#223388" /></td>
		                </tr>
		                <tr>
		                    <td>Border:</td>
		                    <td><input id="proximity-border" class="color" style="background-color: rgb(0, 0, 0); color: rgb(0, 0, 0);" type="text" autocomplete="off" value="#882233" /></td>
		                </tr>
		                <tr>
		                    <td>Opacity:</td>
		                    <td>
                                <select id="proximity-opacity">
                                    <option value='0.00'>0%</option>
                                    <option value='0.05'>5%</option>
                                    <option value='0.10'>10%</option>
                                    <option value='0.15'>15%</option>
                                    <option value='0.20'>20%</option>
                                    <option value='0.25'>25%</option>
                                    <option value='0.30'>30%</option>
                                    <option value='0.35'>35%</option>
                                    <option value='0.40'>40%</option>
                                    <option value='0.45'>45%</option>
                                    <option value='0.50'>50%</option>
                                    <option value='0.55'>55%</option>
                                    <option selected="selected" value='0.60'>60%</option>
                                    <option value='0.65'>65%</option>
                                    <option value='0.70'>70%</option>
                                    <option value='0.75'>75%</option>
                                    <option value='0.80'>80%</option>
                                    <option value='0.85'>85%</option>
                                    <option value='0.90'>90%</option>
                                    <option value='0.95'>95%</option>
                                    <option value='1'>100%</option>
                                </select>
		                    </td>
		                </tr>
		            </table>
		            
		            
		            
		            
		            
		            
		            
		            
		            
		            
		            
	            </div>
	            
	            <!-- Aggregates Tab -->
	            <div id='tab-aggregates'>
	            	
	            </div>
	            
	            <!-- Advanced Tab -->
	            <div id='tab-advanced'>
	            	<h2>{!$Label.MA_Cache_Options}</h2>
	            	<div style='padding: 10px 0;'>
	            		<input type='checkbox' class='advanced-enablecaching' /> {!$Label.MA_Enable_caching_every}
	            		<input type='text' class='advanced-caching-value' style='width: 40px;' /> 
	            		<select class='advanced-caching-unit'>
	            			<option value='hr'>{!$Label.MA_hours}</option>
	            			<option value='day'>{!$Label.MA_days}</option>
	            		</select>
	            		<span class='advanced-caching-lastcachedate' style='font-size: 10px; font-style: italic;'></span>
	            	</div>
	            	
	            	<h2>{!$Label.MA_Refresh_Options}</h2>
	            	<div style='padding: 10px 0;'>
	            		<input type='checkbox' class='advanced-enablerefreshing' /> {!$Label.MA_Enable_refreshing_every}
	            		<input type='text' class='advanced-refreshing-value' style='width: 40px;' /> 
	            		<select class='advanced-refreshing-unit'>
	            			<option value='sec'>{!$Label.MA_seconds}</option>
	            			<option value='min'>{!$Label.MA_minutes}</option>
	            		</select>
	            	</div>
	            	
	            	<h2>{!$Label.MA_Aggregate_Options}</h2>
	            	<div style='padding: 10px 0;'>
	            		<input type='checkbox' class='advanced-enableaggregates' checked='checked'/> {!$Label.MA_Enable_aggregates_using}
	            		<select class='advanced-aggregates-type'>
	            			<option value='sum'>{!$Label.MA_Sum}</option>
	            			<option value='avg'>{!$Label.MA_Avg}</option>
	            		</select>
	            	</div>
	            	
	            	<h2>{!$Label.MA_Tooltip_Options}</h2>
	            	<div style='padding: 10px 0;'>
	            		{!$Label.MA_Default_Tab}
	            		<select id='advanced-tooltip-defaulttab'>
	            			<option value='info'>{!$Label.MA_Info}</option>
	            			<option value='actions'>{!$Label.MA_Actions}</option>
	            			<option value='chatter'>{!$Label.MA_Chatter}</option>
	            			<option value='relatedlist'>{!$Label.MA_Related_Lists}</option>
	            			<option value='weather'>{!$Label.MA_Weather}</option>
	            		</select>
                        </div>		
                    		
                    <h2>{!$Label.MA_Route_Options}</h2>		
	            	<div style='padding: 10px 0;'>	            				
                        <input type="checkbox" class="advanced-route-disablewaypoints"/>		
                        {!$Label.MA_Disable_Routed_Waypoints}		
                        <br />		
                        <div class="advanced-route-options-inputs" style="padding: 10px 0 0 0;">		
                            {!$Label.Ma_Route_Hide_Dates} <input type="text" class="advanced-route-before" style="width:40px; margin-bottom:10px;" /> {!$Label.MA_Route_Days_Before_Today}		
                        	<br />		
	            			{!$Label.Ma_Route_Hide_Dates} <input type="text" class="advanced-route-after" style="width:40px;"/> {!$Label.MA_Route_Days_After_Today}		
                        </div>
	            	</div>
	            </div>
	            
	        </div>
	        
	        
	        <table class="modal-footer">
	            <tr>
	                <td>
	                    <!-- Buttons -->
            	       <div class='buttons'>
            	        	<input type='button' class='savebtn MAbutton button-blue' value="{!$Label.MA_Save}" />
            	        	<input type='button' class='savebtn plotbtn MAbutton button-blue' value="{!$Label.MA_Save_Plot}" />
            	        	<input type='button' class='closebtn MAbutton button-silver' value="{!$Label.MA_Close}" />​
            	        	<span class='msgs' style='color: red; font-size: 10px; display: none;'></span>
            	        </div>
	                </td>
	                <td>
	                    <!-- System Info -->
	                    <div class='systeminfo'></div>
	                </td>
	            </tr>
	        </table>
	       
	        
	        
	        
	        
	    </div>
	    
	    <!-- Templates -->
	    <div id='savedqueryeditor-templates' style='display: none;'>

	    	<!-- ajax load image template -->
        	<img class='loader' src="{!URLFOR($Resource.QueryEditor, 'images/icons/ajax-loader.gif')}" />
        
	        <!-- ajax load template -->
	        <div class="ajaxload template" style="display: none;">
	            <table>
	                <tr>
	                    <td colspan="5"><img src="{!URLFOR($Resource.QueryEditor, 'images/icons/ajax-loader.gif')}" /></td>
	                </tr>
	            </table>
	        </div>
	        
	        <div class="ajaxload template2" style="display: none;">
                    <tr>
                        <td colspan="5"><img src="{!URLFOR($Resource.QueryEditor, 'images/icons/ajax-loader.gif')}" /></td>
                    </tr>
            </div>
	        
	        <!-- filter template -->
	        <div class="filter template" style="display: none;">
	            <table>
	                <tr>            
	                    <!-- Filter Index -->
	                    <td class='indexlabel'></td>
	                
	                    <!-- Field Selector -->
	                    <td class="fieldlabel">
	                    
	                        <!-- Selector for Field filters -->
	                        <div class='fieldoptions'>
	                            <select class="combobox"></select>
	                        </div>
	                        
	                        <div class='parentfieldoptions' style='display: none;'>
	                            <select class="combobox"></select>
	                        </div>
	                        
	                        <div class='grandparentfieldoptions' style='display: none;'>
	                            <select class="combobox"></select>
	                        </div>
	                        
	                    </td>
	                    
	                    <!-- Operator Selector -->
	                    <td class="operator">
	                        <select class="combobox"></select>                              
	                    </td>
	            
	                    <!-- Value Input -->
	                    <td class="value">
	                        <!-- render a text box for STRING filters -->
	                        <div class='STRING' style='display: none;'>
	                            <input type='text'/>
	                            
	                            <div class='range' style='display: none;'>
	                                <span>to</span> 
	                                <input type='text'/>
	                            </div>
	                        </div>
	                        
	                        <!-- render a checkbox list for PICKLIST filters -->
	                        <div class='PICKLIST' style='display: none;'>
	                            <select class='multiselect' multiple='multiple' style='display: none;'></select>
	                        </div>
	                        
	                        <!-- render a radio list for BOOLEAN filters -->
	                        <div class='BOOLEAN' style='display: none;'>
	                            <input type='radio' value="TRUE" /> {!$Label.MA_True}
	                            <input type='radio' value="FALSE" /> {!$Label.MA_False}
	                        </div>
	                        
	                        <!-- render a special text box that uses date.js for date parsing for DATE filters -->
	                        <div class='DATE' style='display: none;'>
	                            <input type='text' class='datejs startdate' data-type="DATE"/>
	                            <img src="{!URLFOR($Resource.QueryEditor, 'images/icons/16_lookup.png')}" class="dateliteralpicker" />
	                            
	                            <div class='range' style='display: none;'>
	                                <span>to</span> 
	                                <input type='text' class='datejs enddate' data-type="DATE"/>
	                                <img src="{!URLFOR($Resource.QueryEditor, 'images/icons/16_lookup.png')}" class="dateliteralpicker" />
	                            </div>
	                            <div class='nextlast' style='display: none;'>
	                            	<select class='n-type'>
	                            		<option value='DAYS'>{!$Label.MA_Days}</option>
	                            		<option value='QUARTERS'>{!$Label.MA_Quarters}</option>
	                            		<option value='YEARS'>{!$Label.MA_Years}</option>
	                            		<option value='FISCAL_QUARTERS'>{!$Label.MA_Fiscal_Quarters}</option>
	                            		<option value='FISCAL_YEARS'>{!$Label.MA_Fiscal_Years}</option>
	                            	</select>
	                            </div>
	                        </div>
	                        
	                        <!-- render a picklist that will contain cached queries that match the object type of the field that was selected -->
	                        <div class='ID' style='display: none;'>
	                        	<input type='text' class='idfiltervalue' />
	                        	
	                        	<span class='queryfiltervalue' style='display: none;'>
	                        		<select class='combobox' />
	                        	</span>
	                        </div>
	                    </td>
	            
	                    <!-- Action Links -->
	                    <td class="actions" style='width: 50px;'>
	                        <div>
	                            <span class='link deletelink'>{!$Label.MA_Delete}</span> 
	                        </div>
	                    </td>
	                </tr>
	            </table>
	        </div>
	        
	        <!-- cross filter template -->
	        <div class='crossfilter template' style='display: none;'>
	            <table class='crossfilter-fields'>
	                <tr>
	                                
	                    <!-- Filter Index -->
	                    <td class='indexlabel'>{!$Label.MA_AND}</td>
	                
	                    <!-- Field Selector -->
	                    <td class="fieldlabel">
	                        <!-- Selector for Cross Filters -->
	                        <table>
	                            <tr>
	                                <td>
	                                    <!-- Display Base Object -->
	                                    <span class='baseobject'></span>
	                                </td>
	                                <td>
	                                    <span class="advanced" style="font-weight: bold; font-size: 18px; display: none;">.</span>
	                                </td>
	                                <td>
	                                    <!-- Base object field selection for advanced queries -->
	                                    <div class="advanced fieldoptions" style='display: none;'>
	                                        <select class='combobox'></select>
	                                    </div>
	                                </td>
	                            </tr>
	                        </table>
	                    </td>
	                    
	                    <!-- Operator Selector -->
	                    <td class="operator">
	                        <select class='combobox'>
	                        	<option value='with'>{!$Label.MA_with}</option>
	                        	<option value='without'>{!$Label.MA_without}</option>
	                        </select>                              
	                    </td>
	            
	                    <!-- Value Input -->
	                    <td class="value">
	            
	                        <!-- render a select list of child objects for CROSS filters -->
	                        <table>
	                            <tr>
	                                <td>
	                                    <div class='crossobjectoptions'>
	                                        <select class='combobox'></select>
	                                    </div>
	                                </td>
	                                <td>
	                                    <span class='advanced' style="font-weight: bold; font-size: 18px; display: none;">.</span>
	                                </td>
	                                <td>
	                                    <!-- select list of field options for the selected child object (this is for advanced queries) -->
	                                    <div class='advanced crossfieldoptions' style='display: none;'>
	                                        <select class='combobox'></select>
	                                    </div>
	                                </td>
	                            </tr>
	                        </table>
	                    </td>
	                 
	                    <!-- Action Links -->
	                    <td class="crossfilteractions" style='width: 50px;'>
	                        <div>
	                            <!-- <span class='link'>Show Advanced</span> |  --><span class='link deletelink'>{!$Label.MA_Delete}</span>
	                        </div>
	                    </td>
	                </tr>
	            </table>
	            
	            <div style='padding-left: 30px;'>
	                <div class='subfilters'></div>
	                <div class='addfilter'><span class='link'>{!$Label.MA_Add_filter}</span></div>
	            </div>
	            <div class='crossfilterlogic'>
					<div style='margin: 10px 30px 0 10px; padding: 5px; border-top: 1px solid silver; border-bottom: 1px solid silver;'>
						<b>{!$Label.MA_Filter_Logic}</b> 
						<input type='text' class='crosslogic' style='display: none;' /> 
						<span class='crossfilterlogiclink small link'>{!$Label.MA_Add}</span>
					</div>
				</div>
	        </div>
	        
	        <!-- Activity Filter Template -->
	        <div class='activityfilter template'>
	        	<table>
	        		<tr>
	        			<td>{!$Label.MA_AND}</td>
	        			<td>
					        <select class='field combobox'>
				           		<option value='CreatedDate' class='DATE'>{!$Label.MA_Created_Date}</option>
				           		<option value='ActivityDate' class='DATE'>{!$Label.MA_Due_Date_Event_Date}</option>
				           		<option value='Subject' class='STRING'>{!$Label.MA_Subject}</option>
				           		<option value='Status' class='STRING'>{!$Label.MA_Status_tasks_only}</option>
				           	</select>
				        </td>
				        <td class='operatorwrapper'>
				           	<select class='operator combobox'></select>
				        </td>
				        <td class='value'>
				        	<div class='STRING' style='display: none;'>
				        		<input type='text' />
				        	</div>
				        	
				        	<div class='DATE' style='display: none;'>
				        		<input type='text' class='datejs startdate' data-type="DATE"/>
	                            <img src="{!URLFOR($Resource.QueryEditor, 'images/icons/16_lookup.png')}" class="dateliteralpicker" />
				        	</div>
				        </td>
				        <td class='activitysubfilteractions' style='min-width: 50px;'>
				        	<div>
				        		<span class='link blue delete'>{!$Label.MA_Delete}</span>
				        	</div>
				        </td>
	           		</tr>
	           	</table>
	        </div>
	        
	        <!-- Query Filter Template -->
	        <div class="queryfilter template" style="display: none;">
	            <table>
	                <tr>            
	                    <!-- Filter Index -->
	                    <td class='indexlabel'></td>
	                
	                    <!-- Field Selector -->
	                    <td class="fieldlabel">
	                    
	                        <!-- Selector for Field filters -->
	                        <div class='fieldoptions'>
	                            <select class="combobox"></select>
	                        </div>
	                        
	                        <div class='parentfieldoptions' style='display: none;'>
	                            <select class="combobox"></select>
	                        </div>
	                        
	                        <div class='grandparentfieldoptions' style='display: none;'>
	                            <select class="combobox"></select>
	                        </div>
	                        
	                    </td>
	                    
	                    <!-- Operator Selector -->
	                    <td class="operator">
	                        <select class="combobox">
	                        	<option value='in'>{!$Label.MA_in}</option>
	                        	<option value='not in'>{!$Label.MA_not_in}</option>
	                        </select>                              
	                    </td>
	            
	                    <!-- Value Input -->
	                    <td class="value">
	                    	<select class='combobox' />
	                    </td>
	            
	                    <!-- Action Links -->
	                    <td class="actions" style='width: 50px;'>
	                        <div>
	                            <span class='link deletelink'>{!$Label.MA_Delete}</span> 
	                        </div>
	                    </td>
	                </tr>
	            </table>
	        </div>
        
            <!-- Column Template -->
            <li class='column template'>
                <span></span>
                <img class='deletebtn' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}" />
            </li>
            
            <!-- Color Picklist Value Template -->
            <table class='markertable picklist template' data-type='picklist'>
				<tr class='header'>
					<th>{!$Label.MA_Value}</th>
					<th>{!$Label.MA_Color} (<span class='link small color-dynamicallyassign'>{!$Label.MA_Dynamically_Assign}</span>)</th>
				</tr>
            </table>
            
            <!--  Related List Row Template -->	
            <div class='relatedlist-row'>
            
            	<!-- Label -->
            	<div class='relatedlist-label' onclick="RelatedList_EditLabel($(this).closest('.relatedlist-row'));"></div>
            	
            	<!-- Columns -->
            	<div class='relatedlist-columns'>
            		<div class='relatedlist-addcolumn' onclick="RelatedList_AddColumn($(this).closest('.relatedlist-row'));">Add Column...</div>
            	</div>
            	
            	<!-- Filters -->
            	<div class='relatedlist-filters'>
            		<div class='relatedlist-numtodisplay-wrapper'>Display <select class='relatedlist-numtodisplay combobox'><option value='1'>1</option><option value='2'>2</option><option value='3'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option></select> records, ordered by <select class='relatedlist-orderby'></select> <select class='relatedlist-orderby-direction combobox'><option value='ASC'>ASC</option><option value='DESC'>DESC</option></select></div>
            		<div class='relatedlist-addfilter' onclick="RelatedList_AddFilter($(this).closest('.relatedlist-row'));">Add Filter...</div>
            	</div>
            	
            	<!-- Drag Handle -->
            	<div class='relatedlist-draghandle'>
            		<div class='arrow-up' onclick="RelatedList_Move($(this).closest('.relatedlist-row'), 'up');"></div>
            		<div style='height: 3px;'></div>
            		<div class='arrow-down' onclick="RelatedList_Move($(this).closest('.relatedlist-row'), 'down');"></div>
            	</div>
            	
            	<!-- Remove Icon -->
            	<div class='relatedlist-remove' onclick="RelatedList_Remove($(this).closest('.relatedlist-row'));"><div></div><div></div></div>
            	
            </div>

            <!-- Marker Grid Quick Fill Templates -->
            <div class='markergrid-quickfill' data-type='NUMBER'>
                {!$Label.MA_From}: <input type='text' class='from numberval' style='width: 120px; padding-right: 10px;' />
                {!$Label.MA_To}: <input type='text' class='to numberval' style='width: 120px; padding-right: 10px;' />
                {!$Label.MA_Divisions}: <input type='text' class='divisions' style='width: 80px'></input>
                <img style='margin-left: 10px; cursor: pointer; vertical-align: middle;' src="{!URLFOR($Resource.MapAnything, 'images/table-add-35.png')}" title="{!$Label.MA_Markers_New_Table}" onclick="$('.color-picklistvalues').data('markerGrid').quickfill({ replace: true });" />
                <img style='margin-left: 5px; cursor: pointer; vertical-align: middle;' src="{!URLFOR($Resource.MapAnything, 'images/table-existing-35.png')}" title="{!$Label.MA_Markers_Existing_Table}" onclick="$('.color-picklistvalues').data('markerGrid').quickfill({ replace: false });" />
                <img class='markergrid-sort' style='margin-left: 5px; cursor: pointer; vertical-align: middle;' src="{!URLFOR($Resource.MapAnything, 'images/table-sort-35.png')}" title="{!$Label.MA_Markers_Sort_Table}" onclick="$('.color-picklistvalues').data('markerGrid').sort({ target: this });" />
            </div>

            <!-- Marker Grid Header and Row Templates -->
            <table>

                <!-- PICKLIST -->
                <tr class='markergrid-header' data-type='PICKLIST'>
                    <th>{!$Label.MA_Value}</th>
                    <th>{!$Label.MA_Color} <div class='markertype-color-preview massaction'></div> (<span style='font-size: 10px; font-weight: normal;'>Dynamically Assign</span> <span class='link small color-dynamicallyassign' data-dimension='color'>Colors</span> | <span class='link small color-dynamicallyassign' data-dimension='shape'>Shapes</span> | <span class='link small color-dynamicallyassign' data-dimension='image'>Images</span> | <span class='link small color-dynamicallyassign' data-dimension='all'>All</span>)</th>
                </tr>
                <tr class='markergrid-row' data-type='PICKLIST'>
                    <td class='comparevalue'></td>
                    <td class='value'>
                        <input type='hidden' class='operator' value='equals'/>
                        <div class='markertype-wrapper'>
                            <div class='markertype-color-preview'></div>
                            <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                            
                            <div class='markertype-selector'>
                                <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
                                <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
                            </div>
                        </div>
                    </td>
                </tr>

                <!-- MULTIPICKLIST -->
                <tr class='markergrid-header' data-type='MULTIPICKLIST'>
                    <th>
                        <div class='add-row-icon'>
                            <img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
                        </div>
                    </th>
                    <th>{!$Label.MA_Criteria}</th>
                    <th>{!$Label.MA_Options}</th>
                    <th>{!$Label.MA_Color} <div class='markertype-color-preview massaction'></div> (<span style='font-size: 10px; font-weight: normal;'>Dynamically Assign</span> <span class='link small color-dynamicallyassign' data-dimension='color'>Colors</span> | <span class='link small color-dynamicallyassign' data-dimension='shape'>Shapes</span> | <span class='link small color-dynamicallyassign' data-dimension='image'>Images</span> | <span class='link small color-dynamicallyassign' data-dimension='all'>All</span>)</th>
                </tr>
                <tr class='markergrid-row' data-type='MULTIPICKLIST'>
                	<td>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</td>
            		<td>
            			<select class='operator'>
            				<option value='includes'>{!$Label.MA_Includes}</option>
            				<option value='excludes'>{!$Label.MA_Excludes}</option>
            			</select>
					</td>
                    <td class='comparevalue'></td>
                    <td class='value'>
                        <input type='hidden' class='operator' value='equals'/>
                        <div class='markertype-wrapper'>
                            <div class='markertype-color-preview'></div>
                            <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                            
                            <div class='markertype-selector'>
                                <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
                                <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
                                <img class='remove-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}" />
                            </div>
                        </div>
                    </td>
                </tr>
                
                <!-- DATE -->
                <tr class='markergrid-header' data-type='DATE'>
            		<th>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</th>
            		<th>{!$Label.MA_Start_Date}</th>
            		<th>{!$Label.MA_End_Date}</th>
            		<th>{!$Label.MA_Color} <div class='markertype-color-preview massaction'></div> (<span style='font-size: 10px; font-weight: normal;'>Dynamically Assign</span> <span class='link small color-dynamicallyassign' data-dimension='color'>Colors</span> | <span class='link small color-dynamicallyassign' data-dimension='shape'>Shapes</span> | <span class='link small color-dynamicallyassign' data-dimension='image'>Images</span> | <span class='link small color-dynamicallyassign' data-dimension='all'>All</span>)</th>
            	</tr>
            	<tr class='markergrid-row' data-type='DATE'>
					<td>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</td>
            		<td style='white-space: nowrap;'>
            			<input type='text' class='comparevalue datepicker datejs novalidation' style='width:150px; margin-right: 3px;'></input>
            			<img src="{!URLFOR($Resource.QueryEditor, 'images/icons/16_lookup.png')}" class="dateliteralpicker" />
            			<input type='hidden' class='operator' value='date'></input>
            		</td>
					<td style='white-space: nowrap;'>
            			<input type='text' class='enddate datepicker datejs novalidation' style='width:150px; margin-right: 3px;'></input>
            			<img src="{!URLFOR($Resource.QueryEditor, 'images/icons/16_lookup.png')}" class="dateliteralpicker" />
            		</td>
            		<td style='white-space: nowrap;'>
                        <div class='markertype-wrapper'>
                            <div class='markertype-color-preview'></div>
                            <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                            
                            <div class='markertype-selector'>
                                <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
                                <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
                            	<img class='remove-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}" />
                            </div>
                        </div>
					</td>
				</tr>
				
				<!-- STRING -->
				<tr class='markergrid-header' data-type='STRING'>
            		<th>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</th>
            		<th>{!$Label.MA_Criteria}</th>
            		<th>{!$Label.MA_String}</th>
            		<th>{!$Label.MA_Color} <div class='markertype-color-preview massaction'></div> (<span style='font-size: 10px; font-weight: normal;'>Dynamically Assign</span> <span class='link small color-dynamicallyassign' data-dimension='color'>Colors</span> | <span class='link small color-dynamicallyassign' data-dimension='shape'>Shapes</span> | <span class='link small color-dynamicallyassign' data-dimension='image'>Images</span> | <span class='link small color-dynamicallyassign' data-dimension='all'>All</span>)</th>
            	</tr>
				<tr class='markergrid-row' data-type='STRING'>
					<td>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</td>
            		<td>
            			<select class='operator'>
            				<option value='contains'>{!$Label.MA_Contains}</option>
            				<option value='equals'>{!$Label.MA_Equals}</option>
            				<option value='starts'>{!$Label.MA_Starts_With}</option>
            			</select>
					</td>
					<td>
            			<input type='text' class='comparevalue'></input>
            		</td>
            		<td style='white-space: nowrap;'>
                        <div class='markertype-wrapper'>
                            <div class='markertype-color-preview'></div>
                            <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                            
                            <div class='markertype-selector'>
                                <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
                                <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
                            	<img class='remove-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}" />
                            </div>
                        </div>
					</td>
				</tr>
				
				<!-- REFERENCE -->
				<tr class='markergrid-header' data-type='REFERENCE'>
					<th>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</th>
					<th>{!$Label.MA_Value}</th>
					<th>{!$Label.MA_Color} <div class='markertype-color-preview massaction'></div> (<span style='font-size: 10px; font-weight: normal;'>Dynamically Assign</span> <span class='link small color-dynamicallyassign' data-dimension='color'>Colors</span> | <span class='link small color-dynamicallyassign' data-dimension='shape'>Shapes</span> | <span class='link small color-dynamicallyassign' data-dimension='image'>Images</span> | <span class='link small color-dynamicallyassign' data-dimension='all'>All</span>)</th>
				</tr>
				<tr class='markergrid-row' data-type='REFERENCE'>
	        		<td>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</td>
                    <td style='white-space: nowrap;'>
                        <input type='text' id='searchText' class='comparedisplay searchText'/>
                        <input type='hidden' id='valueText' class='comparevalue valueText'/>
                        <input type='hidden' class='operator' value='equals'/>
                    </td>
                    <td style='white-space: nowrap;'>
                        <div class='markertype-wrapper'>
                            <div class='markertype-color-preview'></div>
                            <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                            
                            <div class='markertype-selector'>
                                <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
                                <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
                                <img class='remove-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}" />
                            </div>
                        </div>
                    </td>
                </tr>
				
				<!-- NUMBER -->
				<tr class='markergrid-header' data-type='NUMBER'>
            		<th>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</th>
            		<th>{!$Label.MA_From}:</th>
            		<th>{!$Label.MA_To}:</th>
            		<th>{!$Label.MA_Color} <div class='markertype-color-preview massaction'></div> (<span style='font-size: 10px; font-weight: normal;'>Dynamically Assign</span> <span class='link small color-dynamicallyassign' data-dimension='color'>Colors</span> | <span class='link small color-dynamicallyassign' data-dimension='shape'>Shapes</span> | <span class='link small color-dynamicallyassign' data-dimension='image'>Images</span> | <span class='link small color-dynamicallyassign' data-dimension='all'>All</span>)</th>
            	</tr>
            	<tr class='markergrid-row' data-type='NUMBER'>
            		<td>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</td>
            		<td>
	            		<input type='text' class='comparevalue numberval' style='width:150px;'></input>
	            		<input type='hidden' class='operator' value='currency'></input>
            		</td>
            		<td>
            			<input type='text' class='toVal numberval' style='width:150px;'></input>
            		</td>
					<td style='white-space: nowrap;'>
						<div class='markertype-wrapper'>
                            <div class='markertype-color-preview'></div>
                            <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
	                            
							<div class='markertype-selector'>
                                <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
                                <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
                            	<img class='remove-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}" />
							</div>
						</div>
					</td>
				</tr>
				
				<!-- PHONE -->
				<tr class='markergrid-header' data-type='PHONE'>
            		<th>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</th>
            		<th>{!$Label.MA_Criteria}</th>
            		<th>{!$Label.MA_Phone_Fax_Number}</th>
            		<th>{!$Label.MA_Color} <div class='markertype-color-preview massaction'></div> (<span style='font-size: 10px; font-weight: normal;'>Dynamically Assign</span> <span class='link small color-dynamicallyassign' data-dimension='color'>Colors</span> | <span class='link small color-dynamicallyassign' data-dimension='shape'>Shapes</span> | <span class='link small color-dynamicallyassign' data-dimension='image'>Images</span> | <span class='link small color-dynamicallyassign' data-dimension='all'>All</span>)</th>
            	</tr>
				<tr class='markergrid-row' data-type='PHONE'>
					<td>
						<div class='add-row-icon'>
	                    	<img class='add-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-plus-16.png')}" />
	                    </div>
					</td>
            		<td>
            			<select class='operator'>
            				<option value='equals'>{!$Label.MA_Equals}</option>
            				<option value='starts'>{!$Label.MA_Starts_With}</option>
            			</select>
					</td>
					<td>
            			<input type='text' class='comparevalue'></input>
            		</td>
            		<td style='white-space: nowrap;'>
                        <div class='markertype-wrapper'>
                            <div class='markertype-color-preview'></div>
                            <select class='markertype-image' style='display: none;' disabled='disabled'><option value=''>{!$Label.MA_Loading}...</option></select>
                            
                            <div class='markertype-selector'>
                                <img class='markertype-selector-color' src="{!URLFOR($Resource.QueryEditor, 'images/icons/color-16.png')}" />
                                <img class='markertype-selector-image' src="{!URLFOR($Resource.QueryEditor, 'images/icons/iconfolder-16.png')}" />
                            	<img class='remove-row' src="{!URLFOR($Resource.QueryEditor, 'images/icons/badge-circle-cross-16.png')}" />
                            </div>
                        </div>
					</td>
				</tr>

            </table>

            <div class='markerpicker'>

                <h4>Step 1: Select a color</h4>
                <input type='text' class='color markerpicker-color' value='#00FF00' />

                <h4>Step 2: Select a shape</h4>
                <div class='markerpicker-shapes'>
                    <!-- shape options will be inserted here dynamically -->
                </div>

            </div>

	    </div>
	</apex:form>
</apex:page>